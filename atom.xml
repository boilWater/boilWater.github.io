<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>JackJin&#39;s 博客</title>
  <subtitle>一位脚踏实地，拥有梦想的90后，想要一直努力追上你！</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-05-20T13:20:29.079Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>JackJin</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS XNU - 内存管理模型</title>
    <link href="http://yoursite.com/2019/10/09/iOS%20XNU%20-%20%E8%BF%9B%E7%A8%8B%E5%8F%8A%20Mach-O%20%E6%A0%BC%E5%BC%8F/"/>
    <id>http://yoursite.com/2019/10/09/iOS XNU - 进程及 Mach-O 格式/</id>
    <published>2019-10-08T17:09:02.404Z</published>
    <updated>2020-05-20T13:20:29.079Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-XNU-进程及-Mach-O-格式&quot;&gt;&lt;a href=&quot;#iOS-XNU-进程及-Mach-O-格式&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 进程及 Mach-O 格式&quot;&gt;&lt;/a&gt;iOS XNU - 进程及 Mach-O 格式&lt;/h1&gt;&lt;p&gt;本来小编想先把内存这块梳理下，但是联系到内存在 &lt;code&gt;iOS&lt;/code&gt; 平台中也是 &lt;code&gt;app&lt;/code&gt; 编译后的 &lt;code&gt;Mach-O&lt;/code&gt; 可执行文件，所以就先把 &lt;code&gt;OS&lt;/code&gt; 编译启动过程来讲述。&lt;/p&gt;
&lt;h2 id=&quot;进程生命周期&quot;&gt;&lt;a href=&quot;#进程生命周期&quot; class=&quot;headerlink&quot; title=&quot;进程生命周期&quot;&gt;&lt;/a&gt;进程生命周期&lt;/h2&gt;&lt;p&gt;因为小编是一位 &lt;code&gt;iOSer&lt;/code&gt; 这里讲解进程可以大概理解为：&lt;strong&gt;进程 == &lt;code&gt;App&lt;/code&gt;&lt;/strong&gt;，下面给出进程的生命周期。进程的生命周期可以分为：&lt;strong&gt;创建（SIDL）、运行（SRUN）、睡眠（SSLEEP）、停止（SSTOP）、退出ing（SZONE）和终止（Dead）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2QTK31K5V4dNyjvz%2F1877765-12ce1122453ddc54.png?alt=media&amp;amp;token=82c790db-352a-4266-aee2-60679c3d81d7&quot; alt=&quot;process-lifecycle.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;创建（SIDL）&quot;&gt;&lt;a href=&quot;#创建（SIDL）&quot; class=&quot;headerlink&quot; title=&quot;创建（SIDL）&quot;&gt;&lt;/a&gt;创建（SIDL）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SIDL&lt;/code&gt;&lt;/strong&gt; 这个状态是被父进程刚刚 &lt;code&gt;Fork&lt;/code&gt; 创建生成一个唯一的 &lt;code&gt;PID&lt;/code&gt;，处于一个临时空闲状态。此时让然被称为：&lt;strong&gt;“正在初始化”&lt;/strong&gt;，不会响应任何的信号和操作。这个初始化的过程是在单线程中来进行内存布局设置和加载所需要的引来模块。&lt;br&gt;实现处理完成只有进程可以执行，同时不会返回 &lt;strong&gt;&lt;code&gt;SIDL&lt;/code&gt;&lt;/strong&gt; 状态。&lt;strong&gt;相当与用户在手机屏幕点击 &lt;code&gt;ICON&lt;/code&gt; 按钮后执行。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;运行（SRUN）&quot;&gt;&lt;a href=&quot;#运行（SRUN）&quot; class=&quot;headerlink&quot; title=&quot;运行（SRUN）&quot;&gt;&lt;/a&gt;运行（SRUN）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SRUN&lt;/code&gt;&lt;/strong&gt; 如果在进一步来进行细分可以分为两种：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(1)可运行状态：当一个进程被添加到运行队列在等待时期，但是因为 &lt;code&gt;CPU&lt;/code&gt; 忙于运行其他的 &lt;code&gt;App&lt;/code&gt; 此时还没有加载改进程的寄存器时 &lt;strong&gt;既短暂状态&lt;/strong&gt;。&lt;br&gt;(2)运行状态：当 &lt;code&gt;CPU&lt;/code&gt; 从运行队列中开始执行进程的寄存器，改 &lt;code&gt;App&lt;/code&gt; 也就处于运行转台。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在 &lt;code&gt;App&lt;/code&gt;(进程) 在执行过程中时间片用完或者是被更高优先级的进程占用时，此时会由 运行转态加入到可以运行队列中变为可运行状态。&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;在 &lt;code&gt;iOS&lt;/code&gt; 中 &lt;code&gt;App&lt;/code&gt; 启动的标志如下 == &lt;code&gt;SRUN&lt;/code&gt; ：&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//下面执行是在系统加载完 `Mach-O` 和 `dyld` 链接库之后执行 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func application(_ applicatxion: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;, didFinishLaunchingWithOptions launchOptions: [&lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;.LaunchOptionsKey: Any]?) -&amp;gt; Bool &amp;#123; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//每次 `App` 第一次加载或者从后台 --&amp;gt; 前台均会执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidBecomeActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;睡眠（SSLEEP）&quot;&gt;&lt;a href=&quot;#睡眠（SSLEEP）&quot; class=&quot;headerlink&quot; title=&quot;睡眠（SSLEEP）&quot;&gt;&lt;/a&gt;睡眠（SSLEEP）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SSLEEP&lt;/code&gt;&lt;/strong&gt; 在 &lt;code&gt;App&lt;/code&gt; 执行过程中可能出现等待某一个资源或者是进行后台工作，这时进程就不要使用 &lt;code&gt;CPU&lt;/code&gt; 甚至不用进入 &lt;strong&gt;可运行队列&lt;/strong&gt; 而是进行睡眠。当再次获取改资源或者进行前台 &lt;strong&gt;通常会重新加入到可运行队列，并且当在当前运行队列之后。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这里睡眠状态也可以在结束信号时间来处理：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;pid_suspend&lt;/code&gt;&lt;/strong&gt; 和 &lt;strong&gt;&lt;code&gt;pid_resume&lt;/code&gt;&lt;/strong&gt; 可以实现 &lt;code&gt;App&lt;/code&gt; 进行休眠和唤醒之间的切换。这个睡眠我们可以成为&lt;strong&gt;深度睡眠&lt;/strong&gt;，这个操作是在我们说的 &lt;code&gt;Mach&lt;/code&gt; 层面来实现的，可以玩限次来进行切换操作。&lt;br&gt;&lt;strong&gt;在手机中我们采用按 &lt;code&gt;HOME&lt;/code&gt; 键就是基础此来实现，App 睡眠状态。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在应用程序从 &lt;code&gt;SRUN&lt;/code&gt; 状态到我们所说的 &lt;code&gt;SSLEEP&lt;/code&gt; 休眠状态过程中在 &lt;code&gt;iOS&lt;/code&gt; 会执行如下操作：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;可以文件 &lt;code&gt;xxxx.plist&lt;/code&gt; 设置 &lt;code&gt;UIApplicationExitsOnSuspend&lt;/code&gt; || &lt;code&gt;Application does not run in background&lt;/code&gt; 设置对应的属性 &lt;code&gt;true&lt;/code&gt; || &lt;code&gt;false&lt;/code&gt; 来设置进入后台设置，在 &lt;code&gt;App&lt;/code&gt; 中按下 &lt;code&gt;Home&lt;/code&gt; 键 == &lt;code&gt;SSLEEP&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//下面是在运行期间点击 `Home` 键，`App` 进行后台&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillResignActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidEnterBackground(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//此位置如果有需求可以实现延迟进入后台&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//从后台进入运行状态 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillEnterForeground(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidBecomeActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&amp;gt;&lt;/p&gt;
&lt;h3 id=&quot;停止（SSTOP）&quot;&gt;&lt;a href=&quot;#停止（SSTOP）&quot; class=&quot;headerlink&quot; title=&quot;停止（SSTOP）&quot;&gt;&lt;/a&gt;停止（SSTOP）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SSTOP&lt;/code&gt;&lt;/strong&gt; 这个状态是通过一个特殊的信号&lt;strong&gt;&lt;code&gt;TSTOP&lt;/code&gt; || &lt;code&gt;TOSTOP&lt;/code&gt;&lt;/strong&gt;来时正在进行的 &lt;code&gt;App&lt;/code&gt; 停止运行，使程序来处在 &lt;strong&gt;深度睡眠状态&lt;/strong&gt;。可以通过信号 &lt;strong&gt;&lt;code&gt;CONT&lt;/code&gt;&lt;/strong&gt; 来切为可运行状态来重新被调度。 &lt;/p&gt;
&lt;h3 id=&quot;退出ing（SZONE）&quot;&gt;&lt;a href=&quot;#退出ing（SZONE）&quot; class=&quot;headerlink&quot; title=&quot;退出ing（SZONE）&quot;&gt;&lt;/a&gt;退出ing（SZONE）&lt;/h3&gt;&lt;p&gt;在程序执行完之后运行 &lt;code&gt;exit()&lt;/code&gt; 来对程序进行退出。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;iOS&lt;/code&gt; 中程序的关闭 == &lt;code&gt;SZONE&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//程序在关闭时 `iOS` 的函数调用 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillTerminate(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;终止（Dead）&quot;&gt;&lt;a href=&quot;#终止（Dead）&quot; class=&quot;headerlink&quot; title=&quot;终止（Dead）&quot;&gt;&lt;/a&gt;终止（Dead）&lt;/h3&gt;&lt;p&gt;在程序退出之后，也就是会终止该进程所有线程。在此之前会极端的时间出现一个僵尸状态。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;僵尸状态：&lt;/strong&gt; 进程的空壳，占用的资源全部释放，只是对应的 &lt;code&gt;PID&lt;/code&gt; 还在占用。如果父类进行没预释放就交由父类线程，如果释放就交给其祖先进程（&lt;code&gt;PID&lt;/code&gt; = 1） 可以理解为操作系统来进行收养。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;可执行文件&quot;&gt;&lt;a href=&quot;#可执行文件&quot; class=&quot;headerlink&quot; title=&quot;可执行文件&quot;&gt;&lt;/a&gt;可执行文件&lt;/h2&gt;&lt;p&gt;特殊文件在内存中加载执行就是我们所见到的进程，执行过程中文件中会有一个签名来表明当前文件是否有效：“魔数”。&lt;br&gt;下面给出 &lt;code&gt;OS X&lt;/code&gt; 中对应的魔数和可执行文件类型：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;执行格式&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;魔数&lt;/th&gt;
&lt;th&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;通用二进制格式&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0xcafebabess&lt;/code&gt;（小尾顺序）   &lt;code&gt;0xbebafeca&lt;/code&gt;（大尾顺序）&lt;/td&gt;
&lt;td&gt;包含多种架构的二进制格式，目前只在 &lt;code&gt;OS X&lt;/code&gt; 使用。 目前我们见过一些 &lt;code&gt;Framework&lt;/code&gt; 的库可以在 &lt;code&gt;Mac&lt;/code&gt; 的虚拟机上运行及支持 &lt;code&gt;Intel&lt;/code&gt; 的 &lt;code&gt;i386&lt;/code&gt;等，同时也支持移动端的 &lt;code&gt;ARM&lt;/code&gt; 的 32 位和 64 位高通处理器。&lt;strong&gt;包体偏大。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Mach-O&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0xfeedface&lt;/code&gt;（32位） &lt;code&gt;0xfeedfacf&lt;/code&gt;（64位）&lt;/td&gt;
&lt;td&gt;&lt;code&gt;OS X&lt;/code&gt; 原生二进制。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;下面给出在 &lt;code&gt;Fat&lt;/code&gt;（通用二进制格式） VS &lt;code&gt;Mach&lt;/code&gt; 格式头文件：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2luA1DFjTMhevnny%2F1877765-898ef103c8cbaa7d.png?alt=media&amp;amp;token=ed90d759-c48e-4306-9a3c-ced32ff741cb&quot; alt=&quot;fat-mach-header-info.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;胖二进制（Fat）&quot;&gt;&lt;a href=&quot;#胖二进制（Fat）&quot; class=&quot;headerlink&quot; title=&quot;胖二进制（Fat）&quot;&gt;&lt;/a&gt;胖二进制（Fat）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;fat_headers&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;magic&lt;/code&gt;：固定值在上面给出 &lt;code&gt;0xcafebabe&lt;/code&gt;，来表示通用二进制文件；&lt;br&gt;&lt;code&gt;nfa_arch&lt;/code&gt;：当前通用二进制包含的架构数目。 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;fat_arch&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;cputype&lt;/code&gt;：定义的 &lt;code&gt;CPU&lt;/code&gt; 类型；&lt;br&gt;&lt;code&gt;cpusubtype&lt;/code&gt;：定义的机器标识符；&lt;br&gt;&lt;code&gt;offset&lt;/code&gt;：架构的二进制代码在整个通用二进制文件中的偏移量；&lt;br&gt;&lt;code&gt;magic&lt;/code&gt;：内层二进制代码大小；&lt;br&gt;&lt;code&gt;magic&lt;/code&gt;：对其页边界（4k），表示 2 幂函数。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在通用二进制代码加载执行时，&lt;code&gt;Mach&lt;/code&gt; 加载器会根据自己的架构加载适合架构代码。所以不相关的架构代码不用占用相关的内存，但是加载整个 &lt;code&gt;IPA&lt;/code&gt; 包体会比较大。这里可以采用 &lt;code&gt;lipo&lt;/code&gt; 来对二进制文件进行阉割，&lt;a href=&quot;&quot;&gt;&lt;code&gt;lipo&lt;/code&gt;阉割文件&lt;/a&gt;&lt;br&gt;&lt;strong&gt;通用二进制的镜像文件做了优化，对其页边界，内核只需加载第一页就可以读取文件。用这个文件当做目录加载合适的镜像。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;Mach-O-二进制格式&quot;&gt;&lt;a href=&quot;#Mach-O-二进制格式&quot; class=&quot;headerlink&quot; title=&quot;Mach-O 二进制格式&quot;&gt;&lt;/a&gt;&lt;code&gt;Mach-O&lt;/code&gt; 二进制格式&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;mach_header&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;magic&lt;/code&gt;：&lt;code&gt;0xfeedface&lt;/code&gt; 表示 32 位二进制，&lt;code&gt;0xfeedfacf&lt;/code&gt; 表示 64 位二进制文件；&lt;br&gt;&lt;code&gt;cputype&lt;/code&gt; &amp;amp; &lt;code&gt;cpusubtype&lt;/code&gt;：&lt;code&gt;CPU&lt;/code&gt; 类型和子类型；&lt;br&gt;&lt;code&gt;filetype&lt;/code&gt;：文件类型（可执行文件、库文件、核心转储文件、内核拓展等）；&lt;br&gt;&lt;code&gt;ncmds&lt;/code&gt; &amp;amp; &lt;code&gt;sizeofncmds&lt;/code&gt;：用于加载器的 “加载命令” 的条目和大小；&lt;br&gt;&lt;code&gt;flags&lt;/code&gt;：动态连接器的标志（&lt;strong&gt;&lt;code&gt;dyld&lt;/code&gt;&lt;/strong&gt;）；&lt;br&gt;&lt;code&gt;Reserved&lt;/code&gt;： 64 位预留。。。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;我们在目前编译过程总采用 &lt;code&gt;Bitcode&lt;/code&gt; 来进行编码实际就是生成 &lt;code&gt;Mach-O&lt;/code&gt; 文件，然后在由 &lt;code&gt;Apple Server&lt;/code&gt; 根据应用端的处理架构来在实现安装时生成对应架构的 &lt;code&gt;Mach-O&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;Mach-O-加载进程&quot;&gt;&lt;a href=&quot;#Mach-O-加载进程&quot; class=&quot;headerlink&quot; title=&quot;Mach-O 加载进程&quot;&gt;&lt;/a&gt;&lt;code&gt;Mach-O&lt;/code&gt; 加载进程&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2zQdhpr_Gwptcw_Z%2F1877765-b691948709c528af.png?alt=media&amp;amp;token=6b4e79d8-3066-4827-ab1a-37ee0c4a8da3&quot; alt=&quot;mach-o-loader.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;内核加载进程&quot;&gt;&lt;a href=&quot;#内核加载进程&quot; class=&quot;headerlink&quot; title=&quot;内核加载进程&quot;&gt;&lt;/a&gt;内核加载进程&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;(1) 非配虚拟内存 &lt;code&gt;LC_SEGMENT&lt;/code&gt; || &lt;code&gt;LC_SEGMENT_64&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;LC_SEGMENT&lt;/code&gt; || &lt;code&gt;LC_SEGMENT_64&lt;/code&gt; 指导内核如何设置新运行进程的内存空间，&lt;strong&gt;&lt;code&gt;__PAGEZERO&lt;/code&gt;段(空指针陷阱)、&lt;code&gt;__TEXT&lt;/code&gt;段(程序代码)、&lt;code&gt;__DATA&lt;/code&gt;段(程序数据) 和 &lt;code&gt;__LINKEDIT&lt;/code&gt;段(连接器使用的字符和其他段)&lt;/strong&gt; 直接从 &lt;code&gt;Mach-O&lt;/code&gt; 二进制文件加载到内存中。   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;LC_SEGMENT&lt;/code&gt; || &lt;code&gt;LC_SEGMENT_64&lt;/code&gt; 的参数：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;参数&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;用途&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;segment&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;load_segment&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;vmaddr&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;所描述端的虚拟物理地址&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;vmsize&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;为这个段分配的虚拟内存大小&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;fileoff&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;段在该文件的偏移量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;filesize&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;表示段在文本中占用的字节数&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;maxport&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;段的页面所需的最高内存保护，采用 8 进制表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;initport&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;段的页面最初始内存保护&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;nsects&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;段中的区 &lt;code&gt;section&lt;/code&gt; 数量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;flags&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;杂项标志位&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;对于上面每一段，将文件中相应的内容加载到内存中：&lt;br&gt;从偏移量为 &lt;code&gt;fileoff&lt;/code&gt; 处加载 &lt;code&gt;filesize&lt;/code&gt; 字节到虚拟内存地址 &lt;code&gt;vmaddr&lt;/code&gt; 处的 &lt;code&gt;vmsize&lt;/code&gt; 字节。每段的页面都是根据 &lt;code&gt;initport&lt;/code&gt; 进行初始化，&lt;code&gt;initport&lt;/code&gt; 指定如何通过 &lt;strong&gt;读/写&lt;/strong&gt; 执行初始化页面的保护级别。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;段进一步的分解区：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;区&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;用途&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;(2) 创建主线程 &lt;code&gt;LC_MAIN&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;LC_MAIN：&lt;/code&gt;&lt;/strong&gt;主要的作用就是设置程序的入口点地址和栈的大小，在设置的郭晨中除了程序的计数器之外所有寄存器都设置 &lt;strong&gt;0&lt;/strong&gt;。 &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(3) 代码签名 &lt;code&gt;LC_CODE_SIGATURE&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;LC_CODE_SIGATURE：&lt;/code&gt;&lt;/strong&gt; 包含了 &lt;code&gt;Mach-O&lt;/code&gt; 二进制文件的签名，如果签名和代码本身不符合的话，&lt;strong&gt;内核就会立即给程序发送 &lt;code&gt;SIGKILL&lt;/code&gt; 信号将程序杀掉。&lt;/strong&gt;在后面苹果在 &lt;code&gt;iOS&lt;/code&gt; 客户端采用 &lt;code&gt;entitlement&lt;/code&gt; 机制后，代码签名就和沙盒机制绑定在一起，而且 &lt;code&gt;entitlement&lt;/code&gt; 声明必须内嵌在 &lt;code&gt;Mach-O&lt;/code&gt; 中并且通过签名盖章来设置执行安全敏感的操作时具有对应的权限。 &lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(4) 加密 &lt;code&gt;LC_ENCRYPTION_INFO&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;LC_ENCRYPTION_INFO&lt;/code&gt;&lt;/strong&gt;加密二进制文件，在 &lt;code&gt;iOS&lt;/code&gt; 中普遍使用。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(5) &lt;code&gt;Dyld&lt;/code&gt; 加载 &lt;code&gt;LC_LOAD_DYLINKER&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;LC_LOAD_DYLINKER&lt;/code&gt;&lt;/strong&gt; 调用 &lt;code&gt;Dyld&lt;/code&gt;(/user/lib/dyld) 来加载 dyld 如下。&lt;/p&gt;
&lt;h3 id=&quot;Dyld-加载进程&quot;&gt;&lt;a href=&quot;#Dyld-加载进程&quot; class=&quot;headerlink&quot; title=&quot;Dyld 加载进程&quot;&gt;&lt;/a&gt;&lt;code&gt;Dyld&lt;/code&gt; 加载进程&lt;/h3&gt;&lt;p&gt;在内核执行 &lt;code&gt;LC_DYLINKER&lt;/code&gt; 来实现 &lt;code&gt;Dyld&lt;/code&gt; 动态连接器来启动，然后就会把进程的控制权来交给 &lt;code&gt;Dyld&lt;/code&gt;，因为内核会把进程的入口点设置为 &lt;code&gt;Dyld&lt;/code&gt; 的入口点。&lt;br&gt;此时连接器 &lt;code&gt;Dyld&lt;/code&gt; 就会在启动时因为进程采用动态链接在 &lt;code&gt;Mach-O&lt;/code&gt; 镜像文件中 “空洞” 来进行填补。这个过程可以成为：&lt;strong&gt;符号绑定（&lt;code&gt;binding&lt;/code&gt;）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;符号绑定具体实现过程&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;（1）二进制中使用外部定义的函数和符号，这时在文本段中会存在一个 &lt;strong&gt;&lt;code&gt;__stubs&lt;/code&gt;（桩）&lt;/strong&gt;的区，在这个桩区存放本地未定义的占位符。&lt;br&gt;（2）编译器生成相关代码时创建符号桩区调用，链接其在运行时会解决桩区的调用。&lt;br&gt;（3）连接器解决的方式是在被调用的地址处防止一条 &lt;code&gt;JMP&lt;/code&gt; 指令，&lt;code&gt;JMP&lt;/code&gt; 指令会将控制权交给真实的函数体，于此同时不会对栈有任何修改，在调用的过程就像直接调用真实的函数。&lt;br&gt;（4）在实际链接过程中 &lt;code&gt;LC_LOAD_DYLB&lt;/code&gt; 告诉连接器从哪里找到对应的符号，连接器&lt;strong&gt;&lt;code&gt;采用递归的方式&lt;/code&gt;&lt;/strong&gt;加载每一个指定的库，并且搜索对应匹配的字符。链接的库有一个符号表，符号表将这些符号名称和地址关联起来。符号表可以通过 &lt;code&gt;Mach-O&lt;/code&gt; 目标文件地址可以通过 &lt;code&gt;LC_SYMTAB&lt;/code&gt; 加载命令指定的 &lt;code&gt;symoff&lt;/code&gt; 找到&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;dyld&lt;/code&gt; 是一个用户态进程，是由苹果公司来进行维护。从内核的角度来看， &lt;code&gt;dyld&lt;/code&gt; 是一个可插入的组件，也可以替换为第三方连接器。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;Dyld-共享库&quot;&gt;&lt;a href=&quot;#Dyld-共享库&quot; class=&quot;headerlink&quot; title=&quot;Dyld 共享库&quot;&gt;&lt;/a&gt;&lt;code&gt;Dyld&lt;/code&gt; 共享库&lt;/h3&gt;&lt;p&gt;&lt;code&gt;Dyld&lt;/code&gt; 的另一个机制就是共享库缓存，共享库缓存：一些库经过预先链接，然后保存在磁盘的一个文件中。采用共享库缓存的预加载模式，可以节省加载时间。在 &lt;code&gt;iOS 3.0&lt;/code&gt; 后 &lt;code&gt;Apple&lt;/code&gt; 就开始把一些基础库移到次缓存，比如我们在开发中常用到的 &lt;code&gt;UIKit&lt;/code&gt;、&lt;code&gt;Foundation&lt;/code&gt;、&lt;code&gt;Quartz&lt;/code&gt;、&lt;code&gt;AVFoundation&lt;/code&gt;、&lt;code&gt;StoreKit&lt;/code&gt; 等。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;参考资料:&lt;/strong&gt;&lt;br&gt;深入解析 &lt;code&gt;Mac OS X &amp;amp; iOS 操作系统&lt;/code&gt; 第四章&lt;br&gt;&lt;a href=&quot;https://satanwoo.github.io/2017/10/18/abort/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS内存abort(Jetsam) 原理探究&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://wereadteam.github.io/2017/03/13/Signature/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS App 签名的原理&lt;/a&gt;  &lt;/p&gt;
&lt;p&gt;最后一次修改：&lt;/p&gt;
&lt;p&gt;10月9日 02：09：45，广州天河🏠&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-XNU-进程及-Mach-O-格式&quot;&gt;&lt;a href=&quot;#iOS-XNU-进程及-Mach-O-格式&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 进程及 Mach-O 格式&quot;&gt;&lt;/a&gt;iOS XNU - 进程及 Mach-O 
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS XNU 内核" scheme="http://yoursite.com/tags/iOS-XNU-%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>iOS XNU - 内存管理模型</title>
    <link href="http://yoursite.com/2019/10/05/iOS%20XNU%20-%20Mach-O%20%E6%A0%BC%E5%BC%8F/"/>
    <id>http://yoursite.com/2019/10/05/iOS XNU - Mach-O 格式/</id>
    <published>2019-10-05T06:14:46.750Z</published>
    <updated>2020-05-20T13:18:18.663Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-XNU-进程及-Mach-O-格式&quot;&gt;&lt;a href=&quot;#iOS-XNU-进程及-Mach-O-格式&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 进程及 Mach-O 格式&quot;&gt;&lt;/a&gt;iOS XNU - 进程及 Mach-O 格式&lt;/h1&gt;&lt;p&gt;本来小编想先把内存这块梳理下，但是联系到内存在 &lt;code&gt;iOS&lt;/code&gt; 平台中也是 &lt;code&gt;app&lt;/code&gt; 编译后的 &lt;code&gt;Mach-O&lt;/code&gt; 可执行文件，所以就先把 &lt;code&gt;OS&lt;/code&gt; 编译启动过程来讲述。&lt;/p&gt;
&lt;h2 id=&quot;进程生命周期&quot;&gt;&lt;a href=&quot;#进程生命周期&quot; class=&quot;headerlink&quot; title=&quot;进程生命周期&quot;&gt;&lt;/a&gt;进程生命周期&lt;/h2&gt;&lt;p&gt;因为小编是一位 &lt;code&gt;iOSer&lt;/code&gt; 这里讲解进程可以大概理解为：&lt;strong&gt;进程 == &lt;code&gt;App&lt;/code&gt;&lt;/strong&gt;，下面给出进程的生命周期。进程的生命周期可以分为：&lt;strong&gt;创建（SIDL）、运行（SRUN）、睡眠（SSLEEP）、停止（SSTOP）、退出ing（SZONE）和终止（Dead）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2QTK31K5V4dNyjvz%2F1877765-12ce1122453ddc54.png?alt=media&amp;amp;token=82c790db-352a-4266-aee2-60679c3d81d7&quot; alt=&quot;process-lifecycle.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;创建（SIDL）&quot;&gt;&lt;a href=&quot;#创建（SIDL）&quot; class=&quot;headerlink&quot; title=&quot;创建（SIDL）&quot;&gt;&lt;/a&gt;创建（SIDL）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SIDL&lt;/code&gt;&lt;/strong&gt; 这个状态是被父进程刚刚 &lt;code&gt;Fork&lt;/code&gt; 创建生成一个唯一的 &lt;code&gt;PID&lt;/code&gt;，处于一个临时空闲状态。此时让然被称为：&lt;strong&gt;“正在初始化”&lt;/strong&gt;，不会响应任何的信号和操作。这个初始化的过程是在单线程中来进行内存布局设置和加载所需要的引来模块。&lt;br&gt;实现处理完成只有进程可以执行，同时不会返回 &lt;strong&gt;&lt;code&gt;SIDL&lt;/code&gt;&lt;/strong&gt; 状态。&lt;strong&gt;相当与用户在手机屏幕点击 &lt;code&gt;ICON&lt;/code&gt; 按钮后执行。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;运行（SRUN）&quot;&gt;&lt;a href=&quot;#运行（SRUN）&quot; class=&quot;headerlink&quot; title=&quot;运行（SRUN）&quot;&gt;&lt;/a&gt;运行（SRUN）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SRUN&lt;/code&gt;&lt;/strong&gt; 如果在进一步来进行细分可以分为两种：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;(1)可运行状态：当一个进程被添加到运行队列在等待时期，但是因为 &lt;code&gt;CPU&lt;/code&gt; 忙于运行其他的 &lt;code&gt;App&lt;/code&gt; 此时还没有加载改进程的寄存器时 &lt;strong&gt;既短暂状态&lt;/strong&gt;。&lt;br&gt;(2)运行状态：当 &lt;code&gt;CPU&lt;/code&gt; 从运行队列中开始执行进程的寄存器，改 &lt;code&gt;App&lt;/code&gt; 也就处于运行转台。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在 &lt;code&gt;App&lt;/code&gt;(进程) 在执行过程中时间片用完或者是被更高优先级的进程占用时，此时会由 运行转态加入到可以运行队列中变为可运行状态。&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;在 &lt;code&gt;iOS&lt;/code&gt; 中 &lt;code&gt;App&lt;/code&gt; 启动的标志如下 == &lt;code&gt;SRUN&lt;/code&gt; ：&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//下面执行是在系统加载完 `Mach-O` 和 `dyld` 链接库之后执行 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func application(_ applicatxion: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;, didFinishLaunchingWithOptions launchOptions: [&lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;.LaunchOptionsKey: Any]?) -&amp;gt; Bool &amp;#123; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//每次 `App` 第一次加载或者从后台 --&amp;gt; 前台均会执行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidBecomeActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;睡眠（SSLEEP）&quot;&gt;&lt;a href=&quot;#睡眠（SSLEEP）&quot; class=&quot;headerlink&quot; title=&quot;睡眠（SSLEEP）&quot;&gt;&lt;/a&gt;睡眠（SSLEEP）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SSLEEP&lt;/code&gt;&lt;/strong&gt; 在 &lt;code&gt;App&lt;/code&gt; 执行过程中可能出现等待某一个资源或者是进行后台工作，这时进程就不要使用 &lt;code&gt;CPU&lt;/code&gt; 甚至不用进入 &lt;strong&gt;可运行队列&lt;/strong&gt; 而是进行睡眠。当再次获取改资源或者进行前台 &lt;strong&gt;通常会重新加入到可运行队列，并且当在当前运行队列之后。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;这里睡眠状态也可以在结束信号时间来处理：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;pid_suspend&lt;/code&gt;&lt;/strong&gt; 和 &lt;strong&gt;&lt;code&gt;pid_resume&lt;/code&gt;&lt;/strong&gt; 可以实现 &lt;code&gt;App&lt;/code&gt; 进行休眠和唤醒之间的切换。这个睡眠我们可以成为&lt;strong&gt;深度睡眠&lt;/strong&gt;，这个操作是在我们说的 &lt;code&gt;Mach&lt;/code&gt; 层面来实现的，可以玩限次来进行切换操作。&lt;br&gt;&lt;strong&gt;在手机中我们采用按 &lt;code&gt;HOME&lt;/code&gt; 键就是基础此来实现，App 睡眠状态。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;在应用程序从 &lt;code&gt;SRUN&lt;/code&gt; 状态到我们所说的 &lt;code&gt;SSLEEP&lt;/code&gt; 休眠状态过程中在 &lt;code&gt;iOS&lt;/code&gt; 会执行如下操作：&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;可以文件 &lt;code&gt;xxxx.plist&lt;/code&gt; 设置 &lt;code&gt;UIApplicationExitsOnSuspend&lt;/code&gt; || &lt;code&gt;Application does not run in background&lt;/code&gt; 设置对应的属性 &lt;code&gt;true&lt;/code&gt; || &lt;code&gt;false&lt;/code&gt; 来设置进入后台设置，在 &lt;code&gt;App&lt;/code&gt; 中按下 &lt;code&gt;Home&lt;/code&gt; 键 == &lt;code&gt;SSLEEP&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//下面是在运行期间点击 `Home` 键，`App` 进行后台&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillResignActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidEnterBackground(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//此位置如果有需求可以实现延迟进入后台&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;comment&quot;&gt;//从后台进入运行状态 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillEnterForeground(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationDidBecomeActive(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&amp;gt;&lt;/p&gt;
&lt;h3 id=&quot;停止（SSTOP）&quot;&gt;&lt;a href=&quot;#停止（SSTOP）&quot; class=&quot;headerlink&quot; title=&quot;停止（SSTOP）&quot;&gt;&lt;/a&gt;停止（SSTOP）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;SSTOP&lt;/code&gt;&lt;/strong&gt; 这个状态是通过一个特殊的信号&lt;strong&gt;&lt;code&gt;TSTOP&lt;/code&gt; || &lt;code&gt;TOSTOP&lt;/code&gt;&lt;/strong&gt;来时正在进行的 &lt;code&gt;App&lt;/code&gt; 停止运行，使程序来处在 &lt;strong&gt;深度睡眠状态&lt;/strong&gt;。可以通过信号 &lt;strong&gt;&lt;code&gt;CONT&lt;/code&gt;&lt;/strong&gt; 来切为可运行状态来重新被调度。 &lt;/p&gt;
&lt;h3 id=&quot;退出ing（SZONE）&quot;&gt;&lt;a href=&quot;#退出ing（SZONE）&quot; class=&quot;headerlink&quot; title=&quot;退出ing（SZONE）&quot;&gt;&lt;/a&gt;退出ing（SZONE）&lt;/h3&gt;&lt;p&gt;在程序执行完之后运行 &lt;code&gt;exit()&lt;/code&gt; 来对程序进行退出。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;iOS&lt;/code&gt; 中程序的关闭 == &lt;code&gt;SZONE&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//程序在关闭时 `iOS` 的函数调用 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;class AppDelegate: &lt;span class=&quot;built_in&quot;&gt;UIResponder&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;UIApplicationDelegate&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      func applicationWillTerminate(_ application: &lt;span class=&quot;built_in&quot;&gt;UIApplication&lt;/span&gt;) &amp;#123;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;终止（Dead）&quot;&gt;&lt;a href=&quot;#终止（Dead）&quot; class=&quot;headerlink&quot; title=&quot;终止（Dead）&quot;&gt;&lt;/a&gt;终止（Dead）&lt;/h3&gt;&lt;p&gt;在程序退出之后，也就是会终止该进程所有线程。在此之前会极端的时间出现一个僵尸状态。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;僵尸状态：&lt;/strong&gt; 进程的空壳，占用的资源全部释放，只是对应的 &lt;code&gt;PID&lt;/code&gt; 还在占用。如果父类进行没预释放就交由父类线程，如果释放就交给其祖先进程（&lt;code&gt;PID&lt;/code&gt; = 1） 可以理解为操作系统来进行收养。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;可执行文件&quot;&gt;&lt;a href=&quot;#可执行文件&quot; class=&quot;headerlink&quot; title=&quot;可执行文件&quot;&gt;&lt;/a&gt;可执行文件&lt;/h2&gt;&lt;p&gt;特殊文件在内存中加载执行就是我们所见到的进程，执行过程中文件中会有一个签名来表明当前文件是否有效：“魔数”。&lt;br&gt;下面给出 &lt;code&gt;OS X&lt;/code&gt; 中对应的魔数和可执行文件类型：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;执行格式&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;魔数&lt;/th&gt;
&lt;th&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;通用二进制格式&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0xcafebabess&lt;/code&gt;（小尾顺序）   &lt;code&gt;0xbebafeca&lt;/code&gt;（大尾顺序）&lt;/td&gt;
&lt;td&gt;包含多种架构的二进制格式，目前只在 &lt;code&gt;OS X&lt;/code&gt; 使用。 目前我们见过一些 &lt;code&gt;Framework&lt;/code&gt; 的库可以在 &lt;code&gt;Mac&lt;/code&gt; 的虚拟机上运行及支持 &lt;code&gt;Intel&lt;/code&gt; 的 &lt;code&gt;i386&lt;/code&gt;等，同时也支持移动端的 &lt;code&gt;ARM&lt;/code&gt; 的 32 位和 64 位高通处理器。&lt;strong&gt;包体偏大。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Mach-O&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0xfeedface&lt;/code&gt;（32位） &lt;code&gt;0xfeedfacf&lt;/code&gt;（64位）&lt;/td&gt;
&lt;td&gt;&lt;code&gt;OS X&lt;/code&gt; 原生二进制。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;下面给出在 &lt;code&gt;Fat&lt;/code&gt;（通用二进制格式） VS &lt;code&gt;Mach&lt;/code&gt; 格式头文件：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2luA1DFjTMhevnny%2F1877765-898ef103c8cbaa7d.png?alt=media&amp;amp;token=ed90d759-c48e-4306-9a3c-ced32ff741cb&quot; alt=&quot;fat-mach-header-info.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;胖二进制（Fat）&quot;&gt;&lt;a href=&quot;#胖二进制（Fat）&quot; class=&quot;headerlink&quot; title=&quot;胖二进制（Fat）&quot;&gt;&lt;/a&gt;胖二进制（Fat）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;fat_headers&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;magic&lt;/code&gt;：固定值在上面给出 &lt;code&gt;0xcafebabe&lt;/code&gt;，来表示通用二进制文件；&lt;br&gt;&lt;code&gt;nfa_arch&lt;/code&gt;：当前通用二进制包含的架构数目。 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;fat_arch&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;cputype&lt;/code&gt;：定义的 &lt;code&gt;CPU&lt;/code&gt; 类型；&lt;br&gt;&lt;code&gt;cpusubtype&lt;/code&gt;：定义的机器标识符；&lt;br&gt;&lt;code&gt;offset&lt;/code&gt;：架构的二进制代码在整个通用二进制文件中的偏移量；&lt;br&gt;&lt;code&gt;magic&lt;/code&gt;：内层二进制代码大小；&lt;br&gt;&lt;code&gt;magic&lt;/code&gt;：对其页边界（4k），表示 2 幂函数。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在通用二进制代码加载执行时，&lt;code&gt;Mach&lt;/code&gt; 加载器会根据自己的架构加载适合架构代码。所以不相关的架构代码不用占用相关的内存，但是加载整个 &lt;code&gt;IPA&lt;/code&gt; 包体会比较大。这里可以采用 &lt;code&gt;lipo&lt;/code&gt; 来对二进制文件进行阉割，&lt;a href=&quot;&quot;&gt;&lt;code&gt;lipo&lt;/code&gt;阉割文件&lt;/a&gt;&lt;br&gt;&lt;strong&gt;通用二进制的镜像文件做了优化，对其页边界，内核只需加载第一页就可以读取文件。用这个文件当做目录加载合适的镜像。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;Mach-O-二进制格式&quot;&gt;&lt;a href=&quot;#Mach-O-二进制格式&quot; class=&quot;headerlink&quot; title=&quot;Mach-O 二进制格式&quot;&gt;&lt;/a&gt;&lt;code&gt;Mach-O&lt;/code&gt; 二进制格式&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;mach_header&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;magic&lt;/code&gt;：&lt;code&gt;0xfeedface&lt;/code&gt; 表示 32 位二进制，&lt;code&gt;0xfeedfacf&lt;/code&gt; 表示 64 位二进制文件；&lt;br&gt;&lt;code&gt;cputype&lt;/code&gt; &amp;amp; &lt;code&gt;cpusubtype&lt;/code&gt;：&lt;code&gt;CPU&lt;/code&gt; 类型和子类型；&lt;br&gt;&lt;code&gt;filetype&lt;/code&gt;：文件类型（可执行文件、库文件、核心转储文件、内核拓展等）；&lt;br&gt;&lt;code&gt;ncmds&lt;/code&gt; &amp;amp; &lt;code&gt;sizeofncmds&lt;/code&gt;：用于加载器的 “加载命令” 的条目和大小；&lt;br&gt;&lt;code&gt;flags&lt;/code&gt;：动态连接器的标志（&lt;strong&gt;&lt;code&gt;dyld&lt;/code&gt;&lt;/strong&gt;）；&lt;br&gt;&lt;code&gt;Reserved&lt;/code&gt;： 64 位预留。。。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;我们在目前编译过程总采用 &lt;code&gt;Bitcode&lt;/code&gt; 来进行编码实际就是生成 &lt;code&gt;Mach-O&lt;/code&gt; 文件，然后在由 &lt;code&gt;Apple Server&lt;/code&gt; 根据应用端的处理架构来在实现安装时生成对应架构的 &lt;code&gt;Mach-O&lt;/code&gt;。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;Mach-O-加载进程&quot;&gt;&lt;a href=&quot;#Mach-O-加载进程&quot; class=&quot;headerlink&quot; title=&quot;Mach-O 加载进程&quot;&gt;&lt;/a&gt;&lt;code&gt;Mach-O&lt;/code&gt; 加载进程&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1mssvT2pBaW1gbna%2F-M7k2zQdhpr_Gwptcw_Z%2F1877765-b691948709c528af.png?alt=media&amp;amp;token=6b4e79d8-3066-4827-ab1a-37ee0c4a8da3&quot; alt=&quot;mach-o-loader.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;内核加载进程&quot;&gt;&lt;a href=&quot;#内核加载进程&quot; class=&quot;headerlink&quot; title=&quot;内核加载进程&quot;&gt;&lt;/a&gt;内核加载进程&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;（1）非配虚拟内存 &lt;code&gt;LC_SEGMENT&lt;/code&gt; || &lt;code&gt;LC_SEGMENT_64&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(2) 创建主线程 &lt;code&gt;LC_MAIN&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(2) 代码签名 ``&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;Dyld-加载进程&quot;&gt;&lt;a href=&quot;#Dyld-加载进程&quot; class=&quot;headerlink&quot; title=&quot;Dyld 加载进程&quot;&gt;&lt;/a&gt;&lt;code&gt;Dyld&lt;/code&gt; 加载进程&lt;/h3&gt;&lt;p&gt;在内核执行 &lt;code&gt;LC_DYLINKER&lt;/code&gt; 来实现 &lt;code&gt;Dyld&lt;/code&gt; 动态连接器来启动，然后就会把进程的控制权来交给 &lt;code&gt;Dyld&lt;/code&gt;，因为内核会把进程的入口点设置为 &lt;code&gt;Dyld&lt;/code&gt; 的入口点。&lt;br&gt;此时连接器 &lt;code&gt;Dyld&lt;/code&gt; 就会在启动时因为进程采用动态链接在 &lt;code&gt;Mach-O&lt;/code&gt; 镜像文件中 “空洞” 来进行填补。这个过程可以成为：&lt;strong&gt;符号绑定（&lt;code&gt;binding&lt;/code&gt;）&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;符号绑定具体实现过程&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;（1）二进制中使用外部定义的函数和符号，这时在文本段中会存在一个 &lt;strong&gt;&lt;code&gt;__stubs&lt;/code&gt;（桩）&lt;/strong&gt;的区，在这个桩区存放本地未定义的占位符。&lt;br&gt;（2）编译器生成相关代码时创建符号桩区调用，链接其在运行时会解决桩区的调用。&lt;br&gt;（3）连接器解决的方式是在被调用的地址处防止一条 &lt;code&gt;JMP&lt;/code&gt; 指令，&lt;code&gt;JMP&lt;/code&gt; 指令会将控制权交给真实的函数体，于此同时不会对栈有任何修改，在调用的过程就像直接调用真实的函数。&lt;br&gt;（4）在实际链接过程中 &lt;code&gt;LC_LOAD_DYLB&lt;/code&gt; 告诉连接器从哪里找到对应的符号，连接器&lt;strong&gt;&lt;code&gt;采用递归的方式&lt;/code&gt;&lt;/strong&gt;加载每一个指定的库，并且搜索对应匹配的字符。链接的库有一个符号表，符号表将这些符号名称和地址关联起来。符号表可以通过 &lt;code&gt;Mach-O&lt;/code&gt; 目标文件地址可以通过 &lt;code&gt;LC_SYMTAB&lt;/code&gt; 加载命令指定的 &lt;code&gt;symoff&lt;/code&gt; 找到&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;dyld&lt;/code&gt; 是一个用户态进程，是由苹果公司来进行维护。从内核的角度来看， &lt;code&gt;dyld&lt;/code&gt; 是一个可插入的组件，也可以替换为第三方连接器。&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;Dyld-共享库&quot;&gt;&lt;a href=&quot;#Dyld-共享库&quot; class=&quot;headerlink&quot; title=&quot;Dyld 共享库&quot;&gt;&lt;/a&gt;&lt;code&gt;Dyld&lt;/code&gt; 共享库&lt;/h3&gt;&lt;p&gt;&lt;code&gt;Dyld&lt;/code&gt; 的另一个机制就是共享库缓存，共享库缓存：一些库经过预先链接，然后保存在磁盘的一个文件中。采用共享库缓存的预加载模式，可以节省加载时间。在 &lt;code&gt;iOS 3.0&lt;/code&gt; 后 &lt;code&gt;Apple&lt;/code&gt; 就开始把一些基础库移到次缓存，比如我们在开发中常用到的 &lt;code&gt;UIKit&lt;/code&gt;、&lt;code&gt;Foundation&lt;/code&gt;、&lt;code&gt;Quartz&lt;/code&gt;、&lt;code&gt;AVFoundation&lt;/code&gt;、&lt;code&gt;StoreKit&lt;/code&gt; 等。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-XNU-进程及-Mach-O-格式&quot;&gt;&lt;a href=&quot;#iOS-XNU-进程及-Mach-O-格式&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 进程及 Mach-O 格式&quot;&gt;&lt;/a&gt;iOS XNU - 进程及 Mach-O 
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS XNU 内核" scheme="http://yoursite.com/tags/iOS-XNU-%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>iOS XNU - 内存管理模型</title>
    <link href="http://yoursite.com/2019/10/04/iOS%20XNU%20-%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9E%8B/"/>
    <id>http://yoursite.com/2019/10/04/iOS XNU - 内存管理模型/</id>
    <published>2019-10-04T13:01:44.090Z</published>
    <updated>2020-05-20T13:19:40.502Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-XNU-内存管理模型&quot;&gt;&lt;a href=&quot;#iOS-XNU-内存管理模型&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 内存管理模型&quot;&gt;&lt;/a&gt;iOS XNU - 内存管理模型&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k1DyEEUYr7kV6hskf%2F-M7k1_ydxPinnfXXdwkG%2F1877765-8da36eff2f60a243.png?alt=media&amp;amp;token=c4b48b2c-771b-4997-8e05-de0a27fa2a00&quot; alt=&quot;memory.png&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-XNU-内存管理模型&quot;&gt;&lt;a href=&quot;#iOS-XNU-内存管理模型&quot; class=&quot;headerlink&quot; title=&quot;iOS XNU - 内存管理模型&quot;&gt;&lt;/a&gt;iOS XNU - 内存管理模型&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS XNU 内核" scheme="http://yoursite.com/tags/iOS-XNU-%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>iOS XNU - 总纲</title>
    <link href="http://yoursite.com/2019/10/04/iOS%20XNU%20%E5%86%85%E6%A0%B8/"/>
    <id>http://yoursite.com/2019/10/04/iOS XNU 内核/</id>
    <published>2019-10-04T11:47:23.226Z</published>
    <updated>2020-05-20T13:17:19.793Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-内核-XNU-总纲&quot;&gt;&lt;a href=&quot;#iOS-内核-XNU-总纲&quot; class=&quot;headerlink&quot; title=&quot;iOS 内核 XNU -总纲&quot;&gt;&lt;/a&gt;iOS 内核 XNU -总纲&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k0gevo7iEONXQTl6x%2F-M7k3UdMuP01BQXu8CMh%2F-M7k4KoDhvrgVYdwi0Ko%2F1877765-08e5a7043383d728.png?alt=media&amp;amp;token=f2d71aea-77d8-439e-a82c-1a510e91c258&quot; alt=&quot;mach-structature.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面是 &lt;code&gt;XNU&lt;/code&gt; 内核在架构图，由上图我们可以看出 &lt;code&gt;XNU&lt;/code&gt; 包含：&lt;strong&gt;&lt;code&gt;Mach&lt;/code&gt; 微内核、&lt;code&gt;BSD&lt;/code&gt; 层、&lt;code&gt;libKern&lt;/code&gt; 和 &lt;code&gt;I/O Kit&lt;/code&gt;&lt;/strong&gt;。&lt;/p&gt;
&lt;h2 id=&quot;Mach-微内核&quot;&gt;&lt;a href=&quot;#Mach-微内核&quot; class=&quot;headerlink&quot; title=&quot;Mach 微内核&quot;&gt;&lt;/a&gt;&lt;code&gt;Mach&lt;/code&gt; 微内核&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Mach&lt;/code&gt; 微内核研发者是卡内基梅隆大学开发的操作系统，主要是致力于开发一套轻量级且高效平台。这个成果的就是我们讲述的 &lt;code&gt;Mach&lt;/code&gt; 内核。&lt;br&gt;该操作系统包含：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;1、进程和线程的抽象；&lt;br&gt;2、虚拟内存管理；&lt;br&gt;3、任务调度；&lt;br&gt;4、进程间通信和消息传递机制。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;BSD&quot;&gt;&lt;a href=&quot;#BSD&quot; class=&quot;headerlink&quot; title=&quot;BSD&quot;&gt;&lt;/a&gt;&lt;code&gt;BSD&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;&lt;code&gt;BSD&lt;/code&gt; 是建立在 &lt;code&gt;Mach&lt;/code&gt; 基础上，同样也是 &lt;code&gt;XNU&lt;/code&gt; 不可分割的一部分。这一层也是提供了 &lt;code&gt;POSIX&lt;/code&gt; 兼容性，提供的更高层次的抽象。包含：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;1、&lt;code&gt;UNIX&lt;/code&gt;进程模型；&lt;br&gt;2、&lt;code&gt;POSIX&lt;/code&gt; 线程模型及其相关的同步原语；&lt;br&gt;3、&lt;code&gt;UNIX&lt;/code&gt;用户模型和组；&lt;br&gt;4、网络协议栈；&lt;br&gt;5、文件访问系统；&lt;br&gt;6、设备访问。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;libKern&quot;&gt;&lt;a href=&quot;#libKern&quot; class=&quot;headerlink&quot; title=&quot;libKern&quot;&gt;&lt;/a&gt;&lt;code&gt;libKern&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;在内核构建时都会采用 &lt;code&gt;C&lt;/code&gt; 和汇编来实现，而 &lt;code&gt;XNU&lt;/code&gt; 是采用 &lt;code&gt;I/O Kit&lt;/code&gt; 来实现驱动，再次基础上可以瞒住 &lt;code&gt;C++&lt;/code&gt; 来实现编写。于是就在此的基础上包含 &lt;code&gt;libKern&lt;/code&gt; 库。&lt;/p&gt;
&lt;h2 id=&quot;I-O-Kit&quot;&gt;&lt;a href=&quot;#I-O-Kit&quot; class=&quot;headerlink&quot; title=&quot;I/O Kit&quot;&gt;&lt;/a&gt;&lt;code&gt;I/O Kit&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;这是 &lt;code&gt;Apple&lt;/code&gt; 对常见 &lt;code&gt;XNU&lt;/code&gt; 引入 &lt;code&gt;I/O Kit&lt;/code&gt; 设备驱动框架，是一个完整的自包含执行环境，让开发者快速创建设备驱动程序。&lt;br&gt;&lt;code&gt;I/O Kit&lt;/code&gt; 形成了受限环境 &lt;code&gt;C++&lt;/code&gt;，并且带有 &lt;code&gt;C++&lt;/code&gt; 提供的功能：&lt;strong&gt;继承&lt;/strong&gt;和&lt;strong&gt;重载&lt;/strong&gt;。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-内核-XNU-总纲&quot;&gt;&lt;a href=&quot;#iOS-内核-XNU-总纲&quot; class=&quot;headerlink&quot; title=&quot;iOS 内核 XNU -总纲&quot;&gt;&lt;/a&gt;iOS 内核 XNU -总纲&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://gblobs
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS XNU 内核" scheme="http://yoursite.com/tags/iOS-XNU-%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - Core Text</title>
    <link href="http://yoursite.com/2019/07/22/Core%20Text%20%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91/"/>
    <id>http://yoursite.com/2019/07/22/Core Text 富文本编辑/</id>
    <published>2019-07-22T14:51:09.042Z</published>
    <updated>2020-05-20T13:05:56.949Z</updated>
    
    <content type="html">&lt;h1 id=&quot;Core-Text-富文本编辑&quot;&gt;&lt;a href=&quot;#Core-Text-富文本编辑&quot; class=&quot;headerlink&quot; title=&quot;Core Text 富文本编辑&quot;&gt;&lt;/a&gt;Core Text 富文本编辑&lt;/h1&gt;&lt;p&gt;在 &lt;code&gt;Core Graphics&lt;/code&gt; 后面一篇文章本该对 &lt;code&gt;Core Image&lt;/code&gt; 框架进行整理，但是基于 &lt;code&gt;Core Graphics&lt;/code&gt; 的富文本编辑 &lt;code&gt;Core Text&lt;/code&gt; 框架更方便讲述。而且结合自己兴趣和好玩的程度在讲述自己对 &lt;code&gt;Texture&lt;/code&gt; 即 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 详细描述。&lt;/p&gt;
&lt;h2 id=&quot;Core-Text-结构层级&quot;&gt;&lt;a href=&quot;#Core-Text-结构层级&quot; class=&quot;headerlink&quot; title=&quot;Core Text 结构层级&quot;&gt;&lt;/a&gt;Core Text 结构层级&lt;/h2&gt;&lt;p&gt;这里小编对 &lt;code&gt;Core Text&lt;/code&gt; 在实现的层次结构上所处位置，以及在对 &lt;code&gt;UIKit&lt;/code&gt; 框架我们常见控件 &lt;code&gt;UITextFiled&lt;/code&gt;、&lt;code&gt;UITextView&lt;/code&gt; 和 &lt;code&gt;UILabel&lt;/code&gt; 具体实现基础。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kE8qFvBCueh8O8d1_%2F1877765-d9fa387d512dd42d.png?alt=media&amp;amp;token=3d406869-6df1-4a7c-bcb6-6c228a9d1fce&quot; alt=&quot;Core Text.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上图是小编根据 &lt;strong&gt;2018 WWDC&lt;/strong&gt; 中 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TextKit Best Practices&lt;/a&gt; 和 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Introducing Text Kit&lt;/a&gt; 得出 &lt;code&gt;Core Graphics&lt;/code&gt;、&lt;code&gt;Core Text&lt;/code&gt; 和 &lt;code&gt;UIKit&lt;/code&gt; 中能够实现文本绘制的控件实现结构图。&lt;br&gt;根据上面结构可以看出：&lt;br&gt;（1）基于 &lt;code&gt;Quartz&lt;/code&gt; 封装的 &lt;code&gt;Core Graphics&lt;/code&gt; 为 &lt;code&gt;Core Text&lt;/code&gt; 的实现基础。而且 &lt;code&gt;Quartz&lt;/code&gt; 可以直接处理字体和字形将文字渲染到界面，也是在 Apple 基础库中唯一一个处理字体模块。&lt;br&gt;（2）基于 &lt;code&gt;Core Text&lt;/code&gt; 封装实现的 &lt;code&gt;Text Kit&lt;/code&gt; 为在 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 中文本显示控件 &lt;code&gt;TypeTextFiled&lt;/code&gt;、&lt;code&gt;TypeTextView&lt;/code&gt; 等提供最直接的接口。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;Core-Text-API-族&quot;&gt;&lt;a href=&quot;#Core-Text-API-族&quot; class=&quot;headerlink&quot; title=&quot;Core Text API 族&quot;&gt;&lt;/a&gt;Core Text API 族&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEDtfL0uYk56NKxq3%2F1877765-4ace47c5dff6e0f5.png?alt=media&amp;amp;token=c3271fd4-c3ac-48f7-b4b6-f04a2373e841&quot; alt=&quot;Core Text API 族.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Core Text&lt;/code&gt; 作为在 &lt;code&gt;OS&lt;/code&gt; 对应的五大平台唯一拥有实现文字绘制能力的跨平 台框架，族类 &lt;code&gt;API&lt;/code&gt; 都是表示 &lt;code&gt;CTType&lt;/code&gt; 形式。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Opaque-Types&quot;&gt;&lt;a href=&quot;#Opaque-Types&quot; class=&quot;headerlink&quot; title=&quot;Opaque Types&quot;&gt;&lt;/a&gt;Opaque Types&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;集合数据类型&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFont&lt;/code&gt;（字体）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体类型参数。字体特征中基本参数表示：字体大小、字体所属的格式或者是转换矩阵等。&lt;strong&gt;2、&lt;/strong&gt; 是在 &lt;code&gt;UIKit&lt;/code&gt; 中我们经常使用设置子类类型的 &lt;code&gt;UIFont&lt;/code&gt; 的 &lt;code&gt;(__birdge CTFont *)&lt;/code&gt; 表现形式，在采用 &lt;code&gt;context&lt;/code&gt; 绘制上下文中绘制确定字体。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFontCollection&lt;/code&gt;（字体组）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体组合。字体组合也即是对一组文字或者一段短文字字体集合，提供对同一段文字不同格式文字内容字体访问和获取。一句话：&lt;strong&gt;字体整体表示。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFontDescriptor&lt;/code&gt;（字体描述）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体类型描述。字体描述可以用获取、指定或者是修改当前字体属性，字体相关属性（字体名字、位置点大小和变化等）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFrame&lt;/code&gt;（绘制画布）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示多行文字绘制画布。&lt;code&gt;CTFrame&lt;/code&gt;（绘制画布）是 &lt;code&gt;Core Text&lt;/code&gt; 实现文字绘制对外集中体现形式，其中确定绘制参数：画布区域（&lt;code&gt;Range&lt;/code&gt;）、绘制路径（&lt;code&gt;Path&lt;/code&gt;）和绘制文本参数信息（&lt;code&gt;Attribtes&lt;/code&gt;）。&lt;strong&gt;2、&lt;/strong&gt; 对于单行来说可以精确获取在画布：行数和每一行对应开头坐标。在获取绘制的画布时调用对应的 &lt;strong&gt;&lt;code&gt;CTFrameDraw(CTFrame, CGContext)&lt;/code&gt;&lt;/strong&gt; 在上下文中绘制文字显示详细内容。 &lt;strong&gt;3、&lt;/strong&gt; &lt;strong&gt;&lt;code&gt;CTFrame&lt;/code&gt; 不仅支持在 &lt;code&gt;main thread&lt;/code&gt; 中进行绘制，同样也支持在 &lt;code&gt;background Thread&lt;/code&gt; 进行内容的绘制。&lt;/strong&gt; 这也是 &lt;code&gt;YYKit&lt;/code&gt; 和 &lt;code&gt;Texture&lt;/code&gt; 支持后台绘制控件实现的基础。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFramesetter&lt;/code&gt;（画布🏭）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体具体绘制生成工厂。画布工厂根据要显示的富文本信息、显示画布路径和画布具体的区域（&lt;code&gt;Range&lt;/code&gt;）来生成对应展示的显示画布的效果。&lt;strong&gt;2、&lt;/strong&gt; &lt;code&gt;CTFramesetter&lt;/code&gt;（画布工厂）是采用 &lt;code&gt;CFFrameDraw&lt;/code&gt; 来实现富文本编辑绘制基础，但是如果采用 &lt;code&gt;CTLineDraw&lt;/code&gt; 或者是 &lt;code&gt;CTRunDraw&lt;/code&gt; 形似就另当别论了。 &lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt; 中绘制的就是按照 &lt;code&gt;CTLineDraw&lt;/code&gt; 和 &lt;code&gt;CTRunDraw&lt;/code&gt; 来绘制的。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTGlyphInfo&lt;/code&gt;（字体信息）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在字体对于 &lt;code&gt;Glyph ID&lt;/code&gt; 特殊的映射关系。&lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTLine&lt;/code&gt;（画布中行）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在具体执行 &lt;code&gt;Frame&lt;/code&gt;（画布）中一行。是组成画布绘制 &lt;code&gt;Frame&lt;/code&gt; 中单独的一行，同时也是字体不同格式组成在一行中组成最小单元 &lt;strong&gt;&lt;code&gt;Run&lt;/code&gt;&lt;/strong&gt;（块）的集合。 &lt;strong&gt;2、&lt;/strong&gt; 在实现富文本绘制的过程中可以采用 &lt;strong&gt;&lt;code&gt;CTLineDraw(CTLine, CGContext)&lt;/code&gt;&lt;/strong&gt; 方式来绘制当前行。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTParagaraphStyle&lt;/code&gt;（段落格式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 段落格式表示在文本绘制时，段落段落之间设置基本参数或者单独一段信息基本格式。例如：对其样式、截取样式和排布的方向等等&lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTRun&lt;/code&gt;（块）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在富文本绘制过程中格式相同最小单元。根据字体设置的 &lt;code&gt;CTFont&lt;/code&gt;（字体）参数不同在绘制过程中可以分割为格式一致一个一个单元，既是 &lt;code&gt;Run&lt;/code&gt;。 &lt;strong&gt;2、&lt;/strong&gt; 在文本编辑过程中可以根据在画布中需要显示 &lt;code&gt;Lines&lt;/code&gt;，然后在但单独 &lt;code&gt;Line&lt;/code&gt; 中获得 &lt;code&gt;Run&lt;/code&gt; 采用 &lt;strong&gt;&lt;code&gt;CTRunDraw(CTRun, CGContext)&lt;/code&gt;&lt;/strong&gt; 来实现单个 &lt;code&gt;Run&lt;/code&gt;（块）独自绘制。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTRunDelegate&lt;/code&gt;（块协议）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在运行时的一个运行委托，在实现计算是可以调整字形上升、下降和当前绘制字形宽高。这个 &lt;code&gt;API&lt;/code&gt; 是我们在实现文字图片换混排的基础，在生成 &lt;code&gt;Frame&lt;/code&gt; 时计算当前 &lt;code&gt;Line&lt;/code&gt; 里面 &lt;code&gt;Run&lt;/code&gt; 需要绘制素材类型，然后在改素材类型位置设置 &lt;code&gt;Image&lt;/code&gt; 的 &lt;code&gt;Ascent&lt;/code&gt;、&lt;code&gt;Descent&lt;/code&gt;、&lt;code&gt;Width&lt;/code&gt; 和 &lt;code&gt;Height&lt;/code&gt; 来设置当前图片绘制参数信息，然后在实际绘制中在当前需要绘制的 &lt;code&gt;Image&lt;/code&gt; 采用 &lt;strong&gt;&lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImageRef)&lt;/code&gt;&lt;/strong&gt; 绘制当前图片。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTTextTab&lt;/code&gt;（文本标签）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在文本段落中样式标签，用来保存段落之间段落对其方式和位置信息。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTTypesetter&lt;/code&gt;（排版工厂）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体具体绘制来执行布局。可以通过 &lt;strong&gt;&lt;code&gt;CTFramesetterCreateWithTypesetter(CTTypesetter)&lt;/code&gt; 生成上文展示 &lt;code&gt;CTFramesetter&lt;/code&gt;（绘制工厂）。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;集合数据类型&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Sting Attributes&lt;/code&gt;（富文本展示样式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;富文本下划线样式设置&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Structure&lt;/code&gt;（结构）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;CTTextTab&lt;/code&gt;（标签） 范围和表，查找向量 Header。&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Enumerations&lt;/code&gt;（枚举）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 字体描述匹配、指定绑定标识符自动激活、指定 URL 字体注册失败、定义字体注册范文等等。&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Constants&lt;/code&gt;（常量值）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中使用富文本设置一些常量值。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Fundations&lt;/code&gt;（功能）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中一些功能参数值。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Data Types&lt;/code&gt;（数据分类）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中 &lt;code&gt;ATS&lt;/code&gt; 字体参考、字体集合排序描述符回调和 &lt;code&gt;CT&lt;/code&gt; 描述符处理进度回调。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;上面是 &lt;code&gt;Core Text&lt;/code&gt; 所有的 &lt;code&gt;API&lt;/code&gt; 的接口，及其在实现富文本绘制中相对相应的 &lt;code&gt;API&lt;/code&gt; 的主要功能作用。&lt;strong&gt;具体 &lt;code&gt;CTFramesetter&lt;/code&gt; 怎么样通过 &lt;code&gt;NSString&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt; 然后在 &lt;code&gt;UIKit&lt;/code&gt; 基础的显示控件上绘制出来的呢？&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Core-Text-最小系统&quot;&gt;&lt;a href=&quot;#Core-Text-最小系统&quot; class=&quot;headerlink&quot; title=&quot;Core Text 最小系统&quot;&gt;&lt;/a&gt;&lt;code&gt;Core Text&lt;/code&gt; 最小系统&lt;/h2&gt;&lt;p&gt;这里说的最小系统概念是在电子单片机中最小系统单元，这里指的是 &lt;code&gt;Core Text&lt;/code&gt; 实现最基本文字排版。&lt;br&gt;&lt;strong&gt;下面贴出在实现中经典代码：&lt;/strong&gt;   &lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawRect:(&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)rect &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; drawRect:rect];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSetTextMatrix&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformIdentity&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextTranslateCTM&lt;/span&gt;(context, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextScaleCTM&lt;/span&gt;(context, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGMutablePathRef&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;CGPathCreateMutable&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPathAddRect&lt;/span&gt;(path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *attString = [[&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; alloc] initWithString:&lt;span class=&quot;string&quot;&gt;@&quot;Hello world! Welcome to learn RICH TEXT knowladge.&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((&lt;span class=&quot;built_in&quot;&gt;CFAttributedStringRef&lt;/span&gt;)attString);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frame = CTFramesetterCreateFrame(frameSetter, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, attString.length), path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameDraw(frame, context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameSetter);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;继承 &lt;code&gt;UIView&lt;/code&gt; 来自定义 &lt;code&gt;FYView&lt;/code&gt; 然后重写 &lt;code&gt;drawRect:&lt;/code&gt;，在上面 &lt;code&gt;drawRect:&lt;/code&gt; 重新写上面代码。&lt;strong&gt;在 &lt;code&gt;Core Text&lt;/code&gt; 实际绘制中主要分为：计算转换在 &lt;code&gt;UIKit&lt;/code&gt; 的坐标、设置绘制 &lt;code&gt;Path&lt;/code&gt;、初始化 &lt;code&gt;CFFramesetter&lt;/code&gt; 画布工厂生成画布和在上下文中绘制。&lt;/strong&gt;&lt;br&gt;具体分为 6 个步骤：&lt;br&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;获取当前绘制上下文 &lt;code&gt;context&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;把 &lt;code&gt;Core Text&lt;/code&gt; 中左下角的坐标点转换为 &lt;code&gt;UIKit&lt;/code&gt; 左上角的坐标点；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;设置绘制的 &lt;code&gt;path&lt;/code&gt; 路径，把当前 &lt;code&gt;UIView&lt;/code&gt; 的 &lt;code&gt;bounds&lt;/code&gt; 设置为绘制区域；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;通过 &lt;code&gt;String&lt;/code&gt; 初始化 &lt;code&gt;NSAttributedString&lt;/code&gt; 来创建 &lt;strong&gt;&lt;code&gt;CTFramesetterRef&lt;/code&gt;&lt;/strong&gt; 然后根据画布工厂创建 &lt;code&gt;CTFrameRef&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 5：&lt;/strong&gt;在上下文中绘制画布内容；&lt;br&gt;&lt;strong&gt;Step 6：&lt;/strong&gt;释放创建 &lt;code&gt;frame&lt;/code&gt;、&lt;code&gt;path&lt;/code&gt; 和 &lt;code&gt;framesetter&lt;/code&gt; 的 &lt;code&gt;CFTypeRef&lt;/code&gt; 对象。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在当前 &lt;code&gt;Core Text&lt;/code&gt; 绘制的基础之上，我们在看一下具体绘制实现中 &lt;code&gt;CTTypeRef&lt;/code&gt; 中 &lt;strong&gt;&lt;code&gt;Framesetter&lt;/code&gt;、&lt;code&gt;Frame&lt;/code&gt;、 &lt;code&gt;Line&lt;/code&gt; 和 &lt;code&gt;Run&lt;/code&gt; 之间的关系&lt;/strong&gt;，以及在实际绘制显示在界面上对应。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEMTkga5I2kb3adio%2F1877765-80857db5a123d571.png?alt=media&amp;amp;token=07b120dd-3bf1-4a2e-b566-33b6005240a7&quot; alt=&quot;Core Text 最小系统.png&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;小编在实现图文混排实现中，贴出下面一段对于富文本 &lt;code&gt;CFFrameRef&lt;/code&gt; 来计算 &lt;code&gt;Image&lt;/code&gt; 富文本绘制布局代码。&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 frameRef 中 Lines&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *lines = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTFrameGetLines(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; lineCount = lines.count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 frameRef 中 Each Line 开头 Point&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; lineOrigins[lineCount];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CTFrameGetLineOrigins(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), lineOrigins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; imgIndex = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//遍历 Each Line&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; lineCount; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTLineRef lineRef = (__bridge CTLineRef)lines[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//获取 Each Line 的 Run&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *runsArray = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTLineGetGlyphRuns(lineRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//遍历 Each Run&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; runObj &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; runsArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunRef runRef = (__bridge CTRunRef)runObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *runAttribs = (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)CTRunGetAttributes(runRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunDelegateRef delegate = (__bridge CTRunDelegateRef)[runAttribs valueForKey:(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTRunDelegateAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (delegate == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *metaDic = CTRunDelegateGetRefCon(delegate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (![metaDic isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//获取 run 的 width&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.size.width = CTRunGetTypographicBounds(runRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//根据上下偏移获取 run 的 height&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.size.height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; xOffset = CTLineGetOffsetForStringIndex(lineRef, CTRunGetStringRange(runRef).location, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.x = lineOrigins[i].x + xOffset;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.y = lineOrigins[i].y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.y -= descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPathRef&lt;/span&gt; pathRef = CTFrameGetPath(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; colRect = &lt;span class=&quot;built_in&quot;&gt;CGPathGetBoundingBox&lt;/span&gt;(pathRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; delegateRect = &lt;span class=&quot;built_in&quot;&gt;CGRectOffset&lt;/span&gt;(runBounds, colRect.origin.x, colRect.origin.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;从上面两段代码可以看出在 &lt;code&gt;CTTypeRef&lt;/code&gt; 类族中类的关系如下：&lt;br&gt;&lt;strong&gt;（1）&lt;/strong&gt; &lt;code&gt;CTFramesetter&lt;/code&gt; 通过初始化 &lt;code&gt;NSAttributedString&lt;/code&gt; 来创建绘制画布 &lt;code&gt;CTFrameRef&lt;/code&gt; 对应的类；&lt;br&gt;&lt;strong&gt;（2）&lt;/strong&gt; 通过画布 &lt;code&gt;CTFrame&lt;/code&gt; 可以获取所有的 &lt;code&gt;Line&lt;/code&gt; 基本信息，例如：行数、每行 &lt;code&gt;Start Point&lt;/code&gt;等参数。再通过坐标转换就可以计算当前 &lt;code&gt;Line&lt;/code&gt; 在 &lt;code&gt;UIKit&lt;/code&gt; 界面上布局绘制信息，&lt;strong&gt;在实际的绘制时可以选用 &lt;code&gt;CTLineDraw(CTLineRef, CGContext)&lt;/code&gt; 来替代 &lt;code&gt;CTFrameDraw(CTFrameRef, CGContext)&lt;/code&gt; 整个画布在当前上下文中绘制&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;（3）&lt;/strong&gt;效仿从 &lt;code&gt;CTFrameRef&lt;/code&gt; 中获取对应的 &lt;code&gt;Line&lt;/code&gt;，同样可以在 &lt;code&gt;Each Line&lt;/code&gt; 中来获取 &lt;code&gt;Core Text&lt;/code&gt; 最基本的单元 &lt;code&gt;CTRunRef&lt;/code&gt;。通过获取的 &lt;code&gt;Each Line&lt;/code&gt; 中所有的 &lt;code&gt;Run&lt;/code&gt;，然后借助 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 在实际绘制过程中动态设置当前 &lt;code&gt;Run&lt;/code&gt; 块需要绘制 &lt;code&gt;Rect&lt;/code&gt; 区域。&lt;strong&gt;同样在实际绘制时也可以采用 &lt;code&gt;CTRunDraw(CTRunRef, CGContext)&lt;/code&gt; 来代替 &lt;code&gt;CTLineDraw(CTLineRef, CGContext)&lt;/code&gt; 来单独绘制每个字形块。&lt;/strong&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;在图文混排过程中分为两种情况，根据情况的不同也可以采用不同的方式实现排版引擎实现：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;（a）对于排版的数据来源于 &lt;code&gt;Server&lt;/code&gt; 也就是我们需要需要访问后才会获取数据，然后来初始化控件，鉴于 &lt;code&gt;Network&lt;/code&gt; 的延迟性，我们可以预先设置通过设置 &lt;code&gt;CTRunDelegate&lt;/code&gt; 拓展在展示时的 &lt;code&gt;Image&lt;/code&gt; 的参数信息；&lt;br&gt;（b）对要排版的数据信息已知，在实现的基础上对 &lt;code&gt;Image&lt;/code&gt; 位置插入临时代替的字符串，通过 &lt;code&gt;CTDelegateRef&lt;/code&gt; 来获取对应 &lt;code&gt;Image&lt;/code&gt; 基本参数设置当前 &lt;code&gt;Run&lt;/code&gt; 块的绘制时上下缩进，然后添加到富文本字符串中此时也可以记录当前插入字符串所在的位置。&lt;/strong&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Core-Text-图文混排实现&quot;&gt;&lt;a href=&quot;#Core-Text-图文混排实现&quot; class=&quot;headerlink&quot; title=&quot;Core Text 图文混排实现&quot;&gt;&lt;/a&gt;Core Text 图文混排实现&lt;/h2&gt;&lt;p&gt;目前以 &lt;code&gt;Core Text&lt;/code&gt; 为基础实现图文混排实现控件 &lt;code&gt;YYKit&lt;/code&gt; 系列组件中 &lt;code&gt;YYText&lt;/code&gt; 实现逻辑最为清晰，瞒住的情况也最为全面。下面根据要实现图文混排的数据来源做区分来分别讲解排版引擎实现逻辑。&lt;/p&gt;
&lt;h3 id=&quot;来自-Server&quot;&gt;&lt;a href=&quot;#来自-Server&quot; class=&quot;headerlink&quot; title=&quot;来自 Server&quot;&gt;&lt;/a&gt;来自 &lt;code&gt;Server&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;当需要排版的数据来自与 &lt;code&gt;Server&lt;/code&gt;，客户端和后台来商量在模板传输数据格式。这里在本地模拟网络数据加载的数据格式采用 &lt;strong&gt;&lt;code&gt;JSON&lt;/code&gt;&lt;/strong&gt; 来实现，不过小编建议如果后台允许的情况下可以尝试 &lt;strong&gt;&lt;code&gt;Protobuf&lt;/code&gt;&lt;/strong&gt; 数据格式（后面小编会在网络协议中对该格式的数据进行详细的讲解）。&lt;/p&gt;
&lt;p&gt;这里对 &lt;code&gt;Core Text&lt;/code&gt; 绘制实现步骤进行划分，然后对每一个步骤的工作进行提取来实现不同的功能。下面区分&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;(1)&lt;/strong&gt;&lt;code&gt;FYEvolveDisplay&lt;/code&gt;：显示类，用于在富文本实际绘制，排版的图片的图片实现填充和图片及链接文本点击操作监听；&lt;br&gt;&lt;strong&gt;(2)&lt;/strong&gt;&lt;code&gt;FYFrameParser&lt;/code&gt;：排版类，对需要排版的内容加载解析，然后生成排版；&lt;br&gt;&lt;strong&gt;(3)&lt;/strong&gt;&lt;code&gt;FYFrameParseConfig&lt;/code&gt;：配置类，在排版绘制中文字基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(4)&lt;/strong&gt;&lt;code&gt;FYCoreTextData&lt;/code&gt;：模型类，作为实际绘制中数据显示承载体；&lt;br&gt;&lt;strong&gt;(5)&lt;/strong&gt;&lt;code&gt;FYCoreTextImageData&lt;/code&gt;：图片配置类，在排版绘制中图片基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(6)&lt;/strong&gt;&lt;code&gt;FYCoreTextLinkData&lt;/code&gt;：链接文本配置类，在排版绘制中链接文字基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(7)&lt;/strong&gt;&lt;code&gt;FYCoreTextLinkUtilts&lt;/code&gt;：链接文本工具类，在 &lt;code&gt;FYEvolveDisplay&lt;/code&gt; 点击中查找判断当前点击在在具体哪个链接文字。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;下面按照（1）数据加载解析生成显示承载 –&amp;gt; （2）然后在绘制  –&amp;gt; （3）最后在点击相应步骤来贴出相关代码段&lt;/strong&gt;&lt;/p&gt;
&lt;h4 id=&quot;数据解析&quot;&gt;&lt;a href=&quot;#数据解析&quot; class=&quot;headerlink&quot; title=&quot;数据解析&quot;&gt;&lt;/a&gt;数据解析&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYFrameParser&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextData *)parseLocalImageTemplateFile:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)path config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *imageArray = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; array];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *linkArray = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; array];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//解析数据模板&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *imageTemplateAttrib  = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; loadLocalTemplateFile:path config:config imageArray:imageArray linkArray:linkArray];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//根据配置信息生成显示载体&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextData *coreTextData = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributeContent:imageTemplateAttrib config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.imageArray = imageArray;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.linkArray = linkArray;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; coreTextData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)loadLocalTemplateFile:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       config:(FYFrameParserConfig *)config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                   imageArray:(&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *)imageArray&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                    linkArray:(&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *)linkArray &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSData&lt;/span&gt; *data = [&lt;span class=&quot;built_in&quot;&gt;NSData&lt;/span&gt; dataWithContentsOfFile:path];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; *mutableAttrib = [[&lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (data) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *templateArray = [&lt;span class=&quot;built_in&quot;&gt;NSJSONSerialization&lt;/span&gt; JSONObjectWithData:data options:&lt;span class=&quot;built_in&quot;&gt;NSJSONReadingAllowFragments&lt;/span&gt; error:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([templateArray isKindOfClass: [&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *dic &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; templateArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *typeDic = dic[&lt;span class=&quot;string&quot;&gt;@&quot;type&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([typeDic isEqualToString: &lt;span class=&quot;string&quot;&gt;@&quot;txt&quot;&lt;/span&gt;]) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser text data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *textAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributedContentFormDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:textAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([typeDic isEqualToString: &lt;span class=&quot;string&quot;&gt;@&quot;img&quot;&lt;/span&gt;]) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser image data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *imageAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseImageDataFromDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:imageAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    FYCoreTextImageData *imageData = [[FYCoreTextImageData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.name = dic[&lt;span class=&quot;string&quot;&gt;@&quot;name&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.url = dic[&lt;span class=&quot;string&quot;&gt;@&quot;url&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.position = mutableAttrib.length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [imageArray addObject:imageData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;([typeDic isEqualToString:&lt;span class=&quot;string&quot;&gt;@&quot;link&quot;&lt;/span&gt;])&amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser link text data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; startLoc = mutableAttrib.length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *linkAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributedContentFormDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:linkAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    FYCoreTextLinkData *linkData = [[FYCoreTextLinkData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; len = mutableAttrib.length - startLoc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(startLoc, len);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.range = range;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.title = dic[&lt;span class=&quot;string&quot;&gt;@&quot;content&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.url = dic[&lt;span class=&quot;string&quot;&gt;@&quot;url&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [linkArray addObject:linkData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mutableAttrib;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)parseAttributedContentFormDictionary:(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)dict config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableDictionary&lt;/span&gt; *attribDic = [[&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attributesWithConfig:config] mutableCopy];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Color&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; *color = [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; colorFromHexString:dict[&lt;span class=&quot;string&quot;&gt;@&quot;color&quot;&lt;/span&gt;]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (color) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        attribDic[(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTForegroundColorAttributeName] = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)color.CGColor;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Size&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; fontSize = [dict[&lt;span class=&quot;string&quot;&gt;@&quot;size&quot;&lt;/span&gt;] floatValue];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (fontSize &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTFontRef fontRef = CTFontCreateWithName((&lt;span class=&quot;built_in&quot;&gt;CFStringRef&lt;/span&gt;)&lt;span class=&quot;string&quot;&gt;@&quot;ArialMT&quot;&lt;/span&gt;, fontSize, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        attribDic[(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTFontAttributeName] = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)fontRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(fontRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *content = dict[&lt;span class=&quot;string&quot;&gt;@&quot;content&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [[&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; alloc] initWithString:content attributes:attribDic];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)parseImageDataFromDictionary:(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)dict&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTRunDelegateCallbacks callbacks;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    memset(&amp;amp;callbacks, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(CTRunDelegateCallbacks));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.version = kCTRunDelegateVersion1;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getAscent = ascentCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getDescent = descentCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getWidth = widthCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTRunDelegateRef delegateRef = CTRunDelegateCreate(&amp;amp;callbacks, (__bridge &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)(dict));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unichar&lt;/span&gt; objectReplaceChar = &lt;span class=&quot;number&quot;&gt;0xFFCC&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *conetnt = [&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; stringWithCharacters:&amp;amp;objectReplaceChar length:&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attributesWithConfig:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; *space = [[&lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; alloc] initWithString:conetnt attributes:attrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFAttributedStringSetAttribute&lt;/span&gt;((&lt;span class=&quot;built_in&quot;&gt;CFMutableAttributedStringRef&lt;/span&gt;)space, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), kCTRunDelegateAttributeName, delegateRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(delegateRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; space;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextData *)parseAttributeContent:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)attribContent config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((&lt;span class=&quot;built_in&quot;&gt;CFAttributedStringRef&lt;/span&gt;) attribContent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//绘制高度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; restrictSize = &lt;span class=&quot;built_in&quot;&gt;CGSizeMake&lt;/span&gt;(config.width, &lt;span class=&quot;built_in&quot;&gt;CGFLOAT_MAX&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(frameSetter, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, restrictSize, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; textHeight = coreTextSize.height;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//生成 CTFrameRef&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; createFrameRefWithFrameSetter:frameSetter config:config height:textHeight];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextData *coreTextData = [[FYCoreTextData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.ctFrame = frameRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.height = textHeight;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameSetter);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; coreTextData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (CTFrameRef)createFrameRefWithFrameSetter:(CTFramesetterRef)frameSetterref&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     config:(FYFrameParserConfig *)config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     height:(&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt;)height &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGMutablePathRef&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;CGPathCreateMutable&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPathAddRect&lt;/span&gt;(path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, config.width, height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = CTFramesetterCreateFrame(frameSetterref, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; frameRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;上面是模拟网络请求数据模板加载本地模板生成显示载体（即画布）过程。&lt;br&gt;&lt;strong&gt;Step 1：&lt;/strong&gt; 由 &lt;code&gt;Step 2&lt;/code&gt; 加载本地模拟数据，然后由 &lt;code&gt;Step 5&lt;/code&gt; 来计算绘制画布的区域和路径生成对应画布交给模型类在自定义的 &lt;code&gt;UIKit&lt;/code&gt; 控件 &lt;code&gt;drawRect:&lt;/code&gt; 完成绘制；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt; 获取本地的数据然后解码，遍历其中数据内容解析对应 &lt;code&gt;Text&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;LinkText&lt;/code&gt; 数据。&lt;strong&gt;如果是 &lt;code&gt;Text&lt;/code&gt; 类型由 &lt;code&gt;Step 3&lt;/code&gt; 来根据内容配置来生成对应的 &lt;code&gt;NSAttributedString&lt;/code&gt; 数据，如果是 &lt;code&gt;Image&lt;/code&gt; 类型就交由 &lt;code&gt;Step 4&lt;/code&gt; 临时填充单个字符串并且通过 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 来在运行时设置当前上下缩进，如果是 &lt;code&gt;LinkText&lt;/code&gt; 类型的数据还是由 &lt;code&gt;Step 3&lt;/code&gt; 来完成处理，但是记录当前 &lt;code&gt;NSAttributedString&lt;/code&gt; 的 &lt;code&gt;Start Index&lt;/code&gt; 和 &lt;code&gt;End Index&lt;/code&gt; 位置&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;此步骤是解析 &lt;code&gt;Text&lt;/code&gt; 类型的数据，根据设置的 &lt;code&gt;FYFrameConfig&lt;/code&gt; 配置的基础信息对数据进行解析生成对应 &lt;code&gt;NSAttributedString&lt;/code&gt; 类型的数据；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;此步骤是对 &lt;code&gt;Image&lt;/code&gt; 类型的数据类型对应的 &lt;code&gt;CTRunRef&lt;/code&gt; 进行临时赋值一个字符，然后通过 &lt;code&gt;CTRunDelegateCallbacks&lt;/code&gt; 来设置 &lt;code&gt;Run&lt;/code&gt;（块）在实际绘制时 &lt;code&gt;Ascent&lt;/code&gt;（排版上升） 和 &lt;code&gt;Descent&lt;/code&gt;（排版下降）间距以此来作为图片绘制时的高度。&lt;strong&gt;然后在实际绘制过程中遍历当前 &lt;code&gt;Run&lt;/code&gt;(块) 计算当前 &lt;code&gt;Image&lt;/code&gt; 绘制的区域，获取图片后采用 &lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImage)&lt;/code&gt; 绘制当前图片&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;Step 5：&lt;/strong&gt;通过 &lt;code&gt;NSAttributedString&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt; 画布工厂，计算当前需要绘制内容高度由 &lt;code&gt;Step 6&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt;（画布）然后赋值给 &lt;code&gt;FYCoreTextData&lt;/code&gt; 模型类画布；&lt;br&gt;&lt;strong&gt;Step 6：&lt;/strong&gt; 利用最小单元中通过设置路径使用 &lt;code&gt;CFFramesetterRef&lt;/code&gt;（绘制🏭）来生成对应需要排版的 &lt;code&gt;CTFrameRef&lt;/code&gt;（画布）。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实际绘制&quot;&gt;&lt;a href=&quot;#实际绘制&quot; class=&quot;headerlink&quot; title=&quot;实际绘制&quot;&gt;&lt;/a&gt;实际绘制&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYEvolveDisplayView&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawRect:(&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)rect &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; drawRect:rect];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; contextRef = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSetTextMatrix&lt;/span&gt;(contextRef, &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformIdentity&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextTranslateCTM&lt;/span&gt;(contextRef, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextScaleCTM&lt;/span&gt;(contextRef, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTFrameDraw(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.ctFrame, contextRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextImageData *imageData &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.imageArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = [&lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; imageNamed:imageData.name];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (image) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//CGRect rect = imageData.imageRect;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//NSLog(@&quot;image data rect in display view: x:%f y:%f height:%f width:%f&quot;, rect.origin.x, rect.origin.y, rect.size.height, rect.size.width);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextDrawImage&lt;/span&gt;(contextRef, imageData.imageRect, image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYCoreTextData&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)fillReplaceCharWithImagePosition &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray.count == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *lines = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTFrameGetLines(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; lineCount = lines.count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; lineOrigins[lineCount];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameGetLineOrigins(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), lineOrigins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; imgIndex = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextImageData *imageData = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; lineCount; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (imageData == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTLineRef lineRef = (__bridge CTLineRef)lines[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *runsArray = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTLineGetGlyphRuns(lineRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; runObj &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; runsArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunRef runRef = (__bridge CTRunRef)runObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *runAttribs = (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)CTRunGetAttributes(runRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunDelegateRef delegate = (__bridge CTRunDelegateRef)[runAttribs valueForKey:(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTRunDelegateAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (delegate == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *metaDic = CTRunDelegateGetRefCon(delegate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (![metaDic isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.size.width = CTRunGetTypographicBounds(runRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.size.height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; xOffset = CTLineGetOffsetForStringIndex(lineRef, CTRunGetStringRange(runRef).location, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.x = lineOrigins[i].x + xOffset;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.y = lineOrigins[i].y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.y -= descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPathRef&lt;/span&gt; pathRef = CTFrameGetPath(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; colRect = &lt;span class=&quot;built_in&quot;&gt;CGPathGetBoundingBox&lt;/span&gt;(pathRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; delegateRect = &lt;span class=&quot;built_in&quot;&gt;CGRectOffset&lt;/span&gt;(runBounds, colRect.origin.x, colRect.origin.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            imageData.imageRect = delegateRect;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            imgIndex++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(imgIndex == &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray.count) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                imageData = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                imageData = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray[imgIndex];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&amp;gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;上面是在 &lt;code&gt;FYEvolveDisplayView&lt;/code&gt; 中 &lt;code&gt;drawRect:&lt;/code&gt; 采用 &lt;code&gt;CTFrameDraw(CTFrameRef, CGContext)&lt;/code&gt; 绘制在 &lt;code&gt;UIView&lt;/code&gt; 上，然后从 &lt;code&gt;FYCoreTextData&lt;/code&gt; 中逐个绘制 &lt;code&gt;FYCoreTextImageData&lt;/code&gt; 取出在 &lt;strong&gt;&lt;code&gt;Step 2&lt;/code&gt;&lt;/strong&gt; 计算当前 &lt;code&gt;Image&lt;/code&gt; 对一个的区域。然后使用 &lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImageRef)&lt;/code&gt; 绘制；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;这里在上文中有展示。主要一点：&lt;code&gt;CTFrameRef&lt;/code&gt; 获取 &lt;code&gt;Line&lt;/code&gt; 每行，然后在遍历每行的 &lt;code&gt;Run&lt;/code&gt;（块）判断其 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 对应的协议计算当前 &lt;code&gt;Image&lt;/code&gt; 对应的区域。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;图片和链接文字点击&quot;&gt;&lt;a href=&quot;#图片和链接文字点击&quot; class=&quot;headerlink&quot; title=&quot;图片和链接文字点击&quot;&gt;&lt;/a&gt;图片和链接文字点击&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYEvolveDisplayView&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (instancetype)initWithCoder:(&lt;span class=&quot;built_in&quot;&gt;NSCoder&lt;/span&gt; *)aDecoder &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; = [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; initWithCoder:aDecoder];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; deployGestureRecognizer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)clickComposeImageInDisplayView:(&lt;span class=&quot;built_in&quot;&gt;UIGestureRecognizer&lt;/span&gt; *)recognizer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; point = [recognizer locationInView:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextImageData *imageData &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.imageArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; imageRect = imageData.imageRect;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; imagePosCoreText = imageRect.origin;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//转换 `Core Text`（左下）坐标到 `UIKit`（左上）坐标&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        imagePosCoreText.y = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height - imagePosCoreText.y - imageRect.size.height;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; rectInScreen = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(imagePosCoreText.x, imagePosCoreText.y, imageRect.size.width, imageRect.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;CGRectContainsPoint&lt;/span&gt;(rectInScreen, point)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;Click image of name: %@ url: %@&quot;&lt;/span&gt;, imageData.name, imageData.url);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextLinkData *linkData = [FYCoreTextLinkUtils touchLinkTextInDisplayView:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; atPoint:point data:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (linkData) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;Click Link Text. The title is: %@, The Url is %@&quot;&lt;/span&gt;, linkData.title, linkData.url);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;UIGestureRecognizer&lt;/span&gt; *)tapGestureRecognizer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_tapGestureRecognizer == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _tapGestureRecognizer = [[&lt;span class=&quot;built_in&quot;&gt;UITapGestureRecognizer&lt;/span&gt; alloc] initWithTarget:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; action:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(clickComposeImageInDisplayView:)];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _tapGestureRecognizer.delegate = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _tapGestureRecognizer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYCoreTextLinkUtils&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextLinkData *)touchLinkTextInDisplayView:(&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; *)view atPoint:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point data:(FYCoreTextData *)textData &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = textData.ctFrame;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; lines = CTFrameGetLines(frameRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!lines) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; count = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetCount&lt;/span&gt;(lines);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; origins[count];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameGetLineOrigins(frameRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), origins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Translateform coordinate&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGAffineTransform&lt;/span&gt; transform = &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformMakeTranslation&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, view.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    transform = &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformScale&lt;/span&gt;(transform, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;f, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;f);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; count; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; linePoint = origins[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTLineRef line = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(lines, i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; lineRect = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; gainLineBounds:line linePoint:linePoint];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; flippedRect = &lt;span class=&quot;built_in&quot;&gt;CGRectApplyAffineTransform&lt;/span&gt;(lineRect, transform);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;CGRectContainsPoint&lt;/span&gt;(flippedRect, point)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; relativePoint = &lt;span class=&quot;built_in&quot;&gt;CGPointMake&lt;/span&gt;(point.x - &lt;span class=&quot;built_in&quot;&gt;CGRectGetMinX&lt;/span&gt;(flippedRect), point.y - &lt;span class=&quot;built_in&quot;&gt;CGRectGetMinY&lt;/span&gt;(flippedRect));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; index = CTLineGetStringIndexForPosition(line, relativePoint);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; linkTextAtIndex:index linkArray:textData.linkArray];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextLinkData *)linkTextAtIndex:(&lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt;)index linkArray:(&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)linkArray &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextLinkData *linkData = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextLinkData *data &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; linkArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSLocationInRange&lt;/span&gt;(index, data.range)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            linkData = data;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; linkData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)gainLineBounds:(CTLineRef)line linePoint:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; leading = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; width = (&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt;)CTLineGetTypographicBounds(line, &amp;amp;ascent, &amp;amp;descent, &amp;amp;leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(point.x, point.y - descent, width, height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;在当前 &lt;code&gt;FYEvoloveDisplayView&lt;/code&gt; 添加 &lt;code&gt;UITapGestureRecognizer&lt;/code&gt; 手势识别，来识别点击的位置。遍历对应 &lt;code&gt;FYCoreTextData&lt;/code&gt; 中图片 &lt;code&gt;Rect&lt;/code&gt; 来查找点击位置是否对应 &lt;code&gt;Image&lt;/code&gt;，同时执行 &lt;strong&gt;&lt;code&gt;Step 2&lt;/code&gt;&lt;/strong&gt; 来查找点击是否对应链接文字；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;在 &lt;code&gt;CTFrameRef&lt;/code&gt; 遍历每一行由 &lt;strong&gt;&lt;code&gt;Step 4&lt;/code&gt;&lt;/strong&gt; 来获取对应行 &lt;code&gt;Rect&lt;/code&gt; 转变为 &lt;code&gt;UIKit&lt;/code&gt; 坐标，在该行 &lt;code&gt;Rect&lt;/code&gt; 在当前包含点击 &lt;code&gt;Point&lt;/code&gt; 时，在由 &lt;code&gt;Step 3&lt;/code&gt; 遍历对应输出 &lt;code&gt;FYCoreTextLinkData&lt;/code&gt; 链接文字；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;在点击每行 &lt;code&gt;Line&lt;/code&gt; 中通过点击文字 &lt;code&gt;Line&lt;/code&gt; 中的 &lt;code&gt;Index&lt;/code&gt; 遍历链接文字对应 &lt;code&gt;Range&lt;/code&gt; 获取对应点击 &lt;code&gt;FYCoreTextLinkData&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;通过当前行 &lt;code&gt;Start Point&lt;/code&gt; 然后获取当前 &lt;code&gt;Run&lt;/code&gt; 对应 &lt;code&gt;Rect&lt;/code&gt; 然后计算出对应 &lt;code&gt;Line&lt;/code&gt; 的 &lt;code&gt;Rect&lt;/code&gt;（区域）。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;上面代码的 &lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/tree/master/Core%20Text/FYCoreText&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Demo&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;本地&quot;&gt;&lt;a href=&quot;#本地&quot; class=&quot;headerlink&quot; title=&quot;本地&quot;&gt;&lt;/a&gt;本地&lt;/h3&gt;&lt;p&gt;在本地获取图文混排的数据，具体内容绘制的以 &lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt;&lt;/strong&gt; 实现来进行讲述。这里仅仅展示 &lt;code&gt;YYText&lt;/code&gt; 的类图，然后贴出提出几个问题。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt; 类图&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEXGjgdRqOpHb26gu%2F1877765-3650ddeb5f979ba4.png?alt=media&amp;amp;token=1a9b5b36-922b-4f0a-86ed-63cf9ddcc429&quot; alt=&quot;YYKit(类图).png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;下面主要解决一下问题&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;（1）怎么提供后台绘制的能力？&lt;br&gt;（2）怎么计算 &lt;code&gt;String&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;UIView&lt;/code&gt; 实现图文排序？&lt;br&gt;（3）怎么实现 &lt;code&gt;String&lt;/code&gt; 设置 &lt;code&gt;Text&lt;/code&gt; 各种格式设置？&lt;br&gt;（4）怎么实现具体绘制？&lt;br&gt;（5）怎么实现富文本上点击事件？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;怎么提供后台绘制的能力&quot;&gt;&lt;a href=&quot;#怎么提供后台绘制的能力&quot; class=&quot;headerlink&quot; title=&quot;怎么提供后台绘制的能力&quot;&gt;&lt;/a&gt;怎么提供后台绘制的能力&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYText&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (Class)layerClass &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 重写 TextAsyncLayer 也即是重新定义 Layer 类&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 实现对重定向&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [YYTextAsyncLayer class];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAsyncLayer 异步后台绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.willDisplay) task.willDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;_YYTextSentinel *sentinel = _sentinel;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;int32_t value = sentinel.value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^isCancelled)() = ^&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; value != sentinel.value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; opaque = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; scale = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//生成背景颜色的 CGTypeRef 类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGColorRef&lt;/span&gt; backgroundColor = (opaque &amp;amp;&amp;amp; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) ? &lt;span class=&quot;built_in&quot;&gt;CGColorRetain&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) : &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//判断当前 size 宽高 | 如果不满住条件 | 就要返回当前 Layer Contents 桥接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//实际绘制 获取获取当前绘制线程，在当前线程中绘制 | 提供取消机制，取消就展示 | 在设置的 CGContext 获取绘制 Image | 判断取消的基础上在 main thread 绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (size.width &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; || size.height &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGImageRef&lt;/span&gt; image = (__bridge_retained &lt;span class=&quot;built_in&quot;&gt;CGImageRef&lt;/span&gt;)(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (image) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(YYTextAsyncLayerGetReleaseQueue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//释放 image&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(image);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取后台配置的线程 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(YYTextAsyncLayerGetDisplayQueue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//配置 Context 上下文&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIGraphicsBeginImageContextWithOptions&lt;/span&gt;(size, opaque, scale);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opaque &amp;amp;&amp;amp; context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//将当前图形状态的 Copy 加入图形堆栈中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGContextSaveGState&lt;/span&gt;(context); &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!backgroundColor || &lt;span class=&quot;built_in&quot;&gt;CGColorGetAlpha&lt;/span&gt;(backgroundColor) &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//设置填充颜色 | 设置绘制路径 | Path 填充&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; whiteColor].CGColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width * scale, size.height * scale));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (backgroundColor) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width * scale, size.height * scale));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//从堆栈中取出设置 | 针对指针 retain +1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGContextRestoreGState&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    task.display(context, size, isCancelled);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123; &lt;span class=&quot;comment&quot;&gt;//如果取消 | 结束 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//在主线程展示回调&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetImageFromCurrentImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//如果没有取消 | 把 image -&amp;gt; contents&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//然后返回展示&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)(image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAsyncLayer 绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[_sentinel increase];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.willDisplay) task.willDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//通过 CGContext 设置当前绘制条件 | 调用 YYTextLayout 绘制 | CGContext 绘制绘制生成 Image | 展示&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIGraphicsBeginImageContextWithOptions&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque &amp;amp;&amp;amp; context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    size.width *= &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    size.height *= &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSaveGState&lt;/span&gt;(context); &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor || &lt;span class=&quot;built_in&quot;&gt;CGColorGetAlpha&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; whiteColor].CGColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width, size.height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width, size.height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;built_in&quot;&gt;CGContextRestoreGState&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//调用展示 display 方法 | 显示展示的内容&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;task.display(context, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size, ^&amp;#123;&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetImageFromCurrentImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)(image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//把绘制的内容 生成 image 然后赋值给 content&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//调用 展示函数回调 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;上面贴出基于 &lt;code&gt;YYTextAsyncLayer&lt;/code&gt; 实现在 &lt;code&gt;main thread&lt;/code&gt; 和 &lt;code&gt;background thread&lt;/code&gt; 绘制代码。可以看出两者在实际绘制的核心代码是一样的，只是在实现后台异步绘制的时候添加 &lt;code&gt;cancel&lt;/code&gt; 机制。然后&lt;strong&gt;通过在 &lt;code&gt;UIGraphicsGetImageFromCurrentImageContext()&lt;/code&gt; 获取当前 &lt;code&gt;YYText&lt;/code&gt; 通过 &lt;code&gt;YYTextLayout&lt;/code&gt; 绘制之后生成对应的 &lt;code&gt;Image&lt;/code&gt; 在 &lt;code&gt;main thread&lt;/code&gt; 实现 &lt;code&gt;didDisplay&lt;/code&gt; 的回调绘制。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;计算-String、Image-和-UIView-实现图文排序&quot;&gt;&lt;a href=&quot;#计算-String、Image-和-UIView-实现图文排序&quot; class=&quot;headerlink&quot; title=&quot;计算 String、Image 和 UIView 实现图文排序&quot;&gt;&lt;/a&gt;计算 &lt;code&gt;String&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;UIView&lt;/code&gt; 实现图文排序&lt;/h4&gt;&lt;p&gt;这里贴出在计算 &lt;code&gt;String&lt;/code&gt; 和 &lt;code&gt;Image&lt;/code&gt;，&lt;code&gt;UIView&lt;/code&gt;（附件） 在实际计算的实现类，由于代码量较大就不一一列出给出下面两个类。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/blob/master/YYKitAnalysis/YYText-master/YYText/Component/YYTextLayout.m&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;YYTextLayout&lt;/a&gt;&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/blob/master/YYKitAnalysis/YYText-master/YYText/Component/YYTextLine.m&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;YYTextLine&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLayout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (YYTextLayout *)layoutWithContainer:(YYTextContainer *)container text:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)text range:(&lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt;)range &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 9.4 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Line 291&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;YYTextLine *line = [YYTextLine lineWithCTLine:ctLine position:position vertical:isVerticalForm];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLine &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)setCTLine:(_Nonnull CTLineRef)CTLine &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine != CTLine) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (CTLine) &lt;span class=&quot;built_in&quot;&gt;CFRetain&lt;/span&gt;(CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine) &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _CTLine = CTLine;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//获取当前 Line 的宽度值 || 获取当前 line 的 ascent|descent|leading&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _lineWidth = CTLineGetTypographicBounds(_CTLine, &amp;amp;_ascent, &amp;amp;_descent, &amp;amp;_leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//获取当前 Line 的 Range&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFRange&lt;/span&gt; range = CTLineGetStringRange(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(range.location, range.length);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (CTLineGetGlyphCount(_CTLine) &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//Line 中字形的数量, 即 CTRun&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; runs = CTLineGetGlyphRuns(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                CTRunRef run = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(runs, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//获取第一个 run 字形 | 复制到用户提供的数据缓冲区 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; pos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                CTRunGetPositions(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), &amp;amp;pos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _firstGlyphPos = pos.x;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _firstGlyphPos = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _trailingWhitespaceWidth = CTLineGetTrailingWhitespaceWidth(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _lineWidth = _ascent = _descent = _leading = _firstGlyphPos = _trailingWhitespaceWidth = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; reloadBounds];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)reloadBounds &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 当前行所有的 字形 | 当前字形的数量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; runs = CTLineGetGlyphRuns(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; runCount = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetCount&lt;/span&gt;(runs);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (runCount == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachments = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachmentRanges = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachmentRects = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; r = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; r &amp;lt; runCount; r++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunRef run = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(runs, r);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; glyphCount = CTRunGetGlyphCount(run);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (glyphCount == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//根据 run 字形块获取所在 Attributes 基本设置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs = (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)CTRunGetAttributes(run);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//获取不知道什么👻？ Attachment 可能是 UIImage|UIView|CALayer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//TODO&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        YYTextAttachment *attachment = attrs[YYTextAttachmentAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attachment) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; runPosition = &lt;span class=&quot;built_in&quot;&gt;CGPointZero&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunGetPositions(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), &amp;amp;runPosition);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;///判断当前 run 是否是 Attachment 然后获取当前 run 的上升、下移和缩进&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent, descent, leading, runWidth;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runTypoBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runWidth = CTRunGetTypographicBounds(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &amp;amp;leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_vertical) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//交换两者之间的坐标&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                YYTEXT_SWAP(runPosition.x, runPosition.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.y = _position.y + runPosition.y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runTypoBounds = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(_position.x + runPosition.x - descent, runPosition.y , ascent + descent, runWidth);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// &amp;#123;x, y, width, height&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//line 中 position | run 中 runWidth 和 ascent/descent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.x += _position.x;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.y = _position.y - runPosition.y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runTypoBounds = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(runPosition.x, runPosition.y - ascent, runWidth, ascent + descent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; runRange = YYTextNSRangeFromCFRange(CTRunGetStringRange(run));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//添加附件 | 当前附件 range | 当前 line 的 rect&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachments addObject:attachment];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachmentRanges addObject:[&lt;span class=&quot;built_in&quot;&gt;NSValue&lt;/span&gt; valueWithRange:runRange]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachmentRects addObject:[&lt;span class=&quot;built_in&quot;&gt;NSValue&lt;/span&gt; valueWithCGRect:runTypoBounds]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//附件复制 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachments = attachments.count ? attachments : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachmentRanges = attachmentRanges.count ? attachmentRanges : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachmentRects = attachmentRects.count ? attachmentRects : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在 &lt;code&gt;YYTextLayout&lt;/code&gt; 中调用 &lt;code&gt;YYTextLine&lt;/code&gt; 实例方式计算当前 &lt;code&gt;CTFrameRef&lt;/code&gt; 中 &lt;code&gt;Each Line&lt;/code&gt; 相关参数。&lt;br&gt;在 &lt;code&gt;YYTextLine&lt;/code&gt; 中可以看出以 &lt;code&gt;Line&lt;/code&gt; 为单位计算当前绘制参数，然后通过 &lt;strong&gt;&lt;code&gt;reloadBounds&lt;/code&gt;&lt;/strong&gt; 来遍历当前行的 &lt;code&gt;Run&lt;/code&gt; 获取在初始化 &lt;code&gt;Attachment&lt;/code&gt; 找出当前 &lt;code&gt;Line&lt;/code&gt; 中的 &lt;code&gt;UIView&lt;/code&gt;，&lt;code&gt;CALayer&lt;/code&gt; 和 &lt;code&gt;UIImage&lt;/code&gt; 来设置当前 &lt;code&gt;Attachment&lt;/code&gt; 绘制区域和范围。&lt;br&gt;&lt;strong&gt;详细信息可以参考代码注释&lt;/strong&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实现-String-设置-Text-各种格式设置&quot;&gt;&lt;a href=&quot;#实现-String-设置-Text-各种格式设置&quot; class=&quot;headerlink&quot; title=&quot;实现 String 设置 Text 各种格式设置&quot;&gt;&lt;/a&gt;实现 &lt;code&gt;String&lt;/code&gt; 设置 &lt;code&gt;Text&lt;/code&gt; 各种格式设置&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAttribute &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//设置当前字体显示类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBackedStringAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBackedString&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBindingAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBinding&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextShadowAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextShadow&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextInnerShadowAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextInnerShadow&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextUnderlineAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextUnderline&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextStrikethroughAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextStrikethrough&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//对文字进行描边&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBackgroundBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBackgroundBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBlockBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBlockBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextAttachmentAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextAttachment&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextHighlightAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextHighlight&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextGlyphTransformAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextGlyphTransform&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//NSAttributedString+YYText&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (YYTextShadow *)yy_textInnerShadowAtIndex:(&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;)index &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; yy_attribute:YYTextInnerShadowAttributeName atIndex:index];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)yy_attribute:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)attributeName atIndex:(&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;)index &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!attributeName) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (index &amp;gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length || &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; index == &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length) index--;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attribute:attributeName atIndex:index effectiveRange:&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;+ (YYTextLayout *)layoutWithContainer:(YYTextContainer *)container text:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)text range:(&lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt;)range &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (visibleRange.length &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        layout.needDrawText = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//TODO TODO &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; (^block)(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; *stop) = ^(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; *stop) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextHighlightAttributeName]) layout.containsHighlight = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBlockBorderAttributeName]) layout.needDrawBlockBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBackgroundBorderAttributeName]) layout.needDrawBackgroundBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextShadowAttributeName] || attrs[&lt;span class=&quot;built_in&quot;&gt;NSShadowAttributeName&lt;/span&gt;]) layout.needDrawShadow = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextUnderlineAttributeName]) layout.needDrawUnderline = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextAttachmentAttributeName]) layout.needDrawAttachment = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextInnerShadowAttributeName]) layout.needDrawInnerShadow = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextStrikethroughAttributeName]) layout.needDrawStrikethrough = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBorderAttributeName]) layout.needDrawBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在初始化 &lt;code&gt;String&lt;/code&gt; 设置字体特定的格式，然后根据提供的 &lt;code&gt;Key&lt;/code&gt; 值类型来保存在当前 &lt;code&gt;String&lt;/code&gt; 转化为 &lt;code&gt;NSAttributedString&lt;/code&gt; 类型的格式中。&lt;strong&gt;设置当前 &lt;code&gt;Line&lt;/code&gt; 所属的 &lt;code&gt;YYTextLayout&lt;/code&gt; 标记当前状态，在绘制时来执行在改 &lt;code&gt;Line&lt;/code&gt; 的 &lt;code&gt;Run&lt;/code&gt; 执行绘制（&lt;/strong&gt;后面在绘制中会讲述&lt;strong&gt;）。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实现具体绘制？&quot;&gt;&lt;a href=&quot;#实现具体绘制？&quot; class=&quot;headerlink&quot; title=&quot;实现具体绘制？&quot;&gt;&lt;/a&gt;实现具体绘制？&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYLabel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (YYTextAsyncLayerDisplayTask *)newAsyncDisplayTask &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    task.display = ^(&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context, &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^isCancelled)(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//Layout 绘制当前 UIView 界面&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [drawLayout drawInContext:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; size:size point:point view:view layer:layer debug:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; cancel:&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//跟新当前的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;///当前 Label 的附件 此附件归属于 Layout 中 attachments 属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (YYTextAttachment *a &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; drawLayout.attachments) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([a.content isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; class]]) [attachmentViews addObject:a.content];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([a.content isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;CALayer&lt;/span&gt; class]]) [attachmentLayers addObject:a.content];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLayout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Line 3469&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//TODO 绘制方法调用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawInContext:(&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt;)context&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 size:(&lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt;)size&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                point:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 view:(&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; *)view&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                layer:(&lt;span class=&quot;built_in&quot;&gt;CALayer&lt;/span&gt; *)layer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                debug:(YYTextDebugOption *)debug&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                cancel:(&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^)(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;))cancel&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@autoreleasepool&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;实现富文本上点击事件&quot;&gt;&lt;a href=&quot;#实现富文本上点击事件&quot; class=&quot;headerlink&quot; title=&quot;实现富文本上点击事件&quot;&gt;&lt;/a&gt;实现富文本上点击事件&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYLabel &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesBegan:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_highlight || _textTapAction || _textLongPressAction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _touchBeganPoint = point;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.trackingTouch = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.swallowTouch = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.touchMoved = &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//添加定时器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _startLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_highlight) [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _showHighlightAnimated:&lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesMoved:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.trackingTouch) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!_state.touchMoved) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.touchMoved) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _endLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesEnded:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.trackingTouch) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _endLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!_state.touchMoved &amp;amp;&amp;amp; _textTapAction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        _textTapAction(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, _innerText, range, rect);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TextKit Best Practices&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Introducing Text Kit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/220&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Text Layouts and Effects with Text Kit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/CoreText_Programming/Introduction/Introduction.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Core Text&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/TextFonts/Conceptual/CocoaTextArchitecture/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009459&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About the Cocoa Text System&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/TextAndWebiPhoneOS/Introduction/Introduction.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Text Handling in iOS&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/TextLayout/Concepts/LayoutManager.html#//apple_ref/doc/uid/20001805-BBCFEBHA&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;The Layout Manager&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2011/128/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Text Processing&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://cocoapods.org/pods/Graver&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Graver&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://apps.timwhitlock.info/emoji/tables/unicode#block-6c-other-additional-symbols&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Emoji Unicode Tables&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://juejin.im/entry/5922b0ef8d6d810058e760c4&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;新大陆：AsyncDisplayKit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://pilky.me/36/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimising Autolayout&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/#more-41893&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS 保持界面流畅的技巧&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://tech.meituan.com/2017/06/09/webviewperf.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;WebView性能、体验分析与优化&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://imtangqi.com/2016/02/18/the-notes-of-learning-text-kit/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Text Kit 学习笔记&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://objccn.io/issue-5-1/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;初识 TextKit&lt;/a&gt;     &lt;/p&gt;
&lt;p&gt;：&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Core-Text-富文本编辑&quot;&gt;&lt;a href=&quot;#Core-Text-富文本编辑&quot; class=&quot;headerlink&quot; title=&quot;Core Text 富文本编辑&quot;&gt;&lt;/a&gt;Core Text 富文本编辑&lt;/h1&gt;&lt;p&gt;在 &lt;code&gt;Core Graphics&lt;/code&gt; 后面一篇文章本该对 &lt;code&gt;Core Image&lt;/code&gt; 框架进行整理，但是基于 &lt;code&gt;Core Graphics&lt;/code&gt; 的富文本编辑 &lt;code&gt;Core Text&lt;/code&gt; 框架更方便讲述。而且结合自己兴趣和好玩的程度在讲述自己对 &lt;code&gt;Texture&lt;/code&gt; 即 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 详细描述。&lt;/p&gt;
&lt;h2 id=&quot;Core-Text-结构层级&quot;&gt;&lt;a href=&quot;#Core-Text-结构层级&quot; class=&quot;headerlink&quot; title=&quot;Core Text 结构层级&quot;&gt;&lt;/a&gt;Core Text 结构层级&lt;/h2&gt;&lt;p&gt;这里小编对 &lt;code&gt;Core Text&lt;/code&gt; 在实现的层次结构上所处位置，以及在对 &lt;code&gt;UIKit&lt;/code&gt; 框架我们常见控件 &lt;code&gt;UITextFiled&lt;/code&gt;、&lt;code&gt;UITextView&lt;/code&gt; 和 &lt;code&gt;UILabel&lt;/code&gt; 具体实现基础。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kE8qFvBCueh8O8d1_%2F1877765-d9fa387d512dd42d.png?alt=media&amp;amp;token=3d406869-6df1-4a7c-bcb6-6c228a9d1fce&quot; alt=&quot;Core Text.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上图是小编根据 &lt;strong&gt;2018 WWDC&lt;/strong&gt; 中 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot;&gt;TextKit Best Practices&lt;/a&gt; 和 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot;&gt;Introducing Text Kit&lt;/a&gt; 得出 &lt;code&gt;Core Graphics&lt;/code&gt;、&lt;code&gt;Core Text&lt;/code&gt; 和 &lt;code&gt;UIKit&lt;/code&gt; 中能够实现文本绘制的控件实现结构图。&lt;br&gt;根据上面结构可以看出：&lt;br&gt;（1）基于 &lt;code&gt;Quartz&lt;/code&gt; 封装的 &lt;code&gt;Core Graphics&lt;/code&gt; 为 &lt;code&gt;Core Text&lt;/code&gt; 的实现基础。而且 &lt;code&gt;Quartz&lt;/code&gt; 可以直接处理字体和字形将文字渲染到界面，也是在 Apple 基础库中唯一一个处理字体模块。&lt;br&gt;（2）基于 &lt;code&gt;Core Text&lt;/code&gt; 封装实现的 &lt;code&gt;Text Kit&lt;/code&gt; 为在 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 中文本显示控件 &lt;code&gt;TypeTextFiled&lt;/code&gt;、&lt;code&gt;TypeTextView&lt;/code&gt; 等提供最直接的接口。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - 番外篇</title>
    <link href="http://yoursite.com/2019/05/13/iOS%20UI%20%E4%BC%98%E5%8C%96%20-%20%E7%95%AA%E5%A4%96%E7%AF%87/"/>
    <id>http://yoursite.com/2019/05/13/iOS UI 优化 - 番外篇/</id>
    <published>2019-05-13T02:40:09.769Z</published>
    <updated>2019-05-13T02:41:50.212Z</updated>
    
    <content type="html">&lt;h2 id=&quot;iOS-UI-优化番外篇-动画&quot;&gt;&lt;a href=&quot;#iOS-UI-优化番外篇-动画&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 优化番外篇 - 动画&quot;&gt;&lt;/a&gt;iOS UI 优化番外篇 - 动画&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/Lision/LSAnimator&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;LSAnimator&lt;/a&gt;    &lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;iOS-UI-优化番外篇-动画&quot;&gt;&lt;a href=&quot;#iOS-UI-优化番外篇-动画&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 优化番外篇 - 动画&quot;&gt;&lt;/a&gt;iOS UI 优化番外篇 - 动画&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - Core Text</title>
    <link href="http://yoursite.com/2019/05/05/iOS%20UI%20%E4%BC%98%E5%8C%96%20-%20ASDK%20VS%20YYKit/"/>
    <id>http://yoursite.com/2019/05/05/iOS UI 优化 - ASDK VS YYKit/</id>
    <published>2019-05-05T11:46:11.570Z</published>
    <updated>2020-05-20T13:14:58.978Z</updated>
    
    <content type="html">&lt;h1 id=&quot;Core-Text-富文本编辑&quot;&gt;&lt;a href=&quot;#Core-Text-富文本编辑&quot; class=&quot;headerlink&quot; title=&quot;Core Text 富文本编辑&quot;&gt;&lt;/a&gt;Core Text 富文本编辑&lt;/h1&gt;&lt;p&gt;在 &lt;code&gt;Core Graphics&lt;/code&gt; 后面一篇文章本该对 &lt;code&gt;Core Image&lt;/code&gt; 框架进行整理，但是基于 &lt;code&gt;Core Graphics&lt;/code&gt; 的富文本编辑 &lt;code&gt;Core Text&lt;/code&gt; 框架更方便讲述。而且结合自己兴趣和好玩的程度在讲述自己对 &lt;code&gt;Texture&lt;/code&gt; 即 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 详细描述。&lt;/p&gt;
&lt;h2 id=&quot;Core-Text-结构层级&quot;&gt;&lt;a href=&quot;#Core-Text-结构层级&quot; class=&quot;headerlink&quot; title=&quot;Core Text 结构层级&quot;&gt;&lt;/a&gt;Core Text 结构层级&lt;/h2&gt;&lt;p&gt;这里小编对 &lt;code&gt;Core Text&lt;/code&gt; 在实现的层次结构上所处位置，以及在对 &lt;code&gt;UIKit&lt;/code&gt; 框架我们常见控件 &lt;code&gt;UITextFiled&lt;/code&gt;、&lt;code&gt;UITextView&lt;/code&gt; 和 &lt;code&gt;UILabel&lt;/code&gt; 具体实现基础。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kE8qFvBCueh8O8d1_%2F1877765-d9fa387d512dd42d.png?alt=media&amp;amp;token=3d406869-6df1-4a7c-bcb6-6c228a9d1fce&quot; alt=&quot;Core Text.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上图是小编根据 &lt;strong&gt;2018 WWDC&lt;/strong&gt; 中 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TextKit Best Practices&lt;/a&gt; 和 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Introducing Text Kit&lt;/a&gt; 得出 &lt;code&gt;Core Graphics&lt;/code&gt;、&lt;code&gt;Core Text&lt;/code&gt; 和 &lt;code&gt;UIKit&lt;/code&gt; 中能够实现文本绘制的控件实现结构图。&lt;br&gt;根据上面结构可以看出：&lt;br&gt;（1）基于 &lt;code&gt;Quartz&lt;/code&gt; 封装的 &lt;code&gt;Core Graphics&lt;/code&gt; 为 &lt;code&gt;Core Text&lt;/code&gt; 的实现基础。而且 &lt;code&gt;Quartz&lt;/code&gt; 可以直接处理字体和字形将文字渲染到界面，也是在 Apple 基础库中唯一一个处理字体模块。&lt;br&gt;（2）基于 &lt;code&gt;Core Text&lt;/code&gt; 封装实现的 &lt;code&gt;Text Kit&lt;/code&gt; 为在 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 中文本显示控件 &lt;code&gt;TypeTextFiled&lt;/code&gt;、&lt;code&gt;TypeTextView&lt;/code&gt; 等提供最直接的接口。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;Core-Text-API-族&quot;&gt;&lt;a href=&quot;#Core-Text-API-族&quot; class=&quot;headerlink&quot; title=&quot;Core Text API 族&quot;&gt;&lt;/a&gt;Core Text API 族&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEDtfL0uYk56NKxq3%2F1877765-4ace47c5dff6e0f5.png?alt=media&amp;amp;token=c3271fd4-c3ac-48f7-b4b6-f04a2373e841&quot; alt=&quot;Core Text API 族.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;Core Text&lt;/code&gt; 作为在 &lt;code&gt;OS&lt;/code&gt; 对应的五大平台唯一拥有实现文字绘制能力的跨平 台框架，族类 &lt;code&gt;API&lt;/code&gt; 都是表示 &lt;code&gt;CTType&lt;/code&gt; 形式。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Opaque-Types&quot;&gt;&lt;a href=&quot;#Opaque-Types&quot; class=&quot;headerlink&quot; title=&quot;Opaque Types&quot;&gt;&lt;/a&gt;Opaque Types&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;集合数据类型&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFont&lt;/code&gt;（字体）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体类型参数。字体特征中基本参数表示：字体大小、字体所属的格式或者是转换矩阵等。&lt;strong&gt;2、&lt;/strong&gt; 是在 &lt;code&gt;UIKit&lt;/code&gt; 中我们经常使用设置子类类型的 &lt;code&gt;UIFont&lt;/code&gt; 的 &lt;code&gt;(__birdge CTFont *)&lt;/code&gt; 表现形式，在采用 &lt;code&gt;context&lt;/code&gt; 绘制上下文中绘制确定字体。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFontCollection&lt;/code&gt;（字体组）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体组合。字体组合也即是对一组文字或者一段短文字字体集合，提供对同一段文字不同格式文字内容字体访问和获取。一句话：&lt;strong&gt;字体整体表示。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFontDescriptor&lt;/code&gt;（字体描述）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体类型描述。字体描述可以用获取、指定或者是修改当前字体属性，字体相关属性（字体名字、位置点大小和变化等）。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFrame&lt;/code&gt;（绘制画布）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示多行文字绘制画布。&lt;code&gt;CTFrame&lt;/code&gt;（绘制画布）是 &lt;code&gt;Core Text&lt;/code&gt; 实现文字绘制对外集中体现形式，其中确定绘制参数：画布区域（&lt;code&gt;Range&lt;/code&gt;）、绘制路径（&lt;code&gt;Path&lt;/code&gt;）和绘制文本参数信息（&lt;code&gt;Attribtes&lt;/code&gt;）。&lt;strong&gt;2、&lt;/strong&gt; 对于单行来说可以精确获取在画布：行数和每一行对应开头坐标。在获取绘制的画布时调用对应的 &lt;strong&gt;&lt;code&gt;CTFrameDraw(CTFrame, CGContext)&lt;/code&gt;&lt;/strong&gt; 在上下文中绘制文字显示详细内容。 &lt;strong&gt;3、&lt;/strong&gt; &lt;strong&gt;&lt;code&gt;CTFrame&lt;/code&gt; 不仅支持在 &lt;code&gt;main thread&lt;/code&gt; 中进行绘制，同样也支持在 &lt;code&gt;background Thread&lt;/code&gt; 进行内容的绘制。&lt;/strong&gt; 这也是 &lt;code&gt;YYKit&lt;/code&gt; 和 &lt;code&gt;Texture&lt;/code&gt; 支持后台绘制控件实现的基础。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTFramesetter&lt;/code&gt;（画布🏭）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体具体绘制生成工厂。画布工厂根据要显示的富文本信息、显示画布路径和画布具体的区域（&lt;code&gt;Range&lt;/code&gt;）来生成对应展示的显示画布的效果。&lt;strong&gt;2、&lt;/strong&gt; &lt;code&gt;CTFramesetter&lt;/code&gt;（画布工厂）是采用 &lt;code&gt;CFFrameDraw&lt;/code&gt; 来实现富文本编辑绘制基础，但是如果采用 &lt;code&gt;CTLineDraw&lt;/code&gt; 或者是 &lt;code&gt;CTRunDraw&lt;/code&gt; 形似就另当别论了。 &lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt; 中绘制的就是按照 &lt;code&gt;CTLineDraw&lt;/code&gt; 和 &lt;code&gt;CTRunDraw&lt;/code&gt; 来绘制的。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTGlyphInfo&lt;/code&gt;（字体信息）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在字体对于 &lt;code&gt;Glyph ID&lt;/code&gt; 特殊的映射关系。&lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTLine&lt;/code&gt;（画布中行）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在具体执行 &lt;code&gt;Frame&lt;/code&gt;（画布）中一行。是组成画布绘制 &lt;code&gt;Frame&lt;/code&gt; 中单独的一行，同时也是字体不同格式组成在一行中组成最小单元 &lt;strong&gt;&lt;code&gt;Run&lt;/code&gt;&lt;/strong&gt;（块）的集合。 &lt;strong&gt;2、&lt;/strong&gt; 在实现富文本绘制的过程中可以采用 &lt;strong&gt;&lt;code&gt;CTLineDraw(CTLine, CGContext)&lt;/code&gt;&lt;/strong&gt; 方式来绘制当前行。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTParagaraphStyle&lt;/code&gt;（段落格式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 段落格式表示在文本绘制时，段落段落之间设置基本参数或者单独一段信息基本格式。例如：对其样式、截取样式和排布的方向等等&lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTRun&lt;/code&gt;（块）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在富文本绘制过程中格式相同最小单元。根据字体设置的 &lt;code&gt;CTFont&lt;/code&gt;（字体）参数不同在绘制过程中可以分割为格式一致一个一个单元，既是 &lt;code&gt;Run&lt;/code&gt;。 &lt;strong&gt;2、&lt;/strong&gt; 在文本编辑过程中可以根据在画布中需要显示 &lt;code&gt;Lines&lt;/code&gt;，然后在但单独 &lt;code&gt;Line&lt;/code&gt; 中获得 &lt;code&gt;Run&lt;/code&gt; 采用 &lt;strong&gt;&lt;code&gt;CTRunDraw(CTRun, CGContext)&lt;/code&gt;&lt;/strong&gt; 来实现单个 &lt;code&gt;Run&lt;/code&gt;（块）独自绘制。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTRunDelegate&lt;/code&gt;（块协议）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在运行时的一个运行委托，在实现计算是可以调整字形上升、下降和当前绘制字形宽高。这个 &lt;code&gt;API&lt;/code&gt; 是我们在实现文字图片换混排的基础，在生成 &lt;code&gt;Frame&lt;/code&gt; 时计算当前 &lt;code&gt;Line&lt;/code&gt; 里面 &lt;code&gt;Run&lt;/code&gt; 需要绘制素材类型，然后在改素材类型位置设置 &lt;code&gt;Image&lt;/code&gt; 的 &lt;code&gt;Ascent&lt;/code&gt;、&lt;code&gt;Descent&lt;/code&gt;、&lt;code&gt;Width&lt;/code&gt; 和 &lt;code&gt;Height&lt;/code&gt; 来设置当前图片绘制参数信息，然后在实际绘制中在当前需要绘制的 &lt;code&gt;Image&lt;/code&gt; 采用 &lt;strong&gt;&lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImageRef)&lt;/code&gt;&lt;/strong&gt; 绘制当前图片。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTTextTab&lt;/code&gt;（文本标签）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在文本段落中样式标签，用来保存段落之间段落对其方式和位置信息。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CTTypesetter&lt;/code&gt;（排版工厂）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示字体具体绘制来执行布局。可以通过 &lt;strong&gt;&lt;code&gt;CTFramesetterCreateWithTypesetter(CTTypesetter)&lt;/code&gt; 生成上文展示 &lt;code&gt;CTFramesetter&lt;/code&gt;（绘制工厂）。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;集合数据类型&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Sting Attributes&lt;/code&gt;（富文本展示样式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;富文本下划线样式设置&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Structure&lt;/code&gt;（结构）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;CTTextTab&lt;/code&gt;（标签） 范围和表，查找向量 Header。&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Enumerations&lt;/code&gt;（枚举）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 字体描述匹配、指定绑定标识符自动激活、指定 URL 字体注册失败、定义字体注册范文等等。&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Constants&lt;/code&gt;（常量值）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中使用富文本设置一些常量值。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Fundations&lt;/code&gt;（功能）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中一些功能参数值。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;Core Text Data Types&lt;/code&gt;（数据分类）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;&lt;code&gt;Core Text&lt;/code&gt; 中 &lt;code&gt;ATS&lt;/code&gt; 字体参考、字体集合排序描述符回调和 &lt;code&gt;CT&lt;/code&gt; 描述符处理进度回调。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;上面是 &lt;code&gt;Core Text&lt;/code&gt; 所有的 &lt;code&gt;API&lt;/code&gt; 的接口，及其在实现富文本绘制中相对相应的 &lt;code&gt;API&lt;/code&gt; 的主要功能作用。&lt;strong&gt;具体 &lt;code&gt;CTFramesetter&lt;/code&gt; 怎么样通过 &lt;code&gt;NSString&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt; 然后在 &lt;code&gt;UIKit&lt;/code&gt; 基础的显示控件上绘制出来的呢？&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Core-Text-最小系统&quot;&gt;&lt;a href=&quot;#Core-Text-最小系统&quot; class=&quot;headerlink&quot; title=&quot;Core Text 最小系统&quot;&gt;&lt;/a&gt;&lt;code&gt;Core Text&lt;/code&gt; 最小系统&lt;/h2&gt;&lt;p&gt;这里说的最小系统概念是在电子单片机中最小系统单元，这里指的是 &lt;code&gt;Core Text&lt;/code&gt; 实现最基本文字排版。&lt;br&gt;&lt;strong&gt;下面贴出在实现中经典代码：&lt;/strong&gt;   &lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawRect:(&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)rect &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; drawRect:rect];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSetTextMatrix&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformIdentity&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextTranslateCTM&lt;/span&gt;(context, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextScaleCTM&lt;/span&gt;(context, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGMutablePathRef&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;CGPathCreateMutable&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPathAddRect&lt;/span&gt;(path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *attString = [[&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; alloc] initWithString:&lt;span class=&quot;string&quot;&gt;@&quot;Hello world! Welcome to learn RICH TEXT knowladge.&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((&lt;span class=&quot;built_in&quot;&gt;CFAttributedStringRef&lt;/span&gt;)attString);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frame = CTFramesetterCreateFrame(frameSetter, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, attString.length), path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameDraw(frame, context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Step 6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameSetter);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;继承 &lt;code&gt;UIView&lt;/code&gt; 来自定义 &lt;code&gt;FYView&lt;/code&gt; 然后重写 &lt;code&gt;drawRect:&lt;/code&gt;，在上面 &lt;code&gt;drawRect:&lt;/code&gt; 重新写上面代码。&lt;strong&gt;在 &lt;code&gt;Core Text&lt;/code&gt; 实际绘制中主要分为：计算转换在 &lt;code&gt;UIKit&lt;/code&gt; 的坐标、设置绘制 &lt;code&gt;Path&lt;/code&gt;、初始化 &lt;code&gt;CFFramesetter&lt;/code&gt; 画布工厂生成画布和在上下文中绘制。&lt;/strong&gt;&lt;br&gt;具体分为 6 个步骤：&lt;br&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;获取当前绘制上下文 &lt;code&gt;context&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;把 &lt;code&gt;Core Text&lt;/code&gt; 中左下角的坐标点转换为 &lt;code&gt;UIKit&lt;/code&gt; 左上角的坐标点；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;设置绘制的 &lt;code&gt;path&lt;/code&gt; 路径，把当前 &lt;code&gt;UIView&lt;/code&gt; 的 &lt;code&gt;bounds&lt;/code&gt; 设置为绘制区域；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;通过 &lt;code&gt;String&lt;/code&gt; 初始化 &lt;code&gt;NSAttributedString&lt;/code&gt; 来创建 &lt;strong&gt;&lt;code&gt;CTFramesetterRef&lt;/code&gt;&lt;/strong&gt; 然后根据画布工厂创建 &lt;code&gt;CTFrameRef&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 5：&lt;/strong&gt;在上下文中绘制画布内容；&lt;br&gt;&lt;strong&gt;Step 6：&lt;/strong&gt;释放创建 &lt;code&gt;frame&lt;/code&gt;、&lt;code&gt;path&lt;/code&gt; 和 &lt;code&gt;framesetter&lt;/code&gt; 的 &lt;code&gt;CFTypeRef&lt;/code&gt; 对象。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在当前 &lt;code&gt;Core Text&lt;/code&gt; 绘制的基础之上，我们在看一下具体绘制实现中 &lt;code&gt;CTTypeRef&lt;/code&gt; 中 &lt;strong&gt;&lt;code&gt;Framesetter&lt;/code&gt;、&lt;code&gt;Frame&lt;/code&gt;、 &lt;code&gt;Line&lt;/code&gt; 和 &lt;code&gt;Run&lt;/code&gt; 之间的关系&lt;/strong&gt;，以及在实际绘制显示在界面上对应。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEMTkga5I2kb3adio%2F1877765-80857db5a123d571.png?alt=media&amp;amp;token=07b120dd-3bf1-4a2e-b566-33b6005240a7&quot; alt=&quot;Core Text 最小系统.png&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;小编在实现图文混排实现中，贴出下面一段对于富文本 &lt;code&gt;CFFrameRef&lt;/code&gt; 来计算 &lt;code&gt;Image&lt;/code&gt; 富文本绘制布局代码。&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 frameRef 中 Lines&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *lines = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTFrameGetLines(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; lineCount = lines.count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 frameRef 中 Each Line 开头 Point&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; lineOrigins[lineCount];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CTFrameGetLineOrigins(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), lineOrigins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; imgIndex = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//遍历 Each Line&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; lineCount; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTLineRef lineRef = (__bridge CTLineRef)lines[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//获取 Each Line 的 Run&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *runsArray = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTLineGetGlyphRuns(lineRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//遍历 Each Run&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; runObj &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; runsArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunRef runRef = (__bridge CTRunRef)runObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *runAttribs = (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)CTRunGetAttributes(runRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunDelegateRef delegate = (__bridge CTRunDelegateRef)[runAttribs valueForKey:(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTRunDelegateAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (delegate == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *metaDic = CTRunDelegateGetRefCon(delegate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (![metaDic isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//获取 run 的 width&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.size.width = CTRunGetTypographicBounds(runRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//根据上下偏移获取 run 的 height&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.size.height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; xOffset = CTLineGetOffsetForStringIndex(lineRef, CTRunGetStringRange(runRef).location, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.x = lineOrigins[i].x + xOffset;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.y = lineOrigins[i].y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runBounds.origin.y -= descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPathRef&lt;/span&gt; pathRef = CTFrameGetPath(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; colRect = &lt;span class=&quot;built_in&quot;&gt;CGPathGetBoundingBox&lt;/span&gt;(pathRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; delegateRect = &lt;span class=&quot;built_in&quot;&gt;CGRectOffset&lt;/span&gt;(runBounds, colRect.origin.x, colRect.origin.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;从上面两段代码可以看出在 &lt;code&gt;CTTypeRef&lt;/code&gt; 类族中类的关系如下：&lt;br&gt;&lt;strong&gt;（1）&lt;/strong&gt; &lt;code&gt;CTFramesetter&lt;/code&gt; 通过初始化 &lt;code&gt;NSAttributedString&lt;/code&gt; 来创建绘制画布 &lt;code&gt;CTFrameRef&lt;/code&gt; 对应的类；&lt;br&gt;&lt;strong&gt;（2）&lt;/strong&gt; 通过画布 &lt;code&gt;CTFrame&lt;/code&gt; 可以获取所有的 &lt;code&gt;Line&lt;/code&gt; 基本信息，例如：行数、每行 &lt;code&gt;Start Point&lt;/code&gt;等参数。再通过坐标转换就可以计算当前 &lt;code&gt;Line&lt;/code&gt; 在 &lt;code&gt;UIKit&lt;/code&gt; 界面上布局绘制信息，&lt;strong&gt;在实际的绘制时可以选用 &lt;code&gt;CTLineDraw(CTLineRef, CGContext)&lt;/code&gt; 来替代 &lt;code&gt;CTFrameDraw(CTFrameRef, CGContext)&lt;/code&gt; 整个画布在当前上下文中绘制&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;（3）&lt;/strong&gt;效仿从 &lt;code&gt;CTFrameRef&lt;/code&gt; 中获取对应的 &lt;code&gt;Line&lt;/code&gt;，同样可以在 &lt;code&gt;Each Line&lt;/code&gt; 中来获取 &lt;code&gt;Core Text&lt;/code&gt; 最基本的单元 &lt;code&gt;CTRunRef&lt;/code&gt;。通过获取的 &lt;code&gt;Each Line&lt;/code&gt; 中所有的 &lt;code&gt;Run&lt;/code&gt;，然后借助 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 在实际绘制过程中动态设置当前 &lt;code&gt;Run&lt;/code&gt; 块需要绘制 &lt;code&gt;Rect&lt;/code&gt; 区域。&lt;strong&gt;同样在实际绘制时也可以采用 &lt;code&gt;CTRunDraw(CTRunRef, CGContext)&lt;/code&gt; 来代替 &lt;code&gt;CTLineDraw(CTLineRef, CGContext)&lt;/code&gt; 来单独绘制每个字形块。&lt;/strong&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;在图文混排过程中分为两种情况，根据情况的不同也可以采用不同的方式实现排版引擎实现：&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;（a）对于排版的数据来源于 &lt;code&gt;Server&lt;/code&gt; 也就是我们需要需要访问后才会获取数据，然后来初始化控件，鉴于 &lt;code&gt;Network&lt;/code&gt; 的延迟性，我们可以预先设置通过设置 &lt;code&gt;CTRunDelegate&lt;/code&gt; 拓展在展示时的 &lt;code&gt;Image&lt;/code&gt; 的参数信息；&lt;br&gt;（b）对要排版的数据信息已知，在实现的基础上对 &lt;code&gt;Image&lt;/code&gt; 位置插入临时代替的字符串，通过 &lt;code&gt;CTDelegateRef&lt;/code&gt; 来获取对应 &lt;code&gt;Image&lt;/code&gt; 基本参数设置当前 &lt;code&gt;Run&lt;/code&gt; 块的绘制时上下缩进，然后添加到富文本字符串中此时也可以记录当前插入字符串所在的位置。&lt;/strong&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Core-Text-图文混排实现&quot;&gt;&lt;a href=&quot;#Core-Text-图文混排实现&quot; class=&quot;headerlink&quot; title=&quot;Core Text 图文混排实现&quot;&gt;&lt;/a&gt;Core Text 图文混排实现&lt;/h2&gt;&lt;p&gt;目前以 &lt;code&gt;Core Text&lt;/code&gt; 为基础实现图文混排实现控件 &lt;code&gt;YYKit&lt;/code&gt; 系列组件中 &lt;code&gt;YYText&lt;/code&gt; 实现逻辑最为清晰，瞒住的情况也最为全面。下面根据要实现图文混排的数据来源做区分来分别讲解排版引擎实现逻辑。&lt;/p&gt;
&lt;h3 id=&quot;来自-Server&quot;&gt;&lt;a href=&quot;#来自-Server&quot; class=&quot;headerlink&quot; title=&quot;来自 Server&quot;&gt;&lt;/a&gt;来自 &lt;code&gt;Server&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;当需要排版的数据来自与 &lt;code&gt;Server&lt;/code&gt;，客户端和后台来商量在模板传输数据格式。这里在本地模拟网络数据加载的数据格式采用 &lt;strong&gt;&lt;code&gt;JSON&lt;/code&gt;&lt;/strong&gt; 来实现，不过小编建议如果后台允许的情况下可以尝试 &lt;strong&gt;&lt;code&gt;Protobuf&lt;/code&gt;&lt;/strong&gt; 数据格式（后面小编会在网络协议中对该格式的数据进行详细的讲解）。&lt;/p&gt;
&lt;p&gt;这里对 &lt;code&gt;Core Text&lt;/code&gt; 绘制实现步骤进行划分，然后对每一个步骤的工作进行提取来实现不同的功能。下面区分&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;(1)&lt;/strong&gt;&lt;code&gt;FYEvolveDisplay&lt;/code&gt;：显示类，用于在富文本实际绘制，排版的图片的图片实现填充和图片及链接文本点击操作监听；&lt;br&gt;&lt;strong&gt;(2)&lt;/strong&gt;&lt;code&gt;FYFrameParser&lt;/code&gt;：排版类，对需要排版的内容加载解析，然后生成排版；&lt;br&gt;&lt;strong&gt;(3)&lt;/strong&gt;&lt;code&gt;FYFrameParseConfig&lt;/code&gt;：配置类，在排版绘制中文字基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(4)&lt;/strong&gt;&lt;code&gt;FYCoreTextData&lt;/code&gt;：模型类，作为实际绘制中数据显示承载体；&lt;br&gt;&lt;strong&gt;(5)&lt;/strong&gt;&lt;code&gt;FYCoreTextImageData&lt;/code&gt;：图片配置类，在排版绘制中图片基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(6)&lt;/strong&gt;&lt;code&gt;FYCoreTextLinkData&lt;/code&gt;：链接文本配置类，在排版绘制中链接文字基本参数的 &lt;code&gt;model&lt;/code&gt; 配置参数；&lt;br&gt;&lt;strong&gt;(7)&lt;/strong&gt;&lt;code&gt;FYCoreTextLinkUtilts&lt;/code&gt;：链接文本工具类，在 &lt;code&gt;FYEvolveDisplay&lt;/code&gt; 点击中查找判断当前点击在在具体哪个链接文字。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;下面按照（1）数据加载解析生成显示承载 –&amp;gt; （2）然后在绘制  –&amp;gt; （3）最后在点击相应步骤来贴出相关代码段&lt;/strong&gt;&lt;/p&gt;
&lt;h4 id=&quot;数据解析&quot;&gt;&lt;a href=&quot;#数据解析&quot; class=&quot;headerlink&quot; title=&quot;数据解析&quot;&gt;&lt;/a&gt;数据解析&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYFrameParser&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextData *)parseLocalImageTemplateFile:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)path config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *imageArray = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; array];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *linkArray = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; array];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//解析数据模板&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *imageTemplateAttrib  = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; loadLocalTemplateFile:path config:config imageArray:imageArray linkArray:linkArray];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//根据配置信息生成显示载体&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextData *coreTextData = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributeContent:imageTemplateAttrib config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.imageArray = imageArray;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.linkArray = linkArray;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; coreTextData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)loadLocalTemplateFile:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       config:(FYFrameParserConfig *)config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                   imageArray:(&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *)imageArray&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                    linkArray:(&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *)linkArray &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSData&lt;/span&gt; *data = [&lt;span class=&quot;built_in&quot;&gt;NSData&lt;/span&gt; dataWithContentsOfFile:path];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; *mutableAttrib = [[&lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (data) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *templateArray = [&lt;span class=&quot;built_in&quot;&gt;NSJSONSerialization&lt;/span&gt; JSONObjectWithData:data options:&lt;span class=&quot;built_in&quot;&gt;NSJSONReadingAllowFragments&lt;/span&gt; error:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([templateArray isKindOfClass: [&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *dic &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; templateArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *typeDic = dic[&lt;span class=&quot;string&quot;&gt;@&quot;type&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([typeDic isEqualToString: &lt;span class=&quot;string&quot;&gt;@&quot;txt&quot;&lt;/span&gt;]) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser text data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *textAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributedContentFormDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:textAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([typeDic isEqualToString: &lt;span class=&quot;string&quot;&gt;@&quot;img&quot;&lt;/span&gt;]) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser image data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *imageAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseImageDataFromDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:imageAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    FYCoreTextImageData *imageData = [[FYCoreTextImageData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.name = dic[&lt;span class=&quot;string&quot;&gt;@&quot;name&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.url = dic[&lt;span class=&quot;string&quot;&gt;@&quot;url&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    imageData.position = mutableAttrib.length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [imageArray addObject:imageData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;([typeDic isEqualToString:&lt;span class=&quot;string&quot;&gt;@&quot;link&quot;&lt;/span&gt;])&amp;#123;&lt;span class=&quot;comment&quot;&gt;//parser link text data&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; startLoc = mutableAttrib.length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *linkAttrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; parseAttributedContentFormDictionary:dic config:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [mutableAttrib appendAttributedString:linkAttrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    FYCoreTextLinkData *linkData = [[FYCoreTextLinkData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; len = mutableAttrib.length - startLoc;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(startLoc, len);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.range = range;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.title = dic[&lt;span class=&quot;string&quot;&gt;@&quot;content&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    linkData.url = dic[&lt;span class=&quot;string&quot;&gt;@&quot;url&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    [linkArray addObject:linkData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; mutableAttrib;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)parseAttributedContentFormDictionary:(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)dict config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableDictionary&lt;/span&gt; *attribDic = [[&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attributesWithConfig:config] mutableCopy];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Color&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; *color = [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; colorFromHexString:dict[&lt;span class=&quot;string&quot;&gt;@&quot;color&quot;&lt;/span&gt;]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (color) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        attribDic[(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTForegroundColorAttributeName] = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)color.CGColor;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Size&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; fontSize = [dict[&lt;span class=&quot;string&quot;&gt;@&quot;size&quot;&lt;/span&gt;] floatValue];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (fontSize &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTFontRef fontRef = CTFontCreateWithName((&lt;span class=&quot;built_in&quot;&gt;CFStringRef&lt;/span&gt;)&lt;span class=&quot;string&quot;&gt;@&quot;ArialMT&quot;&lt;/span&gt;, fontSize, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        attribDic[(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTFontAttributeName] = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)fontRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(fontRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *content = dict[&lt;span class=&quot;string&quot;&gt;@&quot;content&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [[&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; alloc] initWithString:content attributes:attribDic];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)parseImageDataFromDictionary:(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)dict&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTRunDelegateCallbacks callbacks;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    memset(&amp;amp;callbacks, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;sizeof&lt;/span&gt;(CTRunDelegateCallbacks));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.version = kCTRunDelegateVersion1;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getAscent = ascentCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getDescent = descentCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    callbacks.getWidth = widthCallback;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTRunDelegateRef delegateRef = CTRunDelegateCreate(&amp;amp;callbacks, (__bridge &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)(dict));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unichar&lt;/span&gt; objectReplaceChar = &lt;span class=&quot;number&quot;&gt;0xFFCC&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *conetnt = [&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; stringWithCharacters:&amp;amp;objectReplaceChar length:&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrib = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attributesWithConfig:config];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; *space = [[&lt;span class=&quot;built_in&quot;&gt;NSMutableAttributedString&lt;/span&gt; alloc] initWithString:conetnt attributes:attrib];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFAttributedStringSetAttribute&lt;/span&gt;((&lt;span class=&quot;built_in&quot;&gt;CFMutableAttributedStringRef&lt;/span&gt;)space, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), kCTRunDelegateAttributeName, delegateRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(delegateRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; space;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextData *)parseAttributeContent:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)attribContent config:(FYFrameParserConfig *)config &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((&lt;span class=&quot;built_in&quot;&gt;CFAttributedStringRef&lt;/span&gt;) attribContent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//绘制高度&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; restrictSize = &lt;span class=&quot;built_in&quot;&gt;CGSizeMake&lt;/span&gt;(config.width, &lt;span class=&quot;built_in&quot;&gt;CGFLOAT_MAX&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(frameSetter, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;, restrictSize, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; textHeight = coreTextSize.height;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//生成 CTFrameRef&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; createFrameRefWithFrameSetter:frameSetter config:config height:textHeight];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextData *coreTextData = [[FYCoreTextData alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.ctFrame = frameRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    coreTextData.height = textHeight;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(frameSetter);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; coreTextData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 6&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (CTFrameRef)createFrameRefWithFrameSetter:(CTFramesetterRef)frameSetterref&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     config:(FYFrameParserConfig *)config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     height:(&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt;)height &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGMutablePathRef&lt;/span&gt; path = &lt;span class=&quot;built_in&quot;&gt;CGPathCreateMutable&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPathAddRect&lt;/span&gt;(path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, config.width, height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = CTFramesetterCreateFrame(frameSetterref, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), path, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(path);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; frameRef;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;上面是模拟网络请求数据模板加载本地模板生成显示载体（即画布）过程。&lt;br&gt;&lt;strong&gt;Step 1：&lt;/strong&gt; 由 &lt;code&gt;Step 2&lt;/code&gt; 加载本地模拟数据，然后由 &lt;code&gt;Step 5&lt;/code&gt; 来计算绘制画布的区域和路径生成对应画布交给模型类在自定义的 &lt;code&gt;UIKit&lt;/code&gt; 控件 &lt;code&gt;drawRect:&lt;/code&gt; 完成绘制；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt; 获取本地的数据然后解码，遍历其中数据内容解析对应 &lt;code&gt;Text&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;LinkText&lt;/code&gt; 数据。&lt;strong&gt;如果是 &lt;code&gt;Text&lt;/code&gt; 类型由 &lt;code&gt;Step 3&lt;/code&gt; 来根据内容配置来生成对应的 &lt;code&gt;NSAttributedString&lt;/code&gt; 数据，如果是 &lt;code&gt;Image&lt;/code&gt; 类型就交由 &lt;code&gt;Step 4&lt;/code&gt; 临时填充单个字符串并且通过 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 来在运行时设置当前上下缩进，如果是 &lt;code&gt;LinkText&lt;/code&gt; 类型的数据还是由 &lt;code&gt;Step 3&lt;/code&gt; 来完成处理，但是记录当前 &lt;code&gt;NSAttributedString&lt;/code&gt; 的 &lt;code&gt;Start Index&lt;/code&gt; 和 &lt;code&gt;End Index&lt;/code&gt; 位置&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;此步骤是解析 &lt;code&gt;Text&lt;/code&gt; 类型的数据，根据设置的 &lt;code&gt;FYFrameConfig&lt;/code&gt; 配置的基础信息对数据进行解析生成对应 &lt;code&gt;NSAttributedString&lt;/code&gt; 类型的数据；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;此步骤是对 &lt;code&gt;Image&lt;/code&gt; 类型的数据类型对应的 &lt;code&gt;CTRunRef&lt;/code&gt; 进行临时赋值一个字符，然后通过 &lt;code&gt;CTRunDelegateCallbacks&lt;/code&gt; 来设置 &lt;code&gt;Run&lt;/code&gt;（块）在实际绘制时 &lt;code&gt;Ascent&lt;/code&gt;（排版上升） 和 &lt;code&gt;Descent&lt;/code&gt;（排版下降）间距以此来作为图片绘制时的高度。&lt;strong&gt;然后在实际绘制过程中遍历当前 &lt;code&gt;Run&lt;/code&gt;(块) 计算当前 &lt;code&gt;Image&lt;/code&gt; 绘制的区域，获取图片后采用 &lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImage)&lt;/code&gt; 绘制当前图片&lt;/strong&gt;；&lt;br&gt;&lt;strong&gt;Step 5：&lt;/strong&gt;通过 &lt;code&gt;NSAttributedString&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt; 画布工厂，计算当前需要绘制内容高度由 &lt;code&gt;Step 6&lt;/code&gt; 来生成 &lt;code&gt;CTFrameRef&lt;/code&gt;（画布）然后赋值给 &lt;code&gt;FYCoreTextData&lt;/code&gt; 模型类画布；&lt;br&gt;&lt;strong&gt;Step 6：&lt;/strong&gt; 利用最小单元中通过设置路径使用 &lt;code&gt;CFFramesetterRef&lt;/code&gt;（绘制🏭）来生成对应需要排版的 &lt;code&gt;CTFrameRef&lt;/code&gt;（画布）。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实际绘制&quot;&gt;&lt;a href=&quot;#实际绘制&quot; class=&quot;headerlink&quot; title=&quot;实际绘制&quot;&gt;&lt;/a&gt;实际绘制&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYEvolveDisplayView&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawRect:(&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)rect &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; drawRect:rect];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; contextRef = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSetTextMatrix&lt;/span&gt;(contextRef, &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformIdentity&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextTranslateCTM&lt;/span&gt;(contextRef, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextScaleCTM&lt;/span&gt;(contextRef, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTFrameDraw(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.ctFrame, contextRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextImageData *imageData &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.imageArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = [&lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; imageNamed:imageData.name];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (image) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//CGRect rect = imageData.imageRect;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//NSLog(@&quot;image data rect in display view: x:%f y:%f height:%f width:%f&quot;, rect.origin.x, rect.origin.y, rect.size.height, rect.size.width);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextDrawImage&lt;/span&gt;(contextRef, imageData.imageRect, image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYCoreTextData&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)fillReplaceCharWithImagePosition &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray.count == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *lines = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTFrameGetLines(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; lineCount = lines.count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; lineOrigins[lineCount];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameGetLineOrigins(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), lineOrigins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; imgIndex = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextImageData *imageData = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; lineCount; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (imageData == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTLineRef lineRef = (__bridge CTLineRef)lines[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *runsArray = (&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)CTLineGetGlyphRuns(lineRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; runObj &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; runsArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunRef runRef = (__bridge CTRunRef)runObj;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *runAttribs = (&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *)CTRunGetAttributes(runRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunDelegateRef delegate = (__bridge CTRunDelegateRef)[runAttribs valueForKey:(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)kCTRunDelegateAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (delegate == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *metaDic = CTRunDelegateGetRefCon(delegate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (![metaDic isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.size.width = CTRunGetTypographicBounds(runRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.size.height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; xOffset = CTLineGetOffsetForStringIndex(lineRef, CTRunGetStringRange(runRef).location, &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.x = lineOrigins[i].x + xOffset;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.y = lineOrigins[i].y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runBounds.origin.y -= descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPathRef&lt;/span&gt; pathRef = CTFrameGetPath(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ctFrame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; colRect = &lt;span class=&quot;built_in&quot;&gt;CGPathGetBoundingBox&lt;/span&gt;(pathRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; delegateRect = &lt;span class=&quot;built_in&quot;&gt;CGRectOffset&lt;/span&gt;(runBounds, colRect.origin.x, colRect.origin.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            imageData.imageRect = delegateRect;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            imgIndex++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(imgIndex == &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray.count) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                imageData = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                imageData = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.imageArray[imgIndex];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&amp;gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;上面是在 &lt;code&gt;FYEvolveDisplayView&lt;/code&gt; 中 &lt;code&gt;drawRect:&lt;/code&gt; 采用 &lt;code&gt;CTFrameDraw(CTFrameRef, CGContext)&lt;/code&gt; 绘制在 &lt;code&gt;UIView&lt;/code&gt; 上，然后从 &lt;code&gt;FYCoreTextData&lt;/code&gt; 中逐个绘制 &lt;code&gt;FYCoreTextImageData&lt;/code&gt; 取出在 &lt;strong&gt;&lt;code&gt;Step 2&lt;/code&gt;&lt;/strong&gt; 计算当前 &lt;code&gt;Image&lt;/code&gt; 对一个的区域。然后使用 &lt;code&gt;CGContextDrawImage(CGContext, CGRect, CGImageRef)&lt;/code&gt; 绘制；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;这里在上文中有展示。主要一点：&lt;code&gt;CTFrameRef&lt;/code&gt; 获取 &lt;code&gt;Line&lt;/code&gt; 每行，然后在遍历每行的 &lt;code&gt;Run&lt;/code&gt;（块）判断其 &lt;code&gt;CTRunDelegateRef&lt;/code&gt; 对应的协议计算当前 &lt;code&gt;Image&lt;/code&gt; 对应的区域。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;图片和链接文字点击&quot;&gt;&lt;a href=&quot;#图片和链接文字点击&quot; class=&quot;headerlink&quot; title=&quot;图片和链接文字点击&quot;&gt;&lt;/a&gt;图片和链接文字点击&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYEvolveDisplayView&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (instancetype)initWithCoder:(&lt;span class=&quot;built_in&quot;&gt;NSCoder&lt;/span&gt; *)aDecoder &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; = [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; initWithCoder:aDecoder];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; deployGestureRecognizer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)clickComposeImageInDisplayView:(&lt;span class=&quot;built_in&quot;&gt;UIGestureRecognizer&lt;/span&gt; *)recognizer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; point = [recognizer locationInView:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextImageData *imageData &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData.imageArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; imageRect = imageData.imageRect;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; imagePosCoreText = imageRect.origin;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//转换 `Core Text`（左下）坐标到 `UIKit`（左上）坐标&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        imagePosCoreText.y = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size.height - imagePosCoreText.y - imageRect.size.height;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; rectInScreen = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(imagePosCoreText.x, imagePosCoreText.y, imageRect.size.width, imageRect.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;CGRectContainsPoint&lt;/span&gt;(rectInScreen, point)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;Click image of name: %@ url: %@&quot;&lt;/span&gt;, imageData.name, imageData.url);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextLinkData *linkData = [FYCoreTextLinkUtils touchLinkTextInDisplayView:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; atPoint:point data:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.coreTextData];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (linkData) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;Click Link Text. The title is: %@, The Url is %@&quot;&lt;/span&gt;, linkData.title, linkData.url);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;UIGestureRecognizer&lt;/span&gt; *)tapGestureRecognizer &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_tapGestureRecognizer == &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _tapGestureRecognizer = [[&lt;span class=&quot;built_in&quot;&gt;UITapGestureRecognizer&lt;/span&gt; alloc] initWithTarget:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; action:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(clickComposeImageInDisplayView:)];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _tapGestureRecognizer.delegate = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _tapGestureRecognizer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//FYCoreTextLinkUtils&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextLinkData *)touchLinkTextInDisplayView:(&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; *)view atPoint:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point data:(FYCoreTextData *)textData &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameRef frameRef = textData.ctFrame;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; lines = CTFrameGetLines(frameRef);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!lines) &amp;#123; &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; count = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetCount&lt;/span&gt;(lines);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; origins[count];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    CTFrameGetLineOrigins(frameRef, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), origins);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Translateform coordinate&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGAffineTransform&lt;/span&gt; transform = &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformMakeTranslation&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, view.bounds.size.height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    transform = &lt;span class=&quot;built_in&quot;&gt;CGAffineTransformScale&lt;/span&gt;(transform, &lt;span class=&quot;number&quot;&gt;1.0&lt;/span&gt;f, &lt;span class=&quot;number&quot;&gt;-1.0&lt;/span&gt;f);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; count; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; linePoint = origins[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTLineRef line = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(lines, i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; lineRect = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; gainLineBounds:line linePoint:linePoint];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; flippedRect = &lt;span class=&quot;built_in&quot;&gt;CGRectApplyAffineTransform&lt;/span&gt;(lineRect, transform);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;CGRectContainsPoint&lt;/span&gt;(flippedRect, point)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; relativePoint = &lt;span class=&quot;built_in&quot;&gt;CGPointMake&lt;/span&gt;(point.x - &lt;span class=&quot;built_in&quot;&gt;CGRectGetMinX&lt;/span&gt;(flippedRect), point.y - &lt;span class=&quot;built_in&quot;&gt;CGRectGetMinY&lt;/span&gt;(flippedRect));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; index = CTLineGetStringIndexForPosition(line, relativePoint);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; linkTextAtIndex:index linkArray:textData.linkArray];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (FYCoreTextLinkData *)linkTextAtIndex:(&lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt;)index linkArray:(&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *)linkArray &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FYCoreTextLinkData *linkData = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (FYCoreTextLinkData *data &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; linkArray) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSLocationInRange&lt;/span&gt;(index, data.range)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            linkData = data;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; linkData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (&lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt;)gainLineBounds:(CTLineRef)line linePoint:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; descent = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; leading = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;f;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; width = (&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt;)CTLineGetTypographicBounds(line, &amp;amp;ascent, &amp;amp;descent, &amp;amp;leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; height = ascent + descent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(point.x, point.y - descent, width, height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Step 1：&lt;/strong&gt;在当前 &lt;code&gt;FYEvoloveDisplayView&lt;/code&gt; 添加 &lt;code&gt;UITapGestureRecognizer&lt;/code&gt; 手势识别，来识别点击的位置。遍历对应 &lt;code&gt;FYCoreTextData&lt;/code&gt; 中图片 &lt;code&gt;Rect&lt;/code&gt; 来查找点击位置是否对应 &lt;code&gt;Image&lt;/code&gt;，同时执行 &lt;strong&gt;&lt;code&gt;Step 2&lt;/code&gt;&lt;/strong&gt; 来查找点击是否对应链接文字；&lt;br&gt;&lt;strong&gt;Step 2：&lt;/strong&gt;在 &lt;code&gt;CTFrameRef&lt;/code&gt; 遍历每一行由 &lt;strong&gt;&lt;code&gt;Step 4&lt;/code&gt;&lt;/strong&gt; 来获取对应行 &lt;code&gt;Rect&lt;/code&gt; 转变为 &lt;code&gt;UIKit&lt;/code&gt; 坐标，在该行 &lt;code&gt;Rect&lt;/code&gt; 在当前包含点击 &lt;code&gt;Point&lt;/code&gt; 时，在由 &lt;code&gt;Step 3&lt;/code&gt; 遍历对应输出 &lt;code&gt;FYCoreTextLinkData&lt;/code&gt; 链接文字；&lt;br&gt;&lt;strong&gt;Step 3：&lt;/strong&gt;在点击每行 &lt;code&gt;Line&lt;/code&gt; 中通过点击文字 &lt;code&gt;Line&lt;/code&gt; 中的 &lt;code&gt;Index&lt;/code&gt; 遍历链接文字对应 &lt;code&gt;Range&lt;/code&gt; 获取对应点击 &lt;code&gt;FYCoreTextLinkData&lt;/code&gt;；&lt;br&gt;&lt;strong&gt;Step 4：&lt;/strong&gt;通过当前行 &lt;code&gt;Start Point&lt;/code&gt; 然后获取当前 &lt;code&gt;Run&lt;/code&gt; 对应 &lt;code&gt;Rect&lt;/code&gt; 然后计算出对应 &lt;code&gt;Line&lt;/code&gt; 的 &lt;code&gt;Rect&lt;/code&gt;（区域）。    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;上面代码的 &lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/tree/master/Core%20Text/FYCoreText&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Demo&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;本地&quot;&gt;&lt;a href=&quot;#本地&quot; class=&quot;headerlink&quot; title=&quot;本地&quot;&gt;&lt;/a&gt;本地&lt;/h3&gt;&lt;p&gt;在本地获取图文混排的数据，具体内容绘制的以 &lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt;&lt;/strong&gt; 实现来进行讲述。这里仅仅展示 &lt;code&gt;YYText&lt;/code&gt; 的类图，然后贴出提出几个问题。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;YYText&lt;/code&gt; 类图&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kEXGjgdRqOpHb26gu%2F1877765-3650ddeb5f979ba4.png?alt=media&amp;amp;token=1a9b5b36-922b-4f0a-86ed-63cf9ddcc429&quot; alt=&quot;YYKit(类图).png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;下面主要解决一下问题&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;（1）怎么提供后台绘制的能力？&lt;br&gt;（2）怎么计算 &lt;code&gt;String&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;UIView&lt;/code&gt; 实现图文排序？&lt;br&gt;（3）怎么实现 &lt;code&gt;String&lt;/code&gt; 设置 &lt;code&gt;Text&lt;/code&gt; 各种格式设置？&lt;br&gt;（4）怎么实现具体绘制？&lt;br&gt;（5）怎么实现富文本上点击事件？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;怎么提供后台绘制的能力&quot;&gt;&lt;a href=&quot;#怎么提供后台绘制的能力&quot; class=&quot;headerlink&quot; title=&quot;怎么提供后台绘制的能力&quot;&gt;&lt;/a&gt;怎么提供后台绘制的能力&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYText&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (Class)layerClass &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 重写 TextAsyncLayer 也即是重新定义 Layer 类&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 实现对重定向&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [YYTextAsyncLayer class];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAsyncLayer 异步后台绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.willDisplay) task.willDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;_YYTextSentinel *sentinel = _sentinel;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;int32_t value = sentinel.value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^isCancelled)() = ^&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; value != sentinel.value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; opaque = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; scale = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//生成背景颜色的 CGTypeRef 类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGColorRef&lt;/span&gt; backgroundColor = (opaque &amp;amp;&amp;amp; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) ? &lt;span class=&quot;built_in&quot;&gt;CGColorRetain&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) : &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//判断当前 size 宽高 | 如果不满住条件 | 就要返回当前 Layer Contents 桥接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//实际绘制 获取获取当前绘制线程，在当前线程中绘制 | 提供取消机制，取消就展示 | 在设置的 CGContext 获取绘制 Image | 判断取消的基础上在 main thread 绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (size.width &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; || size.height &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGImageRef&lt;/span&gt; image = (__bridge_retained &lt;span class=&quot;built_in&quot;&gt;CGImageRef&lt;/span&gt;)(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (image) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(YYTextAsyncLayerGetReleaseQueue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//释放 image&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(image);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取后台配置的线程 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(YYTextAsyncLayerGetDisplayQueue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//配置 Context 上下文&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIGraphicsBeginImageContextWithOptions&lt;/span&gt;(size, opaque, scale);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opaque &amp;amp;&amp;amp; context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//将当前图形状态的 Copy 加入图形堆栈中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGContextSaveGState&lt;/span&gt;(context); &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!backgroundColor || &lt;span class=&quot;built_in&quot;&gt;CGColorGetAlpha&lt;/span&gt;(backgroundColor) &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//设置填充颜色 | 设置绘制路径 | Path 填充&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; whiteColor].CGColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width * scale, size.height * scale));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (backgroundColor) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width * scale, size.height * scale));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//从堆栈中取出设置 | 针对指针 retain +1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGContextRestoreGState&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CGColorRelease&lt;/span&gt;(backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    task.display(context, size, isCancelled);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123; &lt;span class=&quot;comment&quot;&gt;//如果取消 | 结束 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//在主线程展示回调&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetImageFromCurrentImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;dispatch_async&lt;/span&gt;(dispatch_get_main_queue(), ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isCancelled()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//如果没有取消 | 把 image -&amp;gt; contents&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//然后返回展示&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)(image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAsyncLayer 绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[_sentinel increase];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.willDisplay) task.willDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//通过 CGContext 设置当前绘制条件 | 调用 YYTextLayout 绘制 | CGContext 绘制绘制生成 Image | 展示&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIGraphicsBeginImageContextWithOptions&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetCurrentContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.opaque &amp;amp;&amp;amp; context) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    size.width *= &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    size.height *= &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contentsScale;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CGContextSaveGState&lt;/span&gt;(context); &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor || &lt;span class=&quot;built_in&quot;&gt;CGColorGetAlpha&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) &amp;lt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, [&lt;span class=&quot;built_in&quot;&gt;UIColor&lt;/span&gt; whiteColor].CGColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width, size.height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextSetFillColorWithColor&lt;/span&gt;(context, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.backgroundColor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextAddRect&lt;/span&gt;(context, &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, size.width, size.height));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGContextFillPath&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;built_in&quot;&gt;CGContextRestoreGState&lt;/span&gt;(context);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//调用展示 display 方法 | 显示展示的内容&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;task.display(context, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.bounds.size, ^&amp;#123;&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIImage&lt;/span&gt; *image = &lt;span class=&quot;built_in&quot;&gt;UIGraphicsGetImageFromCurrentImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;UIGraphicsEndImageContext&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.contents = (__bridge &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)(image.CGImage);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//把绘制的内容 生成 image 然后赋值给 content&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//调用 展示函数回调 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (task.didDisplay) task.didDisplay(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;上面贴出基于 &lt;code&gt;YYTextAsyncLayer&lt;/code&gt; 实现在 &lt;code&gt;main thread&lt;/code&gt; 和 &lt;code&gt;background thread&lt;/code&gt; 绘制代码。可以看出两者在实际绘制的核心代码是一样的，只是在实现后台异步绘制的时候添加 &lt;code&gt;cancel&lt;/code&gt; 机制。然后&lt;strong&gt;通过在 &lt;code&gt;UIGraphicsGetImageFromCurrentImageContext()&lt;/code&gt; 获取当前 &lt;code&gt;YYText&lt;/code&gt; 通过 &lt;code&gt;YYTextLayout&lt;/code&gt; 绘制之后生成对应的 &lt;code&gt;Image&lt;/code&gt; 在 &lt;code&gt;main thread&lt;/code&gt; 实现 &lt;code&gt;didDisplay&lt;/code&gt; 的回调绘制。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;计算-String、Image-和-UIView-实现图文排序&quot;&gt;&lt;a href=&quot;#计算-String、Image-和-UIView-实现图文排序&quot; class=&quot;headerlink&quot; title=&quot;计算 String、Image 和 UIView 实现图文排序&quot;&gt;&lt;/a&gt;计算 &lt;code&gt;String&lt;/code&gt;、&lt;code&gt;Image&lt;/code&gt; 和 &lt;code&gt;UIView&lt;/code&gt; 实现图文排序&lt;/h4&gt;&lt;p&gt;这里贴出在计算 &lt;code&gt;String&lt;/code&gt; 和 &lt;code&gt;Image&lt;/code&gt;，&lt;code&gt;UIView&lt;/code&gt;（附件） 在实际计算的实现类，由于代码量较大就不一一列出给出下面两个类。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/blob/master/YYKitAnalysis/YYText-master/YYText/Component/YYTextLayout.m&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;YYTextLayout&lt;/a&gt;&lt;/strong&gt;&lt;br&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/Optimize-iOS/FYDraw/blob/master/YYKitAnalysis/YYText-master/YYText/Component/YYTextLine.m&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;YYTextLine&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLayout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+ (YYTextLayout *)layoutWithContainer:(YYTextContainer *)container text:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)text range:(&lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt;)range &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Step 9.4 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Line 291&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;YYTextLine *line = [YYTextLine lineWithCTLine:ctLine position:position vertical:isVerticalForm];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLine &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)setCTLine:(_Nonnull CTLineRef)CTLine &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine != CTLine) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (CTLine) &lt;span class=&quot;built_in&quot;&gt;CFRetain&lt;/span&gt;(CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine) &lt;span class=&quot;built_in&quot;&gt;CFRelease&lt;/span&gt;(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _CTLine = CTLine;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_CTLine) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//获取当前 Line 的宽度值 || 获取当前 line 的 ascent|descent|leading&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _lineWidth = CTLineGetTypographicBounds(_CTLine, &amp;amp;_ascent, &amp;amp;_descent, &amp;amp;_leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//获取当前 Line 的 Range&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CFRange&lt;/span&gt; range = CTLineGetStringRange(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(range.location, range.length);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (CTLineGetGlyphCount(_CTLine) &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;span class=&quot;comment&quot;&gt;//Line 中字形的数量, 即 CTRun&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; runs = CTLineGetGlyphRuns(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                CTRunRef run = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(runs, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//获取第一个 run 字形 | 复制到用户提供的数据缓冲区 |&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; pos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                CTRunGetPositions(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), &amp;amp;pos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _firstGlyphPos = pos.x;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _firstGlyphPos = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _trailingWhitespaceWidth = CTLineGetTrailingWhitespaceWidth(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _lineWidth = _ascent = _descent = _leading = _firstGlyphPos = _trailingWhitespaceWidth = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            _range = &lt;span class=&quot;built_in&quot;&gt;NSMakeRange&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; reloadBounds];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)reloadBounds &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 当前行所有的 字形 | 当前字形的数量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;CFArrayRef&lt;/span&gt; runs = CTLineGetGlyphRuns(_CTLine);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; runCount = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetCount&lt;/span&gt;(runs);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (runCount == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachments = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachmentRanges = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; *attachmentRects = [&lt;span class=&quot;built_in&quot;&gt;NSMutableArray&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt; r = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; r &amp;lt; runCount; r++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        CTRunRef run = &lt;span class=&quot;built_in&quot;&gt;CFArrayGetValueAtIndex&lt;/span&gt;(runs, r);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;CFIndex&lt;/span&gt; glyphCount = CTRunGetGlyphCount(run);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (glyphCount == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//根据 run 字形块获取所在 Attributes 基本设置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs = (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)CTRunGetAttributes(run);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//获取不知道什么👻？ Attachment 可能是 UIImage|UIView|CALayer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//TODO&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        YYTextAttachment *attachment = attrs[YYTextAttachmentAttributeName];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attachment) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt; runPosition = &lt;span class=&quot;built_in&quot;&gt;CGPointZero&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            CTRunGetPositions(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;), &amp;amp;runPosition);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;///判断当前 run 是否是 Attachment 然后获取当前 run 的上升、下移和缩进&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGFloat&lt;/span&gt; ascent, descent, leading, runWidth;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CGRect&lt;/span&gt; runTypoBounds;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            runWidth = CTRunGetTypographicBounds(run, &lt;span class=&quot;built_in&quot;&gt;CFRangeMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;), &amp;amp;ascent, &amp;amp;descent, &amp;amp;leading);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_vertical) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//交换两者之间的坐标&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                YYTEXT_SWAP(runPosition.x, runPosition.y);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.y = _position.y + runPosition.y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runTypoBounds = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(_position.x + runPosition.x - descent, runPosition.y , ascent + descent, runWidth);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;// &amp;#123;x, y, width, height&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;comment&quot;&gt;//line 中 position | run 中 runWidth 和 ascent/descent&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.x += _position.x;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runPosition.y = _position.y - runPosition.y;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                runTypoBounds = &lt;span class=&quot;built_in&quot;&gt;CGRectMake&lt;/span&gt;(runPosition.x, runPosition.y - ascent, runWidth, ascent + descent);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; runRange = YYTextNSRangeFromCFRange(CTRunGetStringRange(run));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//添加附件 | 当前附件 range | 当前 line 的 rect&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachments addObject:attachment];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachmentRanges addObject:[&lt;span class=&quot;built_in&quot;&gt;NSValue&lt;/span&gt; valueWithRange:runRange]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [attachmentRects addObject:[&lt;span class=&quot;built_in&quot;&gt;NSValue&lt;/span&gt; valueWithCGRect:runTypoBounds]];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//附件复制 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachments = attachments.count ? attachments : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachmentRanges = attachmentRanges.count ? attachmentRanges : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    _attachmentRects = attachmentRects.count ? attachmentRects : &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在 &lt;code&gt;YYTextLayout&lt;/code&gt; 中调用 &lt;code&gt;YYTextLine&lt;/code&gt; 实例方式计算当前 &lt;code&gt;CTFrameRef&lt;/code&gt; 中 &lt;code&gt;Each Line&lt;/code&gt; 相关参数。&lt;br&gt;在 &lt;code&gt;YYTextLine&lt;/code&gt; 中可以看出以 &lt;code&gt;Line&lt;/code&gt; 为单位计算当前绘制参数，然后通过 &lt;strong&gt;&lt;code&gt;reloadBounds&lt;/code&gt;&lt;/strong&gt; 来遍历当前行的 &lt;code&gt;Run&lt;/code&gt; 获取在初始化 &lt;code&gt;Attachment&lt;/code&gt; 找出当前 &lt;code&gt;Line&lt;/code&gt; 中的 &lt;code&gt;UIView&lt;/code&gt;，&lt;code&gt;CALayer&lt;/code&gt; 和 &lt;code&gt;UIImage&lt;/code&gt; 来设置当前 &lt;code&gt;Attachment&lt;/code&gt; 绘制区域和范围。&lt;br&gt;&lt;strong&gt;详细信息可以参考代码注释&lt;/strong&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实现-String-设置-Text-各种格式设置&quot;&gt;&lt;a href=&quot;#实现-String-设置-Text-各种格式设置&quot; class=&quot;headerlink&quot; title=&quot;实现 String 设置 Text 各种格式设置&quot;&gt;&lt;/a&gt;实现 &lt;code&gt;String&lt;/code&gt; 设置 &lt;code&gt;Text&lt;/code&gt; 各种格式设置&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextAttribute &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//设置当前字体显示类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBackedStringAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBackedString&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBindingAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBinding&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextShadowAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextShadow&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextInnerShadowAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextInnerShadow&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextUnderlineAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextUnderline&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextStrikethroughAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextStrikethrough&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//对文字进行描边&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBackgroundBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBackgroundBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextBlockBorderAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextBlockBorder&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextAttachmentAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextAttachment&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextHighlightAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextHighlight&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; YYTextGlyphTransformAttributeName = &lt;span class=&quot;string&quot;&gt;@&quot;YYTextGlyphTransform&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//NSAttributedString+YYText&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (YYTextShadow *)yy_textInnerShadowAtIndex:(&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;)index &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; yy_attribute:YYTextInnerShadowAttributeName atIndex:index];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)yy_attribute:(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)attributeName atIndex:(&lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;)index &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!attributeName) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (index &amp;gt; &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length || &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; index == &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.length) index--;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; attribute:attributeName atIndex:index effectiveRange:&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;+ (YYTextLayout *)layoutWithContainer:(YYTextContainer *)container text:(&lt;span class=&quot;built_in&quot;&gt;NSAttributedString&lt;/span&gt; *)text range:(&lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt;)range &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (visibleRange.length &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        layout.needDrawText = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//TODO TODO &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; (^block)(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; *stop) = ^(&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *attrs, &lt;span class=&quot;built_in&quot;&gt;NSRange&lt;/span&gt; range, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; *stop) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextHighlightAttributeName]) layout.containsHighlight = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBlockBorderAttributeName]) layout.needDrawBlockBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBackgroundBorderAttributeName]) layout.needDrawBackgroundBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextShadowAttributeName] || attrs[&lt;span class=&quot;built_in&quot;&gt;NSShadowAttributeName&lt;/span&gt;]) layout.needDrawShadow = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextUnderlineAttributeName]) layout.needDrawUnderline = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextAttachmentAttributeName]) layout.needDrawAttachment = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextInnerShadowAttributeName]) layout.needDrawInnerShadow = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextStrikethroughAttributeName]) layout.needDrawStrikethrough = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (attrs[YYTextBorderAttributeName]) layout.needDrawBorder = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;在初始化 &lt;code&gt;String&lt;/code&gt; 设置字体特定的格式，然后根据提供的 &lt;code&gt;Key&lt;/code&gt; 值类型来保存在当前 &lt;code&gt;String&lt;/code&gt; 转化为 &lt;code&gt;NSAttributedString&lt;/code&gt; 类型的格式中。&lt;strong&gt;设置当前 &lt;code&gt;Line&lt;/code&gt; 所属的 &lt;code&gt;YYTextLayout&lt;/code&gt; 标记当前状态，在绘制时来执行在改 &lt;code&gt;Line&lt;/code&gt; 的 &lt;code&gt;Run&lt;/code&gt; 执行绘制（&lt;/strong&gt;后面在绘制中会讲述&lt;strong&gt;）。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;实现具体绘制？&quot;&gt;&lt;a href=&quot;#实现具体绘制？&quot; class=&quot;headerlink&quot; title=&quot;实现具体绘制？&quot;&gt;&lt;/a&gt;实现具体绘制？&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYLabel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (YYTextAsyncLayerDisplayTask *)newAsyncDisplayTask &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    task.display = ^(&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt; context, &lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt; size, &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^isCancelled)(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//Layout 绘制当前 UIView 界面&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [drawLayout drawInContext:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; size:size point:point view:view layer:layer debug:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; cancel:&lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//跟新当前的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;///当前 Label 的附件 此附件归属于 Layout 中 attachments 属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (YYTextAttachment *a &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; drawLayout.attachments) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([a.content isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; class]]) [attachmentViews addObject:a.content];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([a.content isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;CALayer&lt;/span&gt; class]]) [attachmentLayers addObject:a.content];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYTextLayout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Line 3469&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//TODO 绘制方法调用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)drawInContext:(&lt;span class=&quot;built_in&quot;&gt;CGContextRef&lt;/span&gt;)context&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 size:(&lt;span class=&quot;built_in&quot;&gt;CGSize&lt;/span&gt;)size&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                point:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)point&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 view:(&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; *)view&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                layer:(&lt;span class=&quot;built_in&quot;&gt;CALayer&lt;/span&gt; *)layer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                debug:(YYTextDebugOption *)debug&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                cancel:(&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; (^)(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;))cancel&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@autoreleasepool&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;实现富文本上点击事件&quot;&gt;&lt;a href=&quot;#实现富文本上点击事件&quot; class=&quot;headerlink&quot; title=&quot;实现富文本上点击事件&quot;&gt;&lt;/a&gt;实现富文本上点击事件&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//YYLabel &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesBegan:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_highlight || _textTapAction || _textLongPressAction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _touchBeganPoint = point;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.trackingTouch = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.swallowTouch = &lt;span class=&quot;literal&quot;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _state.touchMoved = &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//添加定时器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _startLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_highlight) [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _showHighlightAnimated:&lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesMoved:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.trackingTouch) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!_state.touchMoved) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.touchMoved) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _endLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)touchesEnded:(&lt;span class=&quot;built_in&quot;&gt;NSSet&lt;/span&gt; *)touches withEvent:(&lt;span class=&quot;built_in&quot;&gt;UIEvent&lt;/span&gt; *)event &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (_state.trackingTouch) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; _endLongPressTimer];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!_state.touchMoved &amp;amp;&amp;amp; _textTapAction) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	        _textTapAction(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, _innerText, range, rect);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TextKit Best Practices&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Introducing Text Kit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/220&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Text Layouts and Effects with Text Kit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/CoreText_Programming/Introduction/Introduction.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Core Text&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/TextFonts/Conceptual/CocoaTextArchitecture/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009459&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About the Cocoa Text System&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/TextAndWebiPhoneOS/Introduction/Introduction.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Text Handling in iOS&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/TextLayout/Concepts/LayoutManager.html#//apple_ref/doc/uid/20001805-BBCFEBHA&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;The Layout Manager&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2011/128/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Text Processing&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://cocoapods.org/pods/Graver&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Graver&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://apps.timwhitlock.info/emoji/tables/unicode#block-6c-other-additional-symbols&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Emoji Unicode Tables&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://juejin.im/entry/5922b0ef8d6d810058e760c4&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;新大陆：AsyncDisplayKit&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://pilky.me/36/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimising Autolayout&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/#more-41893&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS 保持界面流畅的技巧&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://tech.meituan.com/2017/06/09/webviewperf.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;WebView性能、体验分析与优化&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://imtangqi.com/2016/02/18/the-notes-of-learning-text-kit/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Text Kit 学习笔记&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://objccn.io/issue-5-1/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;初识 TextKit&lt;/a&gt;     &lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Core-Text-富文本编辑&quot;&gt;&lt;a href=&quot;#Core-Text-富文本编辑&quot; class=&quot;headerlink&quot; title=&quot;Core Text 富文本编辑&quot;&gt;&lt;/a&gt;Core Text 富文本编辑&lt;/h1&gt;&lt;p&gt;在 &lt;code&gt;Core Graphics&lt;/code&gt; 后面一篇文章本该对 &lt;code&gt;Core Image&lt;/code&gt; 框架进行整理，但是基于 &lt;code&gt;Core Graphics&lt;/code&gt; 的富文本编辑 &lt;code&gt;Core Text&lt;/code&gt; 框架更方便讲述。而且结合自己兴趣和好玩的程度在讲述自己对 &lt;code&gt;Texture&lt;/code&gt; 即 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 详细描述。&lt;/p&gt;
&lt;h2 id=&quot;Core-Text-结构层级&quot;&gt;&lt;a href=&quot;#Core-Text-结构层级&quot; class=&quot;headerlink&quot; title=&quot;Core Text 结构层级&quot;&gt;&lt;/a&gt;Core Text 结构层级&lt;/h2&gt;&lt;p&gt;这里小编对 &lt;code&gt;Core Text&lt;/code&gt; 在实现的层次结构上所处位置，以及在对 &lt;code&gt;UIKit&lt;/code&gt; 框架我们常见控件 &lt;code&gt;UITextFiled&lt;/code&gt;、&lt;code&gt;UITextView&lt;/code&gt; 和 &lt;code&gt;UILabel&lt;/code&gt; 具体实现基础。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kDbQuzCiS4ZyHn30r%2F-M7kE8qFvBCueh8O8d1_%2F1877765-d9fa387d512dd42d.png?alt=media&amp;amp;token=3d406869-6df1-4a7c-bcb6-6c228a9d1fce&quot; alt=&quot;Core Text.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上图是小编根据 &lt;strong&gt;2018 WWDC&lt;/strong&gt; 中 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/221/&quot;&gt;TextKit Best Practices&lt;/a&gt; 和 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2013/210&quot;&gt;Introducing Text Kit&lt;/a&gt; 得出 &lt;code&gt;Core Graphics&lt;/code&gt;、&lt;code&gt;Core Text&lt;/code&gt; 和 &lt;code&gt;UIKit&lt;/code&gt; 中能够实现文本绘制的控件实现结构图。&lt;br&gt;根据上面结构可以看出：&lt;br&gt;（1）基于 &lt;code&gt;Quartz&lt;/code&gt; 封装的 &lt;code&gt;Core Graphics&lt;/code&gt; 为 &lt;code&gt;Core Text&lt;/code&gt; 的实现基础。而且 &lt;code&gt;Quartz&lt;/code&gt; 可以直接处理字体和字形将文字渲染到界面，也是在 Apple 基础库中唯一一个处理字体模块。&lt;br&gt;（2）基于 &lt;code&gt;Core Text&lt;/code&gt; 封装实现的 &lt;code&gt;Text Kit&lt;/code&gt; 为在 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 中文本显示控件 &lt;code&gt;TypeTextFiled&lt;/code&gt;、&lt;code&gt;TypeTextView&lt;/code&gt; 等提供最直接的接口。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - Core Graphics</title>
    <link href="http://yoursite.com/2019/03/08/IOS%20UI%20%E4%BC%98%E5%8C%96%20-%20Core%20Graphics/"/>
    <id>http://yoursite.com/2019/03/08/IOS UI 优化 - Core Graphics/</id>
    <published>2019-03-08T14:07:07.579Z</published>
    <updated>2020-05-20T13:13:45.244Z</updated>
    
    <content type="html">&lt;h1 id=&quot;Core-Graphics-实现探索&quot;&gt;&lt;a href=&quot;#Core-Graphics-实现探索&quot; class=&quot;headerlink&quot; title=&quot;Core Graphics 实现探索&quot;&gt;&lt;/a&gt;Core Graphics 实现探索&lt;/h1&gt;&lt;p&gt;又是一个常用但是不知怎么开篇博文。🤔🤔🤔&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Core Graphics&lt;/code&gt; 在 &lt;code&gt;iOS&lt;/code&gt; 整个架构的层次结构可以和上篇 &lt;code&gt;Core Animation&lt;/code&gt; 实现，这里仅仅展示 &lt;code&gt;Core Graphics&lt;/code&gt; 实现的基础实现架构。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kD55cdBlRKqbyxwvK%2F-M7kDLWE3usJFGTpiN-L%2F1877765-33be471164252941.png?alt=media&amp;amp;token=aab36ea8-f7ee-45b0-ab38-e2b81a42c908&quot; alt=&quot;Core Graphics.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;在讲解 &lt;code&gt;Core Graphics&lt;/code&gt; 之前还是按照小编的🍉惯，对该框架 &lt;code&gt;API&lt;/code&gt; 的接口进行整理。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kD55cdBlRKqbyxwvK%2F-M7kDV4DmXj8KDHjEHYx%2F1877765-156381bdec28dba6.png?alt=media&amp;amp;token=d89c6f0b-1eb0-4ed0-a2a3-cb4fb23f903c&quot; alt=&quot;屏幕快照 2019-03-16 20.43.18.png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;作为基于 &lt;a href=&quot;https://zh.wikipedia.org/wiki/Quartz&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Quartz&lt;/a&gt; 的框架，上面 👆 的 &lt;code&gt;API&lt;/code&gt; 类型 &lt;code&gt;CGType&lt;/code&gt; 在 &lt;code&gt;C&lt;/code&gt; 层面的绘图引擎。主要在上面 &lt;code&gt;Core Animation 探索&lt;/code&gt; 中验证过程中位置参数、颜色值、路径以及图像等等方面……&lt;br&gt;讲真这个框架不知道怎么开笔，就按照上面 &lt;code&gt;API&lt;/code&gt; 来各个阐述自己理解吧。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Geometric-Data-Type&quot;&gt;&lt;a href=&quot;#Geometric-Data-Type&quot; class=&quot;headerlink&quot; title=&quot;Geometric Data Type&quot;&gt;&lt;/a&gt;Geometric Data Type&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;集合数据类型&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGFloat&lt;/code&gt;（单精度浮点型）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型的数据。&lt;code&gt;iOS&lt;/code&gt; 中采用宏来进行定义，&lt;code&gt;Swift&lt;/code&gt; 采用最长用的 &lt;code&gt;Struct&lt;/code&gt; 来实现。 32 位 &lt;code&gt;CPU&lt;/code&gt; 占 4 个字节，64 位 &lt;code&gt;CPU&lt;/code&gt; 占 8 个字节。&lt;strong&gt;2、&lt;/strong&gt; 在 &lt;code&gt;iOS&lt;/code&gt; 开发过程中关于位置，宽高的参数均是采用此值类型。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGPoint&lt;/code&gt;（二维坐标位置）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型的点。点的基本参数 x, y 均是 &lt;code&gt;CGFloat&lt;/code&gt; 值类型参数。&lt;strong&gt;2、&lt;/strong&gt; 二维坐标中来确定控件位置布局中中心点、锚点等。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGSize&lt;/code&gt;（控件大小）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型的尺寸。尺寸同样是基本值类型参数 &lt;code&gt;width&lt;/code&gt; &amp;amp; &lt;code&gt;height&lt;/code&gt;。&lt;strong&gt;2、&lt;/strong&gt; 坐标中来基于当前控件在基于右上角、右下角或者是中心点控制点三者来确定控件的位置。可以根据在 &lt;code&gt;Layer&lt;/code&gt; 确定布局时验证中心点然后确定 &lt;code&gt;Size&lt;/code&gt; 的参数可知。&lt;strong&gt;可以参考上一篇文章 Core Animation&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGRect&lt;/code&gt;（控件位置）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型的区域。区域的基本值类型参数 &lt;code&gt;Point&lt;/code&gt; &amp;amp; &lt;code&gt;Size&lt;/code&gt;。&lt;strong&gt;2、&lt;/strong&gt; 是根据 &lt;code&gt;iOS&lt;/code&gt; 中右上角为坐标系根据初始化控件右上角参数类确定控件位置。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGVector&lt;/code&gt;（二维向量坐标）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型向量中偏移。偏移的参数 dx, dy 也均是 &lt;code&gt;CGFloat&lt;/code&gt; 值类型参数。&lt;strong&gt;2、&lt;/strong&gt; 基于 &lt;code&gt;SceneKit&lt;/code&gt; 的 &lt;code&gt;iOS&lt;/code&gt; 开发引擎来做刚体位置偏转。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGAffineTransform&lt;/code&gt;（二维仿射变换）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示值类型仿射变换矩阵。矩阵参数 a, b, c, d, tx 和 ty 均为 &lt;code&gt;Float&lt;/code&gt; 值类型。&lt;strong&gt;2、&lt;/strong&gt; &lt;code&gt;UIKit&lt;/code&gt; 中基于 &lt;code&gt;UIView&lt;/code&gt; 控件均有此参数，可以实现控件偏移，旋转，缩放或者倾斜。&lt;strong&gt;微信读书控件斜向动画&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;注：上述没有详细讲述其均为 &lt;code&gt;Struct&lt;/code&gt; 值类型结构&lt;/p&gt;
&lt;h3 id=&quot;CGAffineTransform-使用&quot;&gt;&lt;a href=&quot;#CGAffineTransform-使用&quot; class=&quot;headerlink&quot; title=&quot;CGAffineTransform 使用&quot;&gt;&lt;/a&gt;CGAffineTransform 使用&lt;/h3&gt;&lt;p&gt;在 &lt;code&gt;CGAffineTransform&lt;/code&gt; 初始化仿射变换初始化中显示 &lt;code&gt;CGAffineTransform.init(a: , b: , c: , d: , tx: , ty: )&lt;/code&gt; 来作为 &lt;strong&gt;3*3&lt;/strong&gt; 的矩阵。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7m7I-gpIe6G1W653KZ%2F-M7mCs6rbjLXuA4DGrzT%2F1877765-1f9cff8b51261139.png?alt=media&amp;amp;token=b589ad9c-ee9f-432b-8c45-4d831bf96b84&quot; alt=&quot;屏幕快照 2019-04-03 23.22.54.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上面根据在仿射变换后坐标:&lt;br&gt;X 轴上的坐标 &lt;strong&gt;X`= ax + cy + tx&lt;/strong&gt;, a 表示在 x 轴的缩放比例系数，c 表示在 y 轴偏移系数在旋转时使用， tx 是在当前坐标系的平移距离。     &lt;/p&gt;
&lt;p&gt;Y 轴上的坐标 &lt;strong&gt;Y`= bx + dy + ty&lt;/strong&gt;, b 表示在 y 轴的缩放比例系数，d 表示在 x 轴偏移系数在旋转时使用， ty 是在当前坐标系的平移距离。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;所以下面的方式实现是 &lt;code&gt;==&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;swift&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormTenPixel1 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(a: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, b: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;c&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, d: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, tx: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, ty: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)
&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormTenPiexl2 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(translationX: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;, y: &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;)

&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormScaleTimes1 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(a: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, b: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;c&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, d: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, tx: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, ty: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)
&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormScaleTimes2 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(scaleX: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, y: &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)

&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; angle = &lt;span class=&quot;type&quot;&gt;Double&lt;/span&gt;.pi * &lt;span class=&quot;number&quot;&gt;0.3&lt;/span&gt;
&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormRotationAngle1 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(a: cos(angle), b: sin(angle), &lt;span class=&quot;built_in&quot;&gt;c&lt;/span&gt;: -sin(angle), d: cos(angle), tx: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, ty: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)
&lt;span class=&quot;keyword&quot;&gt;let&lt;/span&gt; transFormRotationAngle1 = &lt;span class=&quot;type&quot;&gt;CGAffineTransform&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;init&lt;/span&gt;(rotationAngle: angle)
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;2D-Drawing&quot;&gt;&lt;a href=&quot;#2D-Drawing&quot; class=&quot;headerlink&quot; title=&quot;2D Drawing&quot;&gt;&lt;/a&gt;2D Drawing&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;二维绘制&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用的优劣&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGContext&lt;/code&gt;（绘制渲染上下文）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示调用 &lt;code&gt;Core Graphics&lt;/code&gt; 绘制上下文。&lt;strong&gt;2、&lt;/strong&gt; 在绘制过程中获取上下文 &lt;code&gt;Context&lt;/code&gt; 在 &lt;code&gt;Main Thread&lt;/code&gt; 中总是会回去 &lt;code&gt;UIKit&lt;/code&gt; 堆栈的最上面，在后台线程可以获取当前上下文。根据获取上下文的绘制目的可以实现：&lt;code&gt;PDF&lt;/code&gt;、&lt;code&gt;Bitmap&lt;/code&gt;、&lt;code&gt;Window&lt;/code&gt;、&lt;code&gt;Layer&lt;/code&gt;、和 &lt;code&gt;Printer&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGImage&lt;/code&gt;（位图）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示位图或者是位图的 &lt;code&gt;Mask&lt;/code&gt;。&lt;strong&gt;2、&lt;/strong&gt; 在 &lt;code&gt;UIKit&lt;/code&gt; 中 &lt;code&gt;UIImage&lt;/code&gt; 对应的 &lt;code&gt;CGType&lt;/code&gt; 类型，当前我们绘制或者对图片进行截取后便是此类型。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGPath&lt;/code&gt;（路径）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示绘制过程中绘制 &lt;code&gt;Path&lt;/code&gt;。&lt;strong&gt;2、&lt;/strong&gt; 同样是对应在 &lt;code&gt;UIKit&lt;/code&gt; 中对应 &lt;code&gt;UIBerizerPath&lt;/code&gt; 的 &lt;code&gt;CGType&lt;/code&gt; 对应类型。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGMutablePath&lt;/code&gt;（可变路径）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示路径的可变类型。&lt;strong&gt;2、&lt;/strong&gt; &lt;code&gt;CGPath&lt;/code&gt; 的可变类型结构。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGLayer&lt;/code&gt;（绘制渲染屏幕外图形绘制画布内容）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在绘制渲染中依托的实际绘制画布。&lt;strong&gt;2、&lt;/strong&gt; 类似于在 &lt;code&gt;Core Aniation&lt;/code&gt; 中 &lt;code&gt;CALayer&lt;/code&gt; 作用效果，是绘制渲染上下文实际绘制载体。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;注：上述没有详细讲述其均为 &lt;code&gt;Struct&lt;/code&gt; 值类型结构&lt;/p&gt;
&lt;h2 id=&quot;Colors-Font&quot;&gt;&lt;a href=&quot;#Colors-Font&quot; class=&quot;headerlink&quot; title=&quot;Colors | Font&quot;&gt;&lt;/a&gt;Colors | Font&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;色彩字体&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGColor&lt;/code&gt;（颜色值）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示颜色值。 &lt;strong&gt;2、&lt;/strong&gt; 对应在 &lt;code&gt;UIKit&lt;/code&gt; 中 &lt;code&gt;UIColor&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGColorConversionInfo&lt;/code&gt;（色彩转换）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示色彩多空间转换。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGColorSpace&lt;/code&gt;（显示颜色值表达格式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示颜色值在储存中表达格式。 &lt;strong&gt;2、&lt;/strong&gt; 在 &lt;code&gt;iOS&lt;/code&gt; 可以采用的格式有：&lt;code&gt;HSB&lt;/code&gt;: &lt;code&gt;Hue, saturation, brightness&lt;/code&gt;、&lt;code&gt;RGB&lt;/code&gt;： &lt;code&gt;Red, green, blue&lt;/code&gt;、&lt;code&gt;CMYK&lt;/code&gt;： &lt;code&gt;Cyan, magenta, yellow, black&lt;/code&gt;和&lt;code&gt;BGR&lt;/code&gt;： &lt;code&gt;Blue, green, red&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGFont&lt;/code&gt;（绘制文本信息）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示绘制文本详细信息。 &lt;strong&gt;2、&lt;/strong&gt; 在文本绘制过程中对应当前字体格式值，对用在 &lt;code&gt;Core Animation&lt;/code&gt; 中 &lt;code&gt;UIFont&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;注：上述没有详细讲述其均为 &lt;code&gt;Struct&lt;/code&gt; 值类型结构&lt;/p&gt;
&lt;h2 id=&quot;Working-with-PDF-Decument&quot;&gt;&lt;a href=&quot;#Working-with-PDF-Decument&quot; class=&quot;headerlink&quot; title=&quot;Working with PDF Decument&quot;&gt;&lt;/a&gt;Working with PDF Decument&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;色彩字体&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGPDFDocument&lt;/code&gt;（）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 。 &lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CATransaction&lt;/code&gt;（）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Utility-Support-Classes&quot;&gt;&lt;a href=&quot;#Utility-Support-Classes&quot; class=&quot;headerlink&quot; title=&quot;Utility | Support Classes&quot;&gt;&lt;/a&gt;Utility | Support Classes&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;多用途以及支持类&lt;/th&gt;
&lt;th&gt;表示 &amp;amp; 使用范围&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGDataConsumer&lt;/code&gt;（）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 。 &lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGDataProvider&lt;/code&gt;（）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 。 &lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGShading&lt;/code&gt;（阴影）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示设置阴影详细信息。 &lt;strong&gt;2、&lt;/strong&gt; 对应 &lt;code&gt;UIKit&lt;/code&gt; 中 &lt;code&gt;Layer&lt;/code&gt; 层中 &lt;code&gt;Shadow&lt;/code&gt; 属性来设置控件的阴影值。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGGradient&lt;/code&gt;（颜色渐变）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示设置过渡色彩接口。 &lt;strong&gt;2、&lt;/strong&gt; 对应在 &lt;code&gt;CAGradientLayer&lt;/code&gt; 来实现颜色的效果过渡。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGFunction&lt;/code&gt;（协助工具）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示在 &lt;code&gt;CGType&lt;/code&gt; 方法中基础事件回调。 &lt;strong&gt;2、&lt;/strong&gt; 提供事件的基础回调类似与我们在方法定义的 &lt;code&gt;Block&lt;/code&gt; 实现。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;CGPattern&lt;/code&gt;（模式）&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;1、&lt;/strong&gt; 表示绘制 &lt;code&gt;2D&lt;/code&gt; 模型的一种模式。 &lt;strong&gt;2、&lt;/strong&gt; 。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;此篇博文先停停…. 讲真真心没有思路。。。。&lt;/p&gt;
&lt;p&gt;未完待续。。。&lt;/p&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;https://objccn.io/issue-3-1/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;绘制像素到屏幕上&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007533-SW1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Quartz 2D Programming Guide&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_overview/dq_overview.html#//apple_ref/doc/uid/TP30001066-CH202-TPXREF101&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Overview of Quartz 2D&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/coregraphics&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Core Graphics&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.bignerdranch.com/blog/core-graphics-part-1-in-the-beginning/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Core Graphics, Part 1: In the Beginning&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.bignerdranch.com/blog/core-graphics-part-2-contextually-speaking/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Core Graphics, Part 2: Contextually Speaking&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://www.raywenderlich.com/232990-core-graphics-tutorial-patterns&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Core Graphics Tutorial: Patterns&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2012/506/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimizing 2D Graphics and Animation Performance&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2014/419/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Graphics and Animations for iOS Apps&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2017/235/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Building Visually Rich User Experiences&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/219/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Image and Graphics Best Practices&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2011/129/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Practical Drawing for iOS Developers&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Core-Graphics-实现探索&quot;&gt;&lt;a href=&quot;#Core-Graphics-实现探索&quot; class=&quot;headerlink&quot; title=&quot;Core Graphics 实现探索&quot;&gt;&lt;/a&gt;Core Graphics 实现探索&lt;/h1&gt;&lt;p&gt;又是一个常用但是不知怎么开篇博文。🤔🤔🤔&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Core Graphics&lt;/code&gt; 在 &lt;code&gt;iOS&lt;/code&gt; 整个架构的层次结构可以和上篇 &lt;code&gt;Core Animation&lt;/code&gt; 实现，这里仅仅展示 &lt;code&gt;Core Graphics&lt;/code&gt; 实现的基础实现架构。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kD55cdBlRKqbyxwvK%2F-M7kDLWE3usJFGTpiN-L%2F1877765-33be471164252941.png?alt=media&amp;amp;token=aab36ea8-f7ee-45b0-ab38-e2b81a42c908&quot; alt=&quot;Core Graphics.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;在讲解 &lt;code&gt;Core Graphics&lt;/code&gt; 之前还是按照小编的🍉惯，对该框架 &lt;code&gt;API&lt;/code&gt; 的接口进行整理。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7kD55cdBlRKqbyxwvK%2F-M7kDV4DmXj8KDHjEHYx%2F1877765-156381bdec28dba6.png?alt=media&amp;amp;token=d89c6f0b-1eb0-4ed0-a2a3-cb4fb23f903c&quot; alt=&quot;屏幕快照 2019-03-16 20.43.18.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - Core Animation</title>
    <link href="http://yoursite.com/2019/01/06/iOS%20UI%20%E4%BC%98%E5%8C%96%20-%20Core%20Animation%20/"/>
    <id>http://yoursite.com/2019/01/06/iOS UI 优化 - Core Animation /</id>
    <published>2019-01-06T12:39:52.865Z</published>
    <updated>2020-05-20T13:10:00.822Z</updated>
    
    <content type="html">&lt;h1 id=&quot;Core-Animation-实现探索&quot;&gt;&lt;a href=&quot;#Core-Animation-实现探索&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 实现探索&quot;&gt;&lt;/a&gt;Core Animation 实现探索&lt;/h1&gt;&lt;p&gt;小编回顾粗略的写完 19 年 想要写的系列博文中 &lt;code&gt;iOS UI&lt;/code&gt; 优化总纲中第一篇博文 &lt;code&gt;Core Animation&lt;/code&gt; 一直在想怎么样展示自己的理解，就先从我们熟知的 &lt;code&gt;Core Animation&lt;/code&gt; 在整个 &lt;code&gt;APP&lt;/code&gt; 提供架构方面来进行O对比。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k6-E548XUtcpJOExw%2F1877765-f0cb74a53c9ba8dc.png?alt=media&amp;amp;token=85da9e64-1e31-4e59-a392-e6346b786a2d&quot; alt=&quot;屏幕快照 2019-01-15 23.12.22.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注：上图分别是从 2014 年的 &lt;code&gt;WWDC&lt;/code&gt; 讲述 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2014/419/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Graphics and Animations for iOS Apps&lt;/a&gt; 中截取 和 2018 年最新描述 &lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004514-CH1-SW1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Core Animation&lt;/a&gt; 文档获取&lt;code&gt;Core Animation&lt;/code&gt; 在架构中实现。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;由上面显示具体信息我们可以得出下面结论：   &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;Core Animation&lt;/code&gt; 作为主要内容载体承接对 &lt;code&gt;iOS&lt;/code&gt; 和 &lt;code&gt;OS&lt;/code&gt; 具体显示的绘制；&lt;br&gt;2、&lt;code&gt;UIKit&lt;/code&gt; 框架从初始化到通过 &lt;code&gt;GPU&lt;/code&gt; 生成纹理显示在屏幕上是依靠 &lt;code&gt;Core Animation&lt;/code&gt;、 &lt;code&gt;Core Graphics&lt;/code&gt;、 &lt;code&gt;OpenGL ES&lt;/code&gt;(&lt;code&gt;iOS&lt;/code&gt; 11) 和 &lt;code&gt;Matel&lt;/code&gt;(&lt;code&gt;iOS&lt;/code&gt; 12)   来实现;&lt;br&gt;3、在 &lt;code&gt;iOS 8.0&lt;/code&gt; 中苹果官方尝试使用 &lt;code&gt;Metal&lt;/code&gt; 来替代 &lt;code&gt;OpenGL ES&lt;/code&gt; 在目前最新的官方文档中实现在绘制生成纹理底层架构依据 &lt;code&gt;Metal&lt;/code&gt; 进行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;想要深入了解一个架构我们就从最基本的系统 &lt;code&gt;API&lt;/code&gt; 着手，下面是小编对系统 &lt;code&gt;API&lt;/code&gt; 根据分类来对具体类的 &lt;code&gt;API&lt;/code&gt; 进行整理。 &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7k6M58rz6cyT1AO8Pv%2F1877765-3b86566386d064e4.png?alt=media&amp;amp;token=3e463096-20b5-4bb2-bb15-39ccf7c6525c&quot; alt=&quot;屏幕快照 2019-01-14 22.50.21.png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;看过上图我们首先要明白在 &lt;code&gt;Core Animation&lt;/code&gt; 不仅仅满足我们 &lt;code&gt;UIKit&lt;/code&gt; 移动端 &lt;code&gt;iOS&lt;/code&gt; 使用，而且在 &lt;code&gt;OS&lt;/code&gt; 中的 &lt;code&gt;AppKit&lt;/code&gt; 同样也是对其进行再次封装。但是这里我们仅仅讨论在 &lt;code&gt;iOS&lt;/code&gt; 平台具体实现情况。&lt;/p&gt;
&lt;p&gt;数据表格可以看出 &lt;code&gt;Core Animation&lt;/code&gt; 在 &lt;code&gt;iOS&lt;/code&gt; 架构中负责 &lt;code&gt;Layer&lt;/code&gt; 的内容绘制和动画的执行。执行绘制实现的类：&lt;code&gt;CATypeLayer&lt;/code&gt; 和 &lt;code&gt;CATypeAnimation&lt;/code&gt; 及其在实现动画实现参数例如：&lt;code&gt;Animation Group&lt;/code&gt; 和 &lt;code&gt;Animation Timing&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&quot;Core-Animation-绘制&quot;&gt;&lt;a href=&quot;#Core-Animation-绘制&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 绘制&quot;&gt;&lt;/a&gt;Core Animation 绘制&lt;/h2&gt;&lt;p&gt;细细想来我们在做应用实际上展示给用户内容，而在展示内容基础上我们多数是采用 &lt;code&gt;UIKit&lt;/code&gt; 中的继承于 &lt;code&gt;UIView&lt;/code&gt; 非线程安全的控件来做内容展示。这里我们从 &lt;code&gt;Core Animation&lt;/code&gt; 绘制开始剖析怎么实现？&lt;/p&gt;
&lt;h3 id=&quot;UIView-VS-Core-Animation&quot;&gt;&lt;a href=&quot;#UIView-VS-Core-Animation&quot; class=&quot;headerlink&quot; title=&quot;UIView VS Core Animation&quot;&gt;&lt;/a&gt;&lt;code&gt;UIView&lt;/code&gt; VS &lt;code&gt;Core Animation&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;在 &lt;code&gt;Core Aimation&lt;/code&gt; 的 &lt;code&gt;API&lt;/code&gt; 的数据表中我们可以看到 &lt;code&gt;Layer Basics&lt;/code&gt; 中有三个类分别是：&lt;code&gt;CALyer&lt;/code&gt;、&lt;code&gt;CALayerDelegate&lt;/code&gt; 和 &lt;code&gt;CAAction&lt;/code&gt;。既然 &lt;code&gt;iOS&lt;/code&gt; 中界面的初始化均是以父类 &lt;code&gt;UIView&lt;/code&gt;来实现，那么 &lt;code&gt;UIView&lt;/code&gt; 和三者有什么关系呢？&lt;/p&gt;
&lt;h4 id=&quot;UIView-和-CALayer&quot;&gt;&lt;a href=&quot;#UIView-和-CALayer&quot; class=&quot;headerlink&quot; title=&quot;UIView 和 CALayer&quot;&gt;&lt;/a&gt;&lt;code&gt;UIView&lt;/code&gt; 和 &lt;code&gt;CALayer&lt;/code&gt;&lt;/h4&gt;&lt;p&gt;&lt;code&gt;Layer&lt;/code&gt; 层作为 &lt;code&gt;Core Animation&lt;/code&gt; 主要绘制基类为 &lt;code&gt;UIKit&lt;/code&gt; 中 &lt;code&gt;View&lt;/code&gt; 提供内容绘制的容器，动画实现基础。下面通过实际例子来进行解答：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;通过实现 &lt;code&gt;LJView&lt;/code&gt; 继承 &lt;code&gt;View&lt;/code&gt; 和 &lt;code&gt;LJLayer&lt;/code&gt; 继承 &lt;code&gt;Layer&lt;/code&gt;，并且重写 &lt;code&gt;LJView&lt;/code&gt; 中的方法 &lt;code&gt;+ (Class)layerClass;&lt;/code&gt; 如下：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;+ (Class)layerClass &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;&amp;lt;%@:%p&amp;gt;(%s)&quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.class, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, __func__);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [LJLayer class];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后重写下面的方法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;LJView&lt;/code&gt; 的方法：&lt;code&gt;- (CGPoint)center;&lt;/code&gt;、&lt;code&gt;- (void)setBounds:(CGRect)bounds;&lt;/code&gt;、&lt;code&gt;- (void)setCenter:(CGPoint)center&lt;/code&gt; 和 &lt;code&gt;- (void)setFrame:(CGRect)frame;&lt;/code&gt;&lt;br&gt;2、&lt;code&gt;LJLayer&lt;/code&gt; 的方法：&lt;code&gt;- (CGPoint)position;&lt;/code&gt;、&lt;code&gt;- (void)setBounds:(CGRect)bounds;&lt;/code&gt;、&lt;code&gt;- (void)setPosition:(CGPoint)position;&lt;/code&gt;、 和 &lt;code&gt;- (void)setFrame:(CGRect)frame&lt;/code&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;初始化 &lt;code&gt;_ljView = [[LJView alloc ] init];&lt;/code&gt; 我们可以看到打印的日志如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//把 LJView 的 layer 加载 LJLayer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x10ca54190&lt;/span&gt;&amp;gt;(+[LJView layerClass])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//1、调用 View 中给定的 Frame 来创建 Layer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setBounds:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//2、创建 Layer 后通过调用栈创建 View&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView setFrame:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//3、View 回调中心点 center 实际委托给 Layer 的 position 返回当前的中心点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView center])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//4、通过上面 LJView 设置 Frame 和 Center 后，Layer 层再次重新对其 Frame、position 和 bounds 进行设置，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//这里也可以看到 Frame 其实是有 position 和 bounds 来决定&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setFrame:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setPosition:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setBounds:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//5、View 在实现布局后，再次获取其 center 再次委托与 Layer position 来获取中心点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView center])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面我们可以看出在实现 &lt;code&gt;LJView&lt;/code&gt; 在实现初始化的过程时，实际会委托给 &lt;code&gt;Layer&lt;/code&gt; 层的 &lt;code&gt;Frame&lt;/code&gt; | &lt;code&gt;Bounds&lt;/code&gt; 和 &lt;code&gt;Position&lt;/code&gt; 来进行具体实例化的过程。在实例化过程有下面几个步骤：  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;View&lt;/code&gt; 通过 &lt;code&gt;Layer&lt;/code&gt; 中的 &lt;code&gt;bounds&lt;/code&gt; 和 &lt;code&gt;position&lt;/code&gt; 来确定其的 &lt;code&gt;frame&lt;/code&gt;；&lt;br&gt;2、然后 &lt;code&gt;Layer&lt;/code&gt; 根据上面的值再次对其 &lt;code&gt;frame&lt;/code&gt;、&lt;code&gt;position&lt;/code&gt; 和 &lt;code&gt;bounds&lt;/code&gt; 进行再次设置；&lt;br&gt;3、最后 &lt;code&gt;View&lt;/code&gt; 再次委托 &lt;code&gt;Layer&lt;/code&gt; 获取当前的中心点。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;下面我们在根据每部具体操作在看下操作具体的调用栈&quot;&gt;&lt;a href=&quot;#下面我们在根据每部具体操作在看下操作具体的调用栈&quot; class=&quot;headerlink&quot; title=&quot;下面我们在根据每部具体操作在看下操作具体的调用栈&quot;&gt;&lt;/a&gt;下面我们在根据每部具体操作在看下操作具体的调用栈&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer setBounds:])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kA4g63wJEePiivGKi%2F1877765-742707ecc08ad320.png?alt=media&amp;amp;token=93794a64-9209-4efe-8b78-3c06a8cc0500&quot; alt=&quot;屏幕快照 2019-01-18 00.27.56.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始&lt;br&gt;d、[UIView _createLayerWithFrame] 根据 frame 创建 Layer&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;1、&lt;code&gt;UIView&lt;/code&gt; 初始化时创建 &lt;code&gt;Layer&lt;/code&gt; 然后调用其方法 &lt;code&gt;setBounds:&lt;/code&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJView:0x7f9ae840c220&amp;gt;(-[LJView setFrame:])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kAKqIbPttONgLlz_k%2F1877765-0dbfaf7c8ca0d82b.png?alt=media&amp;amp;token=fee435d0-d458-4dd7-9ae2-36d693af8e2f&quot; alt=&quot;屏幕快照 2019-01-18 00.28.16.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;2、&lt;code&gt;UIView&lt;/code&gt; 在初始创建 &lt;code&gt;Layer&lt;/code&gt; 后对其 &lt;code&gt;Frame&lt;/code&gt; 进行初始化调用 &lt;code&gt;setFrame:&lt;/code&gt; 方法。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJView:0x7f9ae840c220&amp;gt;(-[LJView center])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kAdu1R3SZtjJb4KPO%2F1877765-20c3b7df71a0ba52.png?alt=media&amp;amp;token=db5160bf-a307-4421-abb4-f9c059e1e8af&quot; alt=&quot;屏幕快照 2019-01-18 00.28.30.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer position])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kAruSVmEVtQ0-bXGf%2F1877765-fd919e1a0ded16b2.png?alt=media&amp;amp;token=7fb581fa-ea99-41b1-929c-a09f98cee079&quot; alt=&quot;屏幕快照 2019-01-18 00.28.52.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始&lt;br&gt;d、[LJView setFrame] 调用具体 View 设置 Parent frame 布局&lt;br&gt;e、[UIView(Geometry) setFrame]&lt;br&gt;f、[LJView center] 调用 View 中 Center 委托给 Layer 的 position&lt;br&gt;g、[LJLayer position]  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;3、这里可以看出在 2 基础上接着调用 &lt;code&gt;View&lt;/code&gt; 的 &lt;code&gt;Center&lt;/code&gt; 中心点实际是委托与 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;position&lt;/code&gt; 继续调用&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer setFrame:])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kBBZ9BeXPPWIW-6sA%2F1877765-a3d63440b2af10ff.png?alt=media&amp;amp;token=1056946c-2fbc-48a3-8e45-b3d502a542ad&quot; alt=&quot;屏幕快照 2019-01-18 00.29.11.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer setPosition:])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kBTIdkQgdRKp0k9gO%2F1877765-17fcb682fb15a931.png?alt=media&amp;amp;token=5ee78834-4af0-4925-aff4-507fbbae5fb6&quot; alt=&quot;屏幕快照 2019-01-18 00.29.27.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始&lt;br&gt;d、[LJView setFrame] 调用具体 View 设置 Parent frame 布局&lt;br&gt;e、[UIView(Geometry) setFrame] 调用系统 View 的 Frame 设置&lt;br&gt;f、[LJLayer setFrame] 调用拥有 Layer 的 Frame&lt;br&gt;g、[CALayer setFrame] 调用系统 Layer 的 Frame 设置&lt;br&gt;h、[LJLayer setPosition] 设置 Layer 的中心点&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;4、在第 2 的基础上通过设置 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;Frame&lt;/code&gt; 实际设置当前的 &lt;code&gt;position&lt;/code&gt; 中心点。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer setBounds:])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kBjwD0Nf_a0ssh5iI%2F1877765-b1166a30687d952b.png?alt=media&amp;amp;token=5feb6add-c504-4100-b647-bbe4981dc907&quot; alt=&quot;屏幕快照 2019-01-18 00.29.41.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始&lt;br&gt;d、[LJView setFrame] 调用具体 View 设置 Parent frame 布局&lt;br&gt;e、[UIView(Geometry) setFrame]&lt;br&gt;f、[LJLayer setFrame]&lt;br&gt;g、[CALayer setFrame]&lt;br&gt;h、[LJLayer setBounds] 设置 Layer 的 bounds 实际布局  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;5、在第 2 的基础上通过设置 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;Frame&lt;/code&gt; 实际设置当前的 &lt;code&gt;bounds&lt;/code&gt; 中心点，也就可以看出 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;Frame&lt;/code&gt; 在设置情况实际是根据 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;bounds&lt;/code&gt; 和 &lt;code&gt;position&lt;/code&gt; 来实际决定其 &lt;code&gt;Frame&lt;/code&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJView:0x7f9ae840c220&amp;gt;(-[LJView center])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kByvPPLqQlXuqrd3k%2F1877765-591e5663da92e76a.png?alt=media&amp;amp;token=0292e6bd-1489-4166-87fa-4ff0130933c4&quot; alt=&quot;屏幕快照 2019-01-18 00.29.55.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;&amp;lt;LJLayer:0x6040002212a0&amp;gt;(-[LJLayer position])&lt;/code&gt;调用栈：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kCApjZQtcKicNi7g2%2F1877765-8161cf64cdd86cda.png?alt=media&amp;amp;token=6d80ed68-a6e9-46f9-b38b-65ee5cfa4297&quot; alt=&quot;屏幕快照 2019-01-18 00.30.09.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面我们可以看出在实际中的调用栈是：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a、[UIView init] 初始化&lt;br&gt;b、[UIView initWithFrame] 调用 initWithFrame 方法&lt;br&gt;c、UIViewCommonInitWithFrame 采用 Common frame 初始&lt;br&gt;d、[LJView setFrame] 调用具体 View 设置 Parent frame 布局&lt;br&gt;e、[UIView(Geometry) setFrame]&lt;br&gt;f、[LJView center] 调用 View 中 Center 委托给 Layer 的 position&lt;br&gt;g、[LJLayer position]   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;6、在第 2 基础上设置完相关通过 &lt;code&gt;Vi ew&lt;/code&gt; 中心点委托给 &lt;code&gt;Layer&lt;/code&gt; 的 &lt;code&gt;position&lt;/code&gt; 来获取。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;上面在初始化 &lt;code&gt;[[LJView alloc] init]&lt;/code&gt; 在实际调用过程中我们可以看到首先是通过 &lt;code&gt;[UIView _createLayerWithFrame]&lt;/code&gt; 创建 &lt;code&gt;Layer&lt;/code&gt; 然后根据 &lt;code&gt;Layer&lt;/code&gt; 的属性 &lt;code&gt;Poition&lt;/code&gt; 和 &lt;code&gt;Bounds&lt;/code&gt; 决定 &lt;code&gt;UIView&lt;/code&gt; 的 &lt;code&gt;Frame&lt;/code&gt; 确定含有 &lt;code&gt;UIView&lt;/code&gt; 在视图控制器或者是父 &lt;code&gt;UIVIew&lt;/code&gt; 的布局。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;接下来我们对初始化后实例 &lt;code&gt;_ljView&lt;/code&gt; 对其 &lt;code&gt;Frame&lt;/code&gt; 赋值：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;_ljView.frame = CGRectMake(0, 0, LJScreenWidth(), 200);&lt;/code&gt; 打印的日志如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView setFrame:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView center])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setFrame:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setPosition:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer setBounds:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7f9ae840c220&lt;/span&gt;&amp;gt;(-[LJView center])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;39931&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;4249519&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x6040002212a0&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;在打印的具体调用栈我们可以看出再具体赋值的过程中实际的调用方法就是我们在进行  &lt;code&gt;[[LJView alloc] init]&lt;/code&gt; 创建其 &lt;code&gt;Layer&lt;/code&gt; 后调用方式：&lt;br&gt;1、&lt;code&gt;UIView&lt;/code&gt; 委托其包含的 &lt;code&gt;Layer&lt;/code&gt; 获取中心点来做判断；&lt;br&gt;2、通过 &lt;code&gt;Layer&lt;/code&gt; 来通过 &lt;code&gt;Bounds&lt;/code&gt; 和 &lt;code&gt;Position&lt;/code&gt; 来确定其 &lt;code&gt;Frame&lt;/code&gt;;&lt;br&gt;3、再次获取 &lt;code&gt;UIView&lt;/code&gt; 委托其包含的 &lt;code&gt;Layer&lt;/code&gt; 获取中心点来做判断当前中心点。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;UIView-和-CALayerDelegate-及-CAAction&quot;&gt;&lt;a href=&quot;#UIView-和-CALayerDelegate-及-CAAction&quot; class=&quot;headerlink&quot; title=&quot;UIView 和 CALayerDelegate 及 CAAction&quot;&gt;&lt;/a&gt;&lt;code&gt;UIView&lt;/code&gt; 和 &lt;code&gt;CALayerDelegate&lt;/code&gt; 及 &lt;code&gt;CAAction&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;我们在使用 &lt;code&gt;UIView&lt;/code&gt; 布局中不少有些动画效果，在 &lt;code&gt;iOS&lt;/code&gt; 里给出非常简洁的动画 &lt;code&gt;API&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;下面👇我们给出一个最简单的例子：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; animateWithDuration:&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; animations:^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.view.center = &lt;span class=&quot;built_in&quot;&gt;CGPointMake&lt;/span&gt;(LJScreenWidth()/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;300&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在上述的运行之前我们在 &lt;code&gt;LJView&lt;/code&gt; 重写下面方法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、 &lt;code&gt;CALayerDelegate&lt;/code&gt; 方法 &lt;code&gt;- (id&amp;lt;CAAction&amp;gt;)actionForLayer:forKey:&lt;/code&gt;；&lt;br&gt;2、&lt;code&gt;LJLayer&lt;/code&gt; 中方法 &lt;code&gt;- (void)addAnimation: forKey:&lt;/code&gt; 在其中实现 &lt;code&gt;CAAnimationDelegate&lt;/code&gt; 委托给 &lt;code&gt;LJLayer&lt;/code&gt; 然后重写 &lt;code&gt;- (void)animationDidStart:&lt;/code&gt; 和 &lt;code&gt;- (void)animationDidStop: finished:&lt;/code&gt; &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;运行上面的代码获取下面的打印日志：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//设置当前的 center 中心点 | 这里也可以看出 UIView 实际是由 Layer 来进行设置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7ff306d0d6f0&lt;/span&gt;&amp;gt;(-[LJView setCenter:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer setPosition:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//通过实现 CALayerDelegate 委托 | 返回当前的 CAAction 的协议给 Layer &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//CAAction &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//- (void)runActionForKey:event object:anObject arguments:dict;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7ff306d0d6f0&lt;/span&gt;&amp;gt;(-[LJView actionForLayer:forKey:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//判断 Layer 层 position 是否存在 | 获取当前 position &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Layer 获取动画添加&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] anim : &amp;lt;&lt;span class=&quot;built_in&quot;&gt;CABasicAnimation&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;0x60400003eb40&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer addAnimation:forKey:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//再次通过 View 来获取 actionForLayer:forKey: 判断是否动画再次天机&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJView:&lt;span class=&quot;number&quot;&gt;0x7ff306d0d6f0&lt;/span&gt;&amp;gt;(-[LJView actionForLayer:forKey:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer position])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] anim : (null)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer addAnimation:forKey:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//执行动画&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer animationDidStart:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//动画结束&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;2471&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;50545&lt;/span&gt;] &amp;lt;LJLayer:&lt;span class=&quot;number&quot;&gt;0x60400023f380&lt;/span&gt;&amp;gt;(-[LJLayer animationDidStop:finished:])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们可以看到上面👆在 &lt;code&gt;UIView&lt;/code&gt; 设置当前 &lt;code&gt;center&lt;/code&gt; 赋值的时候，&lt;code&gt;LJView&lt;/code&gt; 调用当前 &lt;code&gt;actionForLayer:forKey:&lt;/code&gt;，下面我们在 &lt;code&gt;[UIView animationWithDuration:animations:]&lt;/code&gt; 重写下面方法：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;actionForLayer:forKey: %@&quot;&lt;/span&gt;, [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ljView.layer.delegate actionForLayer:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ljView.layer forKey:&lt;span class=&quot;string&quot;&gt;@&quot;position&quot;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;built_in&quot;&gt;UIView&lt;/span&gt; animateWithDuration:&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; animations:^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;actionForLayer:forKey: %@&quot;&lt;/span&gt;, [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ljView.layer.delegate actionForLayer:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ljView.layer forKey:&lt;span class=&quot;string&quot;&gt;@&quot;position&quot;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.ljView.center = &lt;span class=&quot;built_in&quot;&gt;CGPointMake&lt;/span&gt;(LJScreenWidth()/&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;300&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在打印的具体内容：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//在 UIView block 外面设置返回 null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;5104&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;110746&lt;/span&gt;] actionForLayer:forKey: &amp;lt;null&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//在当前的 UIView block 中进行设置获取 animationAction 对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LJCAStructure[&lt;span class=&quot;number&quot;&gt;5104&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;110746&lt;/span&gt;] actionForLayer:forKey: &amp;lt;_UIViewAdditiveAnimationAction: &lt;span class=&quot;number&quot;&gt;0x604000038cc0&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;我们根据上面打印的日志在 &lt;code&gt;LJLayer&lt;/code&gt; 中写下下面动画的&lt;strong&gt;伪代码&lt;/strong&gt;：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)setPosition:(&lt;span class=&quot;built_in&quot;&gt;CGPoint&lt;/span&gt;)position &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;&amp;lt;%@:%p&amp;gt;(%s)&quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.class, &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;, __func__);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [&lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt; setPosition:position];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.delegate respondsToSelector:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(actionForLayer:forKey:)]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; obj = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.delegate actionForLayer:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; forKey:&lt;span class=&quot;string&quot;&gt;@&quot;position&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!obj) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//隐式动画&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([obj isKindOfClass:[&lt;span class=&quot;built_in&quot;&gt;NSNull&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//直接绘制&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// CAAnimation&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;CAAnimation&lt;/span&gt; *ainmaion;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; addAnimation:ainmaion forKey:&lt;span class=&quot;string&quot;&gt;@&quot;position&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过上面在简单的通过 &lt;code&gt;UIView&lt;/code&gt; 的 &lt;code&gt;API&lt;/code&gt; 实现动画，我们可以看出当前在执行动画的过程中具体实现流程如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;1、我们通过当前的 &lt;code&gt;UIView&lt;/code&gt; 在对其属性进行赋值时，&lt;code&gt;UIView&lt;/code&gt; 委托给 &lt;code&gt;Layer&lt;/code&gt; 进行属性设置；&lt;br&gt;2、&lt;code&gt;UIView&lt;/code&gt; 通过实现 &lt;code&gt;CALayerDelegate&lt;/code&gt; 委托方法，通过 &lt;code&gt;iOS&lt;/code&gt; 系统来查找对应的 &lt;code&gt;CAAction&lt;/code&gt; 来传递给 &lt;code&gt;CALayer&lt;/code&gt;；&lt;br&gt;3、&lt;code&gt;Layer&lt;/code&gt; 层获取在 &lt;code&gt;UIView&lt;/code&gt; 的 &lt;code&gt;CAAimation&lt;/code&gt; 数据，添加到当前执行动画中；&lt;br&gt;4、执行动画。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Core-Animation-绘制-特有-Layer&quot;&gt;&lt;a href=&quot;#Core-Animation-绘制-特有-Layer&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 绘制 - 特有 Layer&quot;&gt;&lt;/a&gt;Core Animation 绘制 - 特有 Layer&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;特有 Layer&lt;/th&gt;
&lt;th&gt;Advantages VS Disadvantages&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/CATextLayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CATextLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;纯文本带有文本或者是是文本字符串在 &lt;code&gt;UIKit&lt;/code&gt; 框架中 &lt;code&gt;UILabel&lt;/code&gt; 代替，采用是的 &lt;code&gt;Core Text&lt;/code&gt; 直接进行绘制。但是在使用过程中会发现在设置 居中显示默认是 &lt;code&gt;x&lt;/code&gt; 方向居中 &lt;code&gt;y&lt;/code&gt; 轴显示距离 &lt;code&gt;top&lt;/code&gt; 但是可以使用 &lt;code&gt;NSMutableAttributeString&lt;/code&gt; 来进行设置&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/cashapelayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAShaperLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;CAShaperLayer&lt;/code&gt; 通过矢量图形来进行绘制在使用绘制时不用像使用 &lt;code&gt;CALayer&lt;/code&gt; 生成相应的寄宿图片不消耗内存，可以结合 &lt;code&gt;Path&lt;/code&gt; 来进行各种内容的绘制工作。使用最广的场景就是我们在 APP 实现画笔或者是内容的绘制工作。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/cagradientLayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAGradientLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;一个使用硬件加速可以绘制出很炫的 &lt;code&gt;API&lt;/code&gt; 接口可以实现多种色彩平滑的过渡，多种颜色的间隔。如果作为 &lt;code&gt;mask&lt;/code&gt; 可以做出在一个 &lt;code&gt;UILabel&lt;/code&gt; 或者是 &lt;code&gt;CATextLayer&lt;/code&gt; 上面做出平滑过的颜色效果。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/caemitterlayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAEmitterLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;是一个基于核心动画粒子发射的系统。这里可以控制粒子生成以及粒子的开始位置实现很好粒子展示效果。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/cascrollLayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAScrollLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;管理着多个子层的使用，类似于在 &lt;code&gt;UIKit&lt;/code&gt; 中可滑动的控件 &lt;code&gt;UIScrollView&lt;/code&gt;。可以说是在没有对点击相应的情况下 &lt;code&gt;UIScrollView&lt;/code&gt; 很好的图层替代。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/catiledLayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CATiledLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;对图片实现分割显示，在 &lt;code&gt;UI&lt;/code&gt; 界面上我们可以操作和看到的图片都会通过 &lt;code&gt;OpenGL ES&lt;/code&gt; 生成纹理最后绘制在屏幕上。当显示的图片过大或者超出需要绘制的显示内容上，会在显示时对图片进行加压生成原生数据显示这时可能会出现卡顿现象。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/catransformlayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CATransformLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;实现 3D 层次展示，多使用在地图类。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/chapter6/careplicatorLayer.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAReplicatorLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;要自动复制一个或多个子层时使用。replicator为您创建副本，并使用您指定的属性来更改副本的外观或属性。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://www.objc.io/issues/18-games/metal/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAMetalLayer&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;主要是管理 &lt;code&gt;Metal Texture Pool&lt;/code&gt; 渲染 &lt;code&gt;MTL Texture&lt;/code&gt; 到显示窗口。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Core-Animation-动画-探索&quot;&gt;&lt;a href=&quot;#Core-Animation-动画-探索&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 动画 - 探索&quot;&gt;&lt;/a&gt;Core Animation 动画 - 探索&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;CAAnimation API&lt;/th&gt;
&lt;th&gt;Function&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/tree/master/AnimationDome/View/ComplexAnimation&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAAnimation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;QuartzCore&lt;/code&gt; 其他动画的父类，实现动画的基本接口。可以通过系统 &lt;code&gt;CAMediaTimingFunction&lt;/code&gt; 动画或者二次本塞尔曲线设置动画。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/tree/master/AnimationDome/View/AffineAnimationView&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAPropertyAnimation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CAAnimation&lt;/code&gt; 的子类，提供属性设置来实现显示动画。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/blob/master/AnimationDome/View/BaseAnimationViw&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CABasicAnimation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CAPropertyAnimation&lt;/code&gt; 默认执行动画的 &lt;code&gt;View&lt;/code&gt; 的 &lt;code&gt;Center&lt;/code&gt; 即实际 &lt;code&gt;Layer&lt;/code&gt; 层的 &lt;code&gt;Position&lt;/code&gt; 中心点位置指定开始位置到终点中心位置的动画。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/blob/master/AnimationDome/View/CALayerView&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAKeyframeAnimation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CAPropertyAnimation&lt;/code&gt; 的子类。同样是把 &lt;code&gt;Center&lt;/code&gt; 作为默认动画标点，通过 &lt;code&gt;keyTimes&lt;/code&gt; 和 &lt;code&gt;timingFunctions&lt;/code&gt; 来对动画设置在总动画时间，时间间隔对应的动画执行方式。或者是直接使用 &lt;code&gt;values&lt;/code&gt; 然后通过计算时间间隔来分隔动画实现多种动画效果叠加。通过 &lt;code&gt;path&lt;/code&gt; 来生成路径动画。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/tree/master/AnimationDome/View/ComplexAnimation&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CASpringAnimation&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CABasicAnimation&lt;/code&gt; 子类。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/tree/master/AnimationDome/View/FadeAnimationView&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CATransition&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CAAnimation&lt;/code&gt; 的子类，实例简单的动画效果。例如：&lt;code&gt;fade&lt;/code&gt;，&lt;code&gt;moveIn&lt;/code&gt;，&lt;code&gt;push&lt;/code&gt; 和 &lt;code&gt;reveal&lt;/code&gt; 设置进入方向类型。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://github.com/boilWater/AnimationDome/tree/master/AnimationDome/View/GroupAnimationView&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;CAAnimationGroup&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;作为 &lt;code&gt;CAAnimation&lt;/code&gt; 子类。对 &lt;code&gt;CAAnimation&lt;/code&gt; 进行栈整合，实现动画实现栈动画组的栈执行。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;在好久之前就实现根据写过简单的动画实现在动画的介绍中链接实现基础实现类，具体实现项目&lt;a href=&quot;https://github.com/boilWater/AnimationDome&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AnimationDome&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;下面👇这里主要针对 &lt;code&gt;CAKeyFrameAnimation&lt;/code&gt; 系统缓冲和自定义函数缓冲实现，及在实现缓冲过程中我们通过定义 &lt;code&gt;timingFundations&lt;/code&gt;，&lt;code&gt;values&lt;/code&gt; 和 &lt;code&gt;path&lt;/code&gt; 三者之间对应的关系。&lt;/p&gt;
&lt;h3 id=&quot;CAMediaTimingFundation-和-Path-关系&quot;&gt;&lt;a href=&quot;#CAMediaTimingFundation-和-Path-关系&quot; class=&quot;headerlink&quot; title=&quot;CAMediaTimingFundation 和 Path 关系&quot;&gt;&lt;/a&gt;CAMediaTimingFundation 和 Path 关系&lt;/h3&gt;&lt;p&gt;上面我们可以看出采用系统定义的 &lt;code&gt;kCAMediaTimingFunctionEaseIn&lt;/code&gt;，&lt;code&gt;kCAMediaTimingFunctionEaseInEaseOut&lt;/code&gt; 和 &lt;code&gt;kCAMediaTimingFunctionDefault&lt;/code&gt; 生成对应的效果图。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;Gif&lt;/code&gt; 视频文件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kCdPSGdLTAQr27yr6%2F1877765-cceb63f3c0a04111.gif?alt=media&amp;amp;token=ff05d3a2-6533-49f5-b76a-83f6e3431903&quot; alt=&quot;CAMediaTimingFuncation-System-Interface.gif&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;三者直接对用 CADeiaTimingFundation 对应的 Path 路径绘制&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;注：黄色是出发点，亮青是终点，蓝色是控制点。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kCmqbv1ULwhrRHDLk%2F1877765-c171b2f31898d656.png?alt=media&amp;amp;token=f3f6f654-d379-4864-9d79-2df979431dd3&quot; alt=&quot;屏幕快照 2019-01-27 16.59.10.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;下面我们参考系统的 &lt;code&gt;CAMediaTimingFundation&lt;/code&gt; 来自定义缓冲，&lt;a href=&quot;http://robertpenner.com/easing/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考资料&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7kCvKJdsXPZ5db-JNq%2F1877765-6ea8515e574f2f3a.png?alt=media&amp;amp;token=bb099dc2-cac7-4d80-9fbc-b5a6316670d9&quot; alt=&quot;屏幕快照 2019-01-27 17.22.59.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;上面自定义缓冲类型对应的代码实现：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;easeInQuint = &lt;span class=&quot;built_in&quot;&gt;CAMediaTimingFunction&lt;/span&gt;(controlPoints: &lt;span class=&quot;number&quot;&gt;0.6&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.04&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.98&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.335&lt;/span&gt;)           &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;easeInOutQuint = &lt;span class=&quot;built_in&quot;&gt;CAMediaTimingFunction&lt;/span&gt;(controlPoints: &lt;span class=&quot;number&quot;&gt;0.86&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.07&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)     &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;easeInOutBack = &lt;span class=&quot;built_in&quot;&gt;CAMediaTimingFunction&lt;/span&gt;(controlPoints: &lt;span class=&quot;number&quot;&gt;0.68&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-0.55&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.265&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;1.55&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在上面的博文中小编根据一些博文和 &lt;code&gt;WWDC&lt;/code&gt; 介绍。来对 &lt;code&gt;UIKit&lt;/code&gt; 中 &lt;code&gt;UIView&lt;/code&gt; 和 &lt;code&gt;QuartzCore&lt;/code&gt; 中的 &lt;code&gt;Layer&lt;/code&gt; 两者之间细节做探讨，来&lt;strong&gt;验证 &lt;code&gt;Core Animation&lt;/code&gt; 在实际应用中为 &lt;code&gt;UI&lt;/code&gt; 控件提供绘制的依据。&lt;/strong&gt;可以看出在实际绘制的过程中系统会通过 &lt;code&gt;GPU&lt;/code&gt; 来计算布局也就是在 &lt;a href=&quot;http://boilwater.github.io/2019/01/06/iOS%20UI%20优化%20一/#&amp;amp;gid=1&amp;amp;pid=1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS UI 优化博文大纲-Core Animation 作用域&lt;/a&gt; &lt;code&gt;Layout&lt;/code&gt; 中布局的计算。这个也是 &lt;code&gt;ASDK&lt;/code&gt; 作者认为可以优化的地方。&lt;/p&gt;
&lt;p&gt;来自定义缓冲函数实现帧动画的效果。&lt;/p&gt;
&lt;h3 id=&quot;参考资料：&quot;&gt;&lt;a href=&quot;#参考资料：&quot; class=&quot;headerlink&quot; title=&quot;参考资料：&quot;&gt;&lt;/a&gt;参考资料：&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;http://robertpenner.com/easing/penner_chapter7_tweening.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Dynamic Visuals&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004514-CH1-SW1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;About Core Animation&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/AdvancedAnimationTricks/AdvancedAnimationTricks.html#//apple_ref/doc/uid/TP40004514-CH8-SW3&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Animation Tricks&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/ReactingtoLayerChanges/ReactingtoLayerChanges.html#//apple_ref/doc/uid/TP40004514-CH7-SW1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Changing a Layer’s Default Behavior&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/ImprovingAnimationPerformance/ImprovingAnimationPerformance.html#//apple_ref/doc/uid/TP40004514-CH9-SW1&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Improving Animation Performance&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/LayerStyleProperties/LayerStyleProperties.html#//apple_ref/doc/uid/TP40004514-CH10-SW18&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Layer Style Property Animations&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://zsisme.gitbooks.io/ios-/content/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS Core Animation: Advanced Techniques&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;苹果的官方视频：&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2012/217/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Layer-Backed Views: AppKit + Core Animation&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2014/419/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Graphics and Animations for iOS Apps&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2012/506/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Optimizing 2D Graphics and Animation Performance&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2015/803/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Designing with Animation&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;作者： JackJin Bai  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;第一次修改时间： 2019/1/6 20：37：26&lt;br&gt;写于：广州市天河公园家里 &lt;/p&gt;
&lt;p&gt;第二次修改时间： 2019/1/18 02：02：44&lt;br&gt;写于：广州市天河公园家里 &lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Core-Animation-实现探索&quot;&gt;&lt;a href=&quot;#Core-Animation-实现探索&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 实现探索&quot;&gt;&lt;/a&gt;Core Animation 实现探索&lt;/h1&gt;&lt;p&gt;小编回顾粗略的写完 19 年 想要写的系列博文中 &lt;code&gt;iOS UI&lt;/code&gt; 优化总纲中第一篇博文 &lt;code&gt;Core Animation&lt;/code&gt; 一直在想怎么样展示自己的理解，就先从我们熟知的 &lt;code&gt;Core Animation&lt;/code&gt; 在整个 &lt;code&gt;APP&lt;/code&gt; 提供架构方面来进行O对比。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k6-E548XUtcpJOExw%2F1877765-f0cb74a53c9ba8dc.png?alt=media&amp;amp;token=85da9e64-1e31-4e59-a392-e6346b786a2d&quot; alt=&quot;屏幕快照 2019-01-15 23.12.22.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注：上图分别是从 2014 年的 &lt;code&gt;WWDC&lt;/code&gt; 讲述 &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2014/419/&quot;&gt;Advanced Graphics and Animations for iOS Apps&lt;/a&gt; 中截取 和 2018 年最新描述 &lt;a href=&quot;https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40004514-CH1-SW1&quot;&gt;About Core Animation&lt;/a&gt; 文档获取&lt;code&gt;Core Animation&lt;/code&gt; 在架构中实现。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;由上面显示具体信息我们可以得出下面结论：   &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1、&lt;code&gt;Core Animation&lt;/code&gt; 作为主要内容载体承接对 &lt;code&gt;iOS&lt;/code&gt; 和 &lt;code&gt;OS&lt;/code&gt; 具体显示的绘制；&lt;br&gt;2、&lt;code&gt;UIKit&lt;/code&gt; 框架从初始化到通过 &lt;code&gt;GPU&lt;/code&gt; 生成纹理显示在屏幕上是依靠 &lt;code&gt;Core Animation&lt;/code&gt;、 &lt;code&gt;Core Graphics&lt;/code&gt;、 &lt;code&gt;OpenGL ES&lt;/code&gt;(&lt;code&gt;iOS&lt;/code&gt; 11) 和 &lt;code&gt;Matel&lt;/code&gt;(&lt;code&gt;iOS&lt;/code&gt; 12)   来实现;&lt;br&gt;3、在 &lt;code&gt;iOS 8.0&lt;/code&gt; 中苹果官方尝试使用 &lt;code&gt;Metal&lt;/code&gt; 来替代 &lt;code&gt;OpenGL ES&lt;/code&gt; 在目前最新的官方文档中实现在绘制生成纹理底层架构依据 &lt;code&gt;Metal&lt;/code&gt; 进行。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;想要深入了解一个架构我们就从最基本的系统 &lt;code&gt;API&lt;/code&gt; 着手，下面是小编对系统 &lt;code&gt;API&lt;/code&gt; 根据分类来对具体类的 &lt;code&gt;API&lt;/code&gt; 进行整理。 &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k69JihU77jBBE8Kvm%2F-M7k6M58rz6cyT1AO8Pv%2F1877765-3b86566386d064e4.png?alt=media&amp;amp;token=3e463096-20b5-4bb2-bb15-39ccf7c6525c&quot; alt=&quot;屏幕快照 2019-01-14 22.50.21.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS UI 优化 - 总纲</title>
    <link href="http://yoursite.com/2019/01/06/iOS%20UI%20%E4%BC%98%E5%8C%96%20%E4%B8%80/"/>
    <id>http://yoursite.com/2019/01/06/iOS UI 优化 一/</id>
    <published>2019-01-06T12:23:44.435Z</published>
    <updated>2020-05-20T13:10:56.397Z</updated>
    
    <content type="html">&lt;h1 id=&quot;iOS-UI-优化博文大纲&quot;&gt;&lt;a href=&quot;#iOS-UI-优化博文大纲&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 优化博文大纲&quot;&gt;&lt;/a&gt;iOS UI 优化博文大纲&lt;/h1&gt;&lt;p&gt;2019 年开年第一篇博文，今天先起个头。&lt;/p&gt;
&lt;p&gt;今年第一个主题是关于 UI 界面实现原理，UI 目前实现主要方式在其实现上相关缺陷。开始从 &lt;code&gt;Core Animation&lt;/code&gt; 框架总结以及实现方式上讲解，然后从 &lt;code&gt;Core Graphics&lt;/code&gt; 和 &lt;code&gt;Core Iamge&lt;/code&gt; 在绘制层面三者如何把 &lt;code&gt;UIKit&lt;/code&gt; 控件如何实现绘制交由 &lt;code&gt;OpenGL ES&lt;/code&gt; | &lt;code&gt;Metal&lt;/code&gt; 来实现每一帧绘制。&lt;/p&gt;
&lt;p&gt;最后分析 &lt;code&gt;FB&lt;/code&gt; 开源的框架 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 实现 &lt;code&gt;UI&lt;/code&gt; 优化方式，对 &lt;code&gt;Core Text&lt;/code&gt; 进行最后封装来结束 &lt;code&gt;UI&lt;/code&gt; 专题。&lt;/p&gt;
&lt;h2 id=&quot;iOS-UI-架构图&quot;&gt;&lt;a href=&quot;#iOS-UI-架构图&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 架构图&quot;&gt;&lt;/a&gt;iOS UI 架构图&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5364d7UKuT45LmSr%2F1877765-c39a990fda4aa0a0.png?alt=media&amp;amp;token=63fb3ec2-1d90-4faf-836b-f768f0853d82&quot; alt=&quot;iOS UI Strcture.png&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-Animation-大纲&quot;&gt;&lt;a href=&quot;#Core-Animation-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 大纲&quot;&gt;&lt;/a&gt;Core Animation 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-3b86566386d064e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;Core Animation API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-f0cb74a53c9ba8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Animation&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 内容实际绘制主要承担的载体，为具体在屏幕上控件内容绘制，布局以及提供隐式和显示动画提供优雅的 &lt;code&gt;API&lt;/code&gt; 接口。&lt;strong&gt;b、&lt;/strong&gt; 作为硬件绘制输入把需要显示具体内容传入 &lt;code&gt;GPU&lt;/code&gt; 生成纹理在屏幕上进行渲染。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;http://boilwater.github.io/2019/01/06/iOS%20UI%20优化%20-%20Core%20Animation%20/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;2、作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Animation&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过 &lt;code&gt;CATypeLayer&lt;/code&gt; 类族显示效果，位置布局为 &lt;code&gt;UIKit&lt;/code&gt; 层提供底层绘制实现。&lt;strong&gt;b、&lt;/strong&gt;屏幕上直接与渲染硬件直接进行内容绘制，实现各种酷炫的效果以及更加高效绘制。&lt;strong&gt;c、&lt;/strong&gt; 通过 &lt;code&gt;CATypeAnimation&lt;/code&gt; 及其属性 &lt;code&gt;CATypeTiming&lt;/code&gt; 实现各种动画效果类型。&lt;strong&gt;d、&lt;/strong&gt;为 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 代码块动画代理对象，提供具体实现支持。&lt;strong&gt;在 iOS 的主要职能是为 UIKit 框架在 APP UI 控件实现基础上的绘制。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5GsNlbg6znTObpcw%2F1877765-5a0f1f734a47cb5d.png?alt=media&amp;amp;token=317a772c-48d6-4bc5-82a2-11e20bf16275&quot; alt=&quot;Core Animation.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;注：参考资料会在 &lt;a href=&quot;http://boilwater.github.io/2019/01/06/iOS%20UI%20优化%20-%20Core%20Animation%20/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS UI 优化 - Core Animation&lt;/a&gt; 最后给出：&lt;br&gt;在 &lt;code&gt;Core Animation&lt;/code&gt; 中可以看到在 &lt;code&gt;Application&lt;/code&gt; 中 &lt;code&gt;Handle Events&lt;/code&gt; 处理手势原理实际就是我们响应链处理过程。&lt;br&gt;&lt;a href=&quot;http://boilwater.github.io/2017/05/15/iOS-Responder%20Chain/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;响应链&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://boilwater.github.io/2017/01/13/APP控件在屏幕上显示/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;iOS 空间绘制原理&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-Graphics-大纲&quot;&gt;&lt;a href=&quot;#Core-Graphics-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Graphics 大纲&quot;&gt;&lt;/a&gt;Core Graphics 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-156381bdec28dba6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;Core Graphics API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-f0cb74a53c9ba8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Graphics&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为基于 &lt;code&gt;Quartz&lt;/code&gt; 绘图引擎来实现在 &lt;code&gt;iOS&lt;/code&gt; 和 &lt;code&gt;OS X&lt;/code&gt; 2D 图形绘制功能，接口实现是基于 &lt;code&gt;C&lt;/code&gt; 不符合 &lt;code&gt;iOS&lt;/code&gt; 中 &lt;code&gt;ARC&lt;/code&gt; 内存管理方式需要进行手动管理其内存。 &lt;strong&gt;b、&lt;/strong&gt; 作为 &lt;code&gt;CA&lt;/code&gt; 层具体显示内容 &lt;code&gt;CATypeLayer&lt;/code&gt; 层实际绘制执行者和 &lt;code&gt;OpenGL&lt;/code&gt;或者&lt;code&gt;Metal&lt;/code&gt; 一起承担起界面具体的绘制工作。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;http://boilwater.github.io/2019/03/08/IOS%20UI%20优化%20-%20Core%20Graphics/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;2、APP 作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Graphics&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过提供基础的 &lt;code&gt;API&lt;/code&gt; 接口来实现控件在 &lt;code&gt;UI&lt;/code&gt; 层面布局，色彩填充，画布绘制等具体的绘制实现。&lt;strong&gt;b、&lt;/strong&gt; 通过针对不同的绘制对象：&lt;code&gt;Window&lt;/code&gt;、&lt;code&gt;CALayer&lt;/code&gt;、&lt;code&gt;Bitmap&lt;/code&gt;、&lt;code&gt;PDF&lt;/code&gt; 和 &lt;code&gt;Printer&lt;/code&gt; 来生成对应的 &lt;code&gt;Context&lt;/code&gt; 实现具体内容的绘制生成可视化的效果展示在屏幕上。 &lt;strong&gt;c、&lt;/strong&gt; 在文本绘制的过程中我猜测使用 &lt;code&gt;PDF&lt;/code&gt; 文档解析的功能，为 &lt;code&gt;Core Text&lt;/code&gt; 提供实际的计算，&lt;strong&gt;依据 &lt;code&gt;Quartz&lt;/code&gt; 使用轮廓周围像素显示来实现抗锯齿完美展现文本显示。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Core-Text-大纲&quot;&gt;&lt;a href=&quot;#Core-Text-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Text 大纲&quot;&gt;&lt;/a&gt;Core Text 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-4ace47c5dff6e0f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;Core Text API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-9f0af182b0f5d5ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Text&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为基于 &lt;code&gt;Core Graphics&lt;/code&gt; 封装实现，是 &lt;code&gt;Apple&lt;/code&gt; 基础库中唯一一个处理字体绘制模块。&lt;strong&gt;b、&lt;/strong&gt;  在 &lt;code&gt;iOS 7&lt;/code&gt; 之后在此基础之上实现的 &lt;code&gt;Text Kit&lt;/code&gt; 实现跨 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 来作为文本绘制。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://www.jianshu.com/p/684e2a323620&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;2、作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Text&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过以 &lt;code&gt;Core Text&lt;/code&gt; 为基础实现文字绘制 &lt;code&gt;Text Kit&lt;/code&gt; 来实现富文本绘制，展示丰富多彩的文字效果。&lt;strong&gt;b、&lt;/strong&gt; 提供后台绘制能力，在实际绘制过程中可以放在 &lt;code&gt;Background Thread&lt;/code&gt; 来实现绘制工作。&lt;strong&gt;c、&lt;/strong&gt; 在实现中可以通过 &lt;code&gt;CTRunDelegate&lt;/code&gt; 来设置 &lt;code&gt;CTRun&lt;/code&gt; 来实现图文混排来时更加丰富的效果。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Text Kit 实现逻辑&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5evvrWy4lYF4OTVl%2F1877765-df9bbf81678c6a58.png?alt=media&amp;amp;token=88f672d0-d2b2-47a9-84e7-30ea30f20bc0&quot; alt=&quot;Text Kit.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;同时也会对本文进行在每一博文更新！！！&lt;/p&gt;
&lt;/blockquote&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;作者： JackJin Bai&lt;br&gt;第一次修改时间： 2019/1/6 20:37: 26&lt;br&gt;写于：广州市天河公园家里  &lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;iOS-UI-优化博文大纲&quot;&gt;&lt;a href=&quot;#iOS-UI-优化博文大纲&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 优化博文大纲&quot;&gt;&lt;/a&gt;iOS UI 优化博文大纲&lt;/h1&gt;&lt;p&gt;2019 年开年第一篇博文，今天先起个头。&lt;/p&gt;
&lt;p&gt;今年第一个主题是关于 UI 界面实现原理，UI 目前实现主要方式在其实现上相关缺陷。开始从 &lt;code&gt;Core Animation&lt;/code&gt; 框架总结以及实现方式上讲解，然后从 &lt;code&gt;Core Graphics&lt;/code&gt; 和 &lt;code&gt;Core Iamge&lt;/code&gt; 在绘制层面三者如何把 &lt;code&gt;UIKit&lt;/code&gt; 控件如何实现绘制交由 &lt;code&gt;OpenGL ES&lt;/code&gt; | &lt;code&gt;Metal&lt;/code&gt; 来实现每一帧绘制。&lt;/p&gt;
&lt;p&gt;最后分析 &lt;code&gt;FB&lt;/code&gt; 开源的框架 &lt;code&gt;ASDK&lt;/code&gt; 和 &lt;code&gt;YYKit&lt;/code&gt; 实现 &lt;code&gt;UI&lt;/code&gt; 优化方式，对 &lt;code&gt;Core Text&lt;/code&gt; 进行最后封装来结束 &lt;code&gt;UI&lt;/code&gt; 专题。&lt;/p&gt;
&lt;h2 id=&quot;iOS-UI-架构图&quot;&gt;&lt;a href=&quot;#iOS-UI-架构图&quot; class=&quot;headerlink&quot; title=&quot;iOS UI 架构图&quot;&gt;&lt;/a&gt;iOS UI 架构图&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5364d7UKuT45LmSr%2F1877765-c39a990fda4aa0a0.png?alt=media&amp;amp;token=63fb3ec2-1d90-4faf-836b-f768f0853d82&quot; alt=&quot;iOS UI Strcture.png&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-Animation-大纲&quot;&gt;&lt;a href=&quot;#Core-Animation-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Animation 大纲&quot;&gt;&lt;/a&gt;Core Animation 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-3b86566386d064e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;&lt;code&gt;Core Animation API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-f0cb74a53c9ba8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Animation&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 内容实际绘制主要承担的载体，为具体在屏幕上控件内容绘制，布局以及提供隐式和显示动画提供优雅的 &lt;code&gt;API&lt;/code&gt; 接口。&lt;strong&gt;b、&lt;/strong&gt; 作为硬件绘制输入把需要显示具体内容传入 &lt;code&gt;GPU&lt;/code&gt; 生成纹理在屏幕上进行渲染。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;http://boilwater.github.io/2019/01/06/iOS%20UI%20优化%20-%20Core%20Animation%20/&quot;&gt;2、作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Animation&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过 &lt;code&gt;CATypeLayer&lt;/code&gt; 类族显示效果，位置布局为 &lt;code&gt;UIKit&lt;/code&gt; 层提供底层绘制实现。&lt;strong&gt;b、&lt;/strong&gt;屏幕上直接与渲染硬件直接进行内容绘制，实现各种酷炫的效果以及更加高效绘制。&lt;strong&gt;c、&lt;/strong&gt; 通过 &lt;code&gt;CATypeAnimation&lt;/code&gt; 及其属性 &lt;code&gt;CATypeTiming&lt;/code&gt; 实现各种动画效果类型。&lt;strong&gt;d、&lt;/strong&gt;为 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 代码块动画代理对象，提供具体实现支持。&lt;strong&gt;在 iOS 的主要职能是为 UIKit 框架在 APP UI 控件实现基础上的绘制。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5GsNlbg6znTObpcw%2F1877765-5a0f1f734a47cb5d.png?alt=media&amp;amp;token=317a772c-48d6-4bc5-82a2-11e20bf16275&quot; alt=&quot;Core Animation.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;注：参考资料会在 &lt;a href=&quot;http://boilwater.github.io/2019/01/06/iOS%20UI%20优化%20-%20Core%20Animation%20/&quot;&gt;iOS UI 优化 - Core Animation&lt;/a&gt; 最后给出：&lt;br&gt;在 &lt;code&gt;Core Animation&lt;/code&gt; 中可以看到在 &lt;code&gt;Application&lt;/code&gt; 中 &lt;code&gt;Handle Events&lt;/code&gt; 处理手势原理实际就是我们响应链处理过程。&lt;br&gt;&lt;a href=&quot;http://boilwater.github.io/2017/05/15/iOS-Responder%20Chain/&quot;&gt;响应链&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://boilwater.github.io/2017/01/13/APP控件在屏幕上显示/&quot;&gt;iOS 空间绘制原理&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-Graphics-大纲&quot;&gt;&lt;a href=&quot;#Core-Graphics-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Graphics 大纲&quot;&gt;&lt;/a&gt;Core Graphics 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-156381bdec28dba6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;&lt;code&gt;Core Graphics API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-f0cb74a53c9ba8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Graphics&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为基于 &lt;code&gt;Quartz&lt;/code&gt; 绘图引擎来实现在 &lt;code&gt;iOS&lt;/code&gt; 和 &lt;code&gt;OS X&lt;/code&gt; 2D 图形绘制功能，接口实现是基于 &lt;code&gt;C&lt;/code&gt; 不符合 &lt;code&gt;iOS&lt;/code&gt; 中 &lt;code&gt;ARC&lt;/code&gt; 内存管理方式需要进行手动管理其内存。 &lt;strong&gt;b、&lt;/strong&gt; 作为 &lt;code&gt;CA&lt;/code&gt; 层具体显示内容 &lt;code&gt;CATypeLayer&lt;/code&gt; 层实际绘制执行者和 &lt;code&gt;OpenGL&lt;/code&gt;或者&lt;code&gt;Metal&lt;/code&gt; 一起承担起界面具体的绘制工作。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;http://boilwater.github.io/2019/03/08/IOS%20UI%20优化%20-%20Core%20Graphics/&quot;&gt;2、APP 作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Graphics&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过提供基础的 &lt;code&gt;API&lt;/code&gt; 接口来实现控件在 &lt;code&gt;UI&lt;/code&gt; 层面布局，色彩填充，画布绘制等具体的绘制实现。&lt;strong&gt;b、&lt;/strong&gt; 通过针对不同的绘制对象：&lt;code&gt;Window&lt;/code&gt;、&lt;code&gt;CALayer&lt;/code&gt;、&lt;code&gt;Bitmap&lt;/code&gt;、&lt;code&gt;PDF&lt;/code&gt; 和 &lt;code&gt;Printer&lt;/code&gt; 来生成对应的 &lt;code&gt;Context&lt;/code&gt; 实现具体内容的绘制生成可视化的效果展示在屏幕上。 &lt;strong&gt;c、&lt;/strong&gt; 在文本绘制的过程中我猜测使用 &lt;code&gt;PDF&lt;/code&gt; 文档解析的功能，为 &lt;code&gt;Core Text&lt;/code&gt; 提供实际的计算，&lt;strong&gt;依据 &lt;code&gt;Quartz&lt;/code&gt; 使用轮廓周围像素显示来实现抗锯齿完美展现文本显示。&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;Core-Text-大纲&quot;&gt;&lt;a href=&quot;#Core-Text-大纲&quot; class=&quot;headerlink&quot; title=&quot;Core Text 大纲&quot;&gt;&lt;/a&gt;Core Text 大纲&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-4ace47c5dff6e0f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;&lt;code&gt;Core Text API&lt;/code&gt;&lt;/a&gt;&lt;/th&gt;
&lt;th&gt;层次 &amp;amp; 作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://upload-images.jianshu.io/upload_images/1877765-9f0af182b0f5d5ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot;&gt;1、APP 结构层次&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Text&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 作为基于 &lt;code&gt;Core Graphics&lt;/code&gt; 封装实现，是 &lt;code&gt;Apple&lt;/code&gt; 基础库中唯一一个处理字体绘制模块。&lt;strong&gt;b、&lt;/strong&gt;  在 &lt;code&gt;iOS 7&lt;/code&gt; 之后在此基础之上实现的 &lt;code&gt;Text Kit&lt;/code&gt; 实现跨 &lt;code&gt;UIKit&lt;/code&gt; 和 &lt;code&gt;AppKit&lt;/code&gt; 来作为文本绘制。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;https://www.jianshu.com/p/684e2a323620&quot;&gt;2、作用&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Core Text&lt;/code&gt; &lt;strong&gt;a、&lt;/strong&gt; 通过以 &lt;code&gt;Core Text&lt;/code&gt; 为基础实现文字绘制 &lt;code&gt;Text Kit&lt;/code&gt; 来实现富文本绘制，展示丰富多彩的文字效果。&lt;strong&gt;b、&lt;/strong&gt; 提供后台绘制能力，在实际绘制过程中可以放在 &lt;code&gt;Background Thread&lt;/code&gt; 来实现绘制工作。&lt;strong&gt;c、&lt;/strong&gt; 在实现中可以通过 &lt;code&gt;CTRunDelegate&lt;/code&gt; 来设置 &lt;code&gt;CTRun&lt;/code&gt; 来实现图文混排来时更加丰富的效果。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Text Kit 实现逻辑&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gblobscdn.gitbook.com/assets%2F-M7k4T_Ro92aishHjmI4%2F-M7k4dwO5EuaRVogKZGQ%2F-M7k5evvrWy4lYF4OTVl%2F1877765-df9bbf81678c6a58.png?alt=media&amp;amp;token=88f672d0-d2b2-47a9-84e7-30ea30f20bc0&quot; alt=&quot;Text Kit.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;同时也会对本文进行在每一博文更新！！！&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS UI 界面" scheme="http://yoursite.com/tags/iOS-UI-%E7%95%8C%E9%9D%A2/"/>
    
  </entry>
  
  <entry>
    <title>iOS 11 新特性</title>
    <link href="http://yoursite.com/2017/12/21/iOS%2011%20%E6%96%B0%E7%89%B9%E6%80%A7/"/>
    <id>http://yoursite.com/2017/12/21/iOS 11 新特性/</id>
    <published>2017-12-20T16:04:50.000Z</published>
    <updated>2018-01-15T08:58:27.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;code&gt;iOS 11&lt;/code&gt; 的最新技术发布在 &lt;strong&gt;6月6号&lt;/strong&gt;，由于小编在工作上的原因只能在今天把 &lt;code&gt;iOS 11&lt;/code&gt;的相关信息整理出来对后面的开发便利以及在实际开发过程中可以更好的避免踩过的坑。&lt;/p&gt;
&lt;h1 id=&quot;新增的框架&quot;&gt;&lt;a href=&quot;#新增的框架&quot; class=&quot;headerlink&quot; title=&quot;新增的框架&quot;&gt;&lt;/a&gt;新增的框架&lt;/h1&gt;&lt;p&gt;对于上一个版本总体来说新增加两个主要大的框架 &lt;code&gt;Core ML&lt;/code&gt; 和 &lt;code&gt;ARKit&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-ML-框架&quot;&gt;&lt;a href=&quot;#Core-ML-框架&quot; class=&quot;headerlink&quot; title=&quot;Core ML 框架&quot;&gt;&lt;/a&gt;&lt;code&gt;Core ML&lt;/code&gt; 框架&lt;/h2&gt;&lt;p&gt;只从去年的时候 &lt;code&gt;AlphaGo&lt;/code&gt; 打败李世石，今年的升级版的 &lt;code&gt;AlphaGo&lt;/code&gt; 也战胜中国的柯洁，到最近前端时间升级版的 &lt;code&gt;AlphaZero&lt;/code&gt; 也战胜了前代的 &lt;code&gt;AlphaGo&lt;/code&gt;。感觉后面 &lt;code&gt;AI&lt;/code&gt; 只能是最近最火的科技，而且目前也可以看出来后面科技更新替代可能是对&lt;strong&gt;依据重复性训练获取技能重复单样工作的人员&lt;/strong&gt;优化（这是后话）。&lt;/p&gt;
&lt;p&gt;不过 &lt;code&gt;Core ML&lt;/code&gt; 是 &lt;code&gt;Apple&lt;/code&gt; 提供的已经训练好的模型，也就是说是根据数据进行相关训练好可以直接使用的一个数据匣子。小编讲的直白一点，就是你往匣子中输入数据然后获取相应的结果数据。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Core ML&lt;/code&gt; 背后是对 &lt;code&gt;iOS&lt;/code&gt; 的视觉识别 &lt;code&gt;Vision&lt;/code&gt; 框架和 &lt;code&gt;Foundation&lt;/code&gt; 中语义相关分析的 &lt;code&gt;API&lt;/code&gt;。一般移动端的开发者可以使用相关的接口来获取相关人脸识别或者是文字的识别结果。&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;ARKit-框架&quot;&gt;&lt;a href=&quot;#ARKit-框架&quot; class=&quot;headerlink&quot; title=&quot;ARKit 框架&quot;&gt;&lt;/a&gt;&lt;code&gt;ARKit&lt;/code&gt; 框架&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://developer.apple.com/documentation/arkit&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;ARKit&lt;/code&gt;&lt;/a&gt; 在小编的上一家公司是做产品公司，对一些新技术都有自己的积累。对 &lt;code&gt;ARKit&lt;/code&gt; 在 &lt;code&gt;Apple&lt;/code&gt; 上发布感觉还是听好玩的。因为在刚刚毕业时候和好室友一起做视频播放器，由于播放内容来源的版权问题被 &lt;code&gt;App Stroe&lt;/code&gt; 拒接上架，接着我们开始做 &lt;code&gt;AR&lt;/code&gt; 相关 &lt;code&gt;App&lt;/code&gt; 因为技术原因在模型上搁置。就这一样大半年过去（囧）。&lt;br&gt;不过苹果正式发布之后，反应平平，最后沦落为家居相关 &lt;code&gt;APP&lt;/code&gt;。&lt;br&gt;在 &lt;code&gt;ARKit&lt;/code&gt; 中使用的 &lt;code&gt;View&lt;/code&gt; 均是作为 &lt;code&gt;SceneKit&lt;/code&gt; 相关的延伸，在开发过程中我们见到的真实的世界都是归于系统来进行相关处理。作为开发者只需要界面相框中事物放到合适的位置，并且让他们进行相关的互动即可。&lt;/p&gt;
&lt;h1 id=&quot;新增的功能&quot;&gt;&lt;a href=&quot;#新增的功能&quot; class=&quot;headerlink&quot; title=&quot;新增的功能&quot;&gt;&lt;/a&gt;新增的功能&lt;/h1&gt;&lt;p&gt;&lt;code&gt;iOS 11&lt;/code&gt;除在框架外有所更新相关的内容，在功能的方面也做了些相关升级和更改。比如在网络方面、&lt;code&gt;Xcode 9&lt;/code&gt;、32 位处理器支持和 &lt;code&gt;WebKit&lt;/code&gt; 的特性等。&lt;/p&gt;
&lt;h2 id=&quot;网络部分&quot;&gt;&lt;a href=&quot;#网络部分&quot; class=&quot;headerlink&quot; title=&quot;网络部分&quot;&gt;&lt;/a&gt;网络部分&lt;/h2&gt;&lt;h3 id=&quot;ECN-显示拥堵通知&quot;&gt;&lt;a href=&quot;#ECN-显示拥堵通知&quot; class=&quot;headerlink&quot; title=&quot;ECN (显示拥堵通知)&quot;&gt;&lt;/a&gt;ECN (显示拥堵通知)&lt;/h3&gt;&lt;p&gt;网络拥堵发生时因为发送方无法及时知晓网络情况，在发现丢包时就会不断的重新重发，间接导致网络会更加拥堵使网络情况更加糟糕。目前 &lt;code&gt;ECN&lt;/code&gt; 的出现就解决此问题， &lt;code&gt;ECN&lt;/code&gt; 作为 &lt;code&gt;TCP&lt;/code&gt; 和 &lt;code&gt;IP&lt;/code&gt; 的协议扩展，存在于 &lt;code&gt;IP&lt;/code&gt; 的头文件中 &lt;code&gt;1 bit&lt;/code&gt; 的拥塞值的状态值，是由接收方回复给发送方，发送方接受到此消息的请求后停止继续发送数据包，直到拥塞的状态停止才开始继续发送数据。&lt;/p&gt;
&lt;p&gt;不过是实际情况中使用时 &lt;code&gt;ECN&lt;/code&gt; 需要结合客户端、服务端和网络端三个方面的支持，目前 &lt;code&gt;ECN&lt;/code&gt; 属于 &lt;code&gt;Linux&lt;/code&gt; 内核，只需要升级 &lt;code&gt;Linux&lt;/code&gt; 就可以获取支持，&lt;code&gt;Apple&lt;/code&gt; 给出了 &lt;code&gt;Server&lt;/code&gt; 对 &lt;code&gt;ECN&lt;/code&gt; 的支持率：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-f28899d2fc311282.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2018-01-15 11.58.23.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;客户端方面， &lt;code&gt;iOS 10.3&lt;/code&gt; 开始，有过半的通过 &lt;code&gt;wifi&lt;/code&gt; 和少量通过移动网络进行的 &lt;code&gt;TCP&lt;/code&gt; 连接已经打开了 &lt;code&gt;ECN&lt;/code&gt;，没有收到相关的问题报告。&lt;/p&gt;
&lt;p&gt;下面是搜集的一些国家网络拥堵的数据：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-b4f2f7bde92d7e13.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2018-01-15 12.02.25.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;客户端从 &lt;code&gt;iOS 11&lt;/code&gt; 开始，所有 &lt;code&gt;TCP&lt;/code&gt; 请求都会支持 &lt;code&gt;EC&lt;/code&gt;N（全部 &lt;code&gt;Wifi&lt;/code&gt; 和部分白名单移动运营商）；服务端有 &lt;code&gt;74%&lt;/code&gt; 的网站支持了 &lt;code&gt;ECN&lt;/code&gt;，也会有越来越多的网络服务商开始支持 &lt;code&gt;ECN&lt;/code&gt; 来进一步提升用户体验；（服务商只需要在你的网络接入点支持 &lt;code&gt;ECN&lt;/code&gt; 即可）。&lt;/p&gt;
&lt;p&gt;使用 &lt;code&gt;ECN&lt;/code&gt; 实现标记连接拥塞，可以更加高效：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;减少重发次数；&lt;/li&gt;
&lt;li&gt;降低延迟；&lt;/li&gt;
&lt;li&gt;提升用户体验。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在使用 &lt;code&gt;ECN&lt;/code&gt; 的同时，需要在结合使用 &lt;a href=&quot;https://wiki.openwrt.org/doc/uci/sqm&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;code&gt;SQM&lt;/code&gt;(Smart Queue Management)&lt;/a&gt; 来实现数据缓存，这样可以实现提前告知发送者当前的网络zhekuai，可以最大程度上实现避免拥塞出现。&lt;/p&gt;
&lt;h2 id=&quot;WKWebView-Cookie-管理&quot;&gt;&lt;a href=&quot;#WKWebView-Cookie-管理&quot; class=&quot;headerlink&quot; title=&quot;WKWebView Cookie 管理&quot;&gt;&lt;/a&gt;&lt;code&gt;WKWebView Cookie&lt;/code&gt; 管理&lt;/h2&gt;&lt;h3 id=&quot;URLSession-Adaptable-Connectivity-API&quot;&gt;&lt;a href=&quot;#URLSession-Adaptable-Connectivity-API&quot; class=&quot;headerlink&quot; title=&quot;URLSession Adaptable Connectivity API&quot;&gt;&lt;/a&gt;&lt;code&gt;URLSession Adaptable Connectivity API&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;现在可以通过 &lt;code&gt;urlSession(_:taskIsWaitingForConnectivity:)&lt;/code&gt; 让请求等待网络正常后再自动尝试。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79gy1fjoxl26swrj315o0n6q3o.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;URLSessionTask-Scheduling-API&quot;&gt;&lt;a href=&quot;#URLSessionTask-Scheduling-API&quot; class=&quot;headerlink&quot; title=&quot;URLSessionTask Scheduling API&quot;&gt;&lt;/a&gt;&lt;code&gt;URLSessionTask Scheduling API&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;通过 &lt;code&gt;URLSessionTask Scheduling API&lt;/code&gt; 可以在 &lt;code&gt;App&lt;/code&gt; 没有运行的时候下载内容，而手机也会结合实际电量，使用状态去决定是否执行。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79gy1fjoxl1y1z1j315o0n9wfy.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;iOS-11开发新特性之-WebKit-支持-WebRTC&quot;&gt;&lt;a href=&quot;#iOS-11开发新特性之-WebKit-支持-WebRTC&quot; class=&quot;headerlink&quot; title=&quot;iOS 11开发新特性之 WebKit 支持 WebRTC&quot;&gt;&lt;/a&gt;&lt;code&gt;iOS 11&lt;/code&gt;开发新特性之 &lt;code&gt;WebKit&lt;/code&gt; 支持 &lt;code&gt;WebRTC&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;&lt;code&gt;iOS 11&lt;/code&gt; 的 &lt;code&gt;WebKit&lt;/code&gt; 中支持了 &lt;code&gt;WebRTC&lt;/code&gt; 相关的接口：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws4.sinaimg.cn/large/006tNc79gy1fjp0ig1bgij31800pg7bu.jpg&quot; alt=&quot;WebRTC&quot;&gt; &lt;/p&gt;
&lt;p&gt;目前 &lt;code&gt;WKWebView&lt;/code&gt; 还没有支持 &lt;code&gt;getUserMedia&lt;/code&gt; 无法获取 &lt;code&gt;MediaStream&lt;/code&gt;，无法传输音视频流，所以 &lt;code&gt;App&lt;/code&gt; 嵌套的 &lt;code&gt;WebView&lt;/code&gt; 还无法使用 &lt;code&gt;WebRTC&lt;/code&gt;，必须得用 &lt;code&gt;Safrai App&lt;/code&gt; 才可以。&lt;/p&gt;
&lt;p&gt;一旦 &lt;code&gt;WKWebView&lt;/code&gt; 支持 &lt;code&gt;MediaStream&lt;/code&gt; (&lt;code&gt;getUserMedia&lt;/code&gt;)，之后朋友圈里面的 &lt;code&gt;Web&lt;/code&gt; 会有更多可能性，比如直接音视频的合成，还有实时视频通信、&lt;code&gt;WebAR&lt;/code&gt; 的东西进行传播。借助小程序的入口，想象空间还是比较多的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;参考资料：&lt;/strong&gt;   &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/ChenYilong/WebRTC/tree/master/WebRTC&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;《WebRTC在iOS端的实现》&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://geek.csdn.net/news/detail/201894?spm=5176.100239.blogcont221561.55.4cb1f06dZvDWv3&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;《苹果终于入伙 WebRTC，新一代移动 Web 应用爆发路上还有哪些坑？》&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;iOS-11-开发新特性-Xcode9-新特性&quot;&gt;&lt;a href=&quot;#iOS-11-开发新特性-Xcode9-新特性&quot; class=&quot;headerlink&quot; title=&quot;iOS 11 开发新特性 Xcode9 新特性&quot;&gt;&lt;/a&gt;&lt;code&gt;iOS 11&lt;/code&gt; 开发新特性 &lt;code&gt;Xcode9&lt;/code&gt; 新特性&lt;/h2&gt;&lt;h3 id=&quot;添加-GitHub-功能&quot;&gt;&lt;a href=&quot;#添加-GitHub-功能&quot; class=&quot;headerlink&quot; title=&quot;添加 GitHub 功能&quot;&gt;&lt;/a&gt;添加 &lt;code&gt;GitHub&lt;/code&gt; 功能&lt;/h3&gt;&lt;p&gt;在 &lt;code&gt;Xcode 9&lt;/code&gt; 引入了 &lt;code&gt;Github&lt;/code&gt; 源代码的管理，可以展示在开发过程中 &lt;code&gt;Branch&lt;/code&gt; 和 &lt;code&gt;Tag&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-86d87d764dc4bef1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2018-01-15 15.06.20.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;双击可以看出 &lt;code&gt;Commit&lt;/code&gt; 的具体内容：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-585e13685c4e651e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2018-01-15 15.12.03.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以直接查看本次具体提交的内容：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-00bf3028c1d92fc5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2018-01-15 15.12.49.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;创建新的颜色-Asset-Catalog&quot;&gt;&lt;a href=&quot;#创建新的颜色-Asset-Catalog&quot; class=&quot;headerlink&quot; title=&quot;创建新的颜色 Asset Catalog&quot;&gt;&lt;/a&gt;创建新的颜色 &lt;code&gt;Asset Catalog&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;可以 zai &lt;code&gt;Asset Catalog&lt;/code&gt; 中使用颜色来创建图片，然后根据颜色填充来实现图片展示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tKfTcgy1fjolad575yj30z50fe74h.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;iOS-开发新特性-Tips&quot;&gt;&lt;a href=&quot;#iOS-开发新特性-Tips&quot; class=&quot;headerlink&quot; title=&quot;iOS 开发新特性 Tips&quot;&gt;&lt;/a&gt;&lt;code&gt;iOS 开发新特性 Tips&lt;/code&gt;&lt;/h2&gt;&lt;h3 id=&quot;DeviceCheck&quot;&gt;&lt;a href=&quot;#DeviceCheck&quot; class=&quot;headerlink&quot; title=&quot;DeviceCheck&quot;&gt;&lt;/a&gt;&lt;code&gt;DeviceCheck&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;DeviceCheck&lt;/code&gt; 允许开发者可以通过公司自己的服务器和 &lt;code&gt;Apple&lt;/code&gt; 服务器通讯，并为两个设备设置两个 &lt;code&gt;Bit&lt;/code&gt; 数据。&lt;/p&gt;
&lt;p&gt;在设备上使用 &lt;code&gt;DeviceCheck API&lt;/code&gt; 来生成 &lt;code&gt;token&lt;/code&gt;，然后把此 &lt;code&gt;token&lt;/code&gt; 发送给公司的服务器，在由公司的服务器发送到 &lt;code&gt;Apple&lt;/code&gt; 的 &lt;code&gt;API&lt;/code&gt; 进行通讯，可以来做更新或者是查询该设备的值。根据这两个字节的数据可以用来追踪用户。&lt;/p&gt;
&lt;p&gt;根据此功能，可以用在发欺诈的领域：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 7 天；&lt;/li&gt;
&lt;li&gt;使用者封号后防止重新注册账号接单；&lt;/li&gt;
&lt;li&gt;手机 &lt;code&gt;App&lt;/code&gt; 用户是否是第一次领取红包；&lt;/li&gt;
&lt;li&gt;防止用户打开多个 &lt;code&gt;App&lt;/code&gt;，例如：在同一款手机上开 5 个 App;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;在 &lt;code&gt;iOS 10.3&lt;/code&gt; 正式版本之后，&lt;code&gt;App&lt;/code&gt; 删除后 &lt;code&gt;keychain&lt;/code&gt; 不会被清理。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;iOS-11-开发新特性停止支持-32-位-App&quot;&gt;&lt;a href=&quot;#iOS-11-开发新特性停止支持-32-位-App&quot; class=&quot;headerlink&quot; title=&quot;iOS 11 开发新特性停止支持 32 位 App&quot;&gt;&lt;/a&gt;&lt;code&gt;iOS 11&lt;/code&gt; 开发新特性停止支持 32 位 &lt;code&gt;App&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;iOS11 放弃支持 iPhone5、iPhone5c、iPad4 ，标志着在硬件层面，32位设备退出了历史舞台，iOS 系统不再兼容32位设备。&lt;/p&gt;
&lt;p&gt;同时 iOS11 也将不再支持 32位 APP 运行, 32位 APP 在 APPStore 无法被搜到，已经下载的 APP 无法在“已购”项目中安装。&lt;/p&gt;
&lt;p&gt;iOS 11 只兼容 64-bit 设备，也就是搭载 A7 以上处理器的设备。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;iOS 11&lt;/code&gt; 的最新技术发布在 &lt;strong&gt;6月6号&lt;/strong&gt;，由于小编在工作上的原因只能在今天把 &lt;code&gt;iOS 11&lt;/code&gt;的相关信息整理出来对后面的开发便利以及在实际开发过程中可以更好的避免踩过的坑。&lt;/p&gt;
&lt;h1 id=&quot;新增的框架&quot;&gt;&lt;a href=&quot;#新增的框架&quot; class=&quot;headerlink&quot; title=&quot;新增的框架&quot;&gt;&lt;/a&gt;新增的框架&lt;/h1&gt;&lt;p&gt;对于上一个版本总体来说新增加两个主要大的框架 &lt;code&gt;Core ML&lt;/code&gt; 和 &lt;code&gt;ARKit&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;Core-ML-框架&quot;&gt;&lt;a href=&quot;#Core-ML-框架&quot; class=&quot;headerlink&quot; title=&quot;Core ML 框架&quot;&gt;&lt;/a&gt;&lt;code&gt;Core ML&lt;/code&gt; 框架&lt;/h2&gt;&lt;p&gt;只从去年的时候 &lt;code&gt;AlphaGo&lt;/code&gt; 打败李世石，今年的升级版的 &lt;code&gt;AlphaGo&lt;/code&gt; 也战胜中国的柯洁，到最近前端时间升级版的 &lt;code&gt;AlphaZero&lt;/code&gt; 也战胜了前代的 &lt;code&gt;AlphaGo&lt;/code&gt;。感觉后面 &lt;code&gt;AI&lt;/code&gt; 只能是最近最火的科技，而且目前也可以看出来后面科技更新替代可能是对&lt;strong&gt;依据重复性训练获取技能重复单样工作的人员&lt;/strong&gt;优化（这是后话）。&lt;/p&gt;
&lt;p&gt;不过 &lt;code&gt;Core ML&lt;/code&gt; 是 &lt;code&gt;Apple&lt;/code&gt; 提供的已经训练好的模型，也就是说是根据数据进行相关训练好可以直接使用的一个数据匣子。小编讲的直白一点，就是你往匣子中输入数据然后获取相应的结果数据。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Core ML&lt;/code&gt; 背后是对 &lt;code&gt;iOS&lt;/code&gt; 的视觉识别 &lt;code&gt;Vision&lt;/code&gt; 框架和 &lt;code&gt;Foundation&lt;/code&gt; 中语义相关分析的 &lt;code&gt;API&lt;/code&gt;。一般移动端的开发者可以使用相关的接口来获取相关人脸识别或者是文字的识别结果。&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>WCDB</title>
    <link href="http://yoursite.com/2017/11/20/WCDB%20%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97%E7%BB%8F/"/>
    <id>http://yoursite.com/2017/11/20/WCDB 学习使用心得经/</id>
    <published>2017-11-20T09:11:10.000Z</published>
    <updated>2017-11-20T10:17:44.000Z</updated>
    
    <content type="html">&lt;p&gt;之所以在关注到 &lt;code&gt;WCDB&lt;/code&gt; 是因为在新的一家公司重构数据库来解决胶水代码问题，换而言之在使用 &lt;code&gt;SQLite&lt;/code&gt; 数据中尽量减少 &lt;code&gt;SQL&lt;/code&gt; 中增、删、改和查语句的使用。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;WCDB&lt;/code&gt; 是腾讯微信开源在 2017/06/09 号开源的一种变种数据库，本质也是基于 &lt;code&gt;SQLite&lt;/code&gt; 。&lt;/p&gt;
&lt;h2 id=&quot;WCDB-简介&quot;&gt;&lt;a href=&quot;#WCDB-简介&quot; class=&quot;headerlink&quot; title=&quot;WCDB 简介&quot;&gt;&lt;/a&gt;&lt;code&gt;WCDB&lt;/code&gt; 简介&lt;/h2&gt;&lt;p&gt;WCDB 本质上对 &lt;code&gt;SQLite&lt;/code&gt; 数据库 OC++ 的组件，采用的方式是：&lt;br&gt;（1）使用 &lt;code&gt;ORM&lt;/code&gt; 映射来完成自定义数据表和相关的索引，这里就解决公司胶水代码问题&lt;br&gt;（2）使用 &lt;code&gt;WING&lt;/code&gt; 来解决 &lt;code&gt;SQL&lt;/code&gt; 查询过程中经常使用查询过程中字符串的拼装问题&lt;br&gt;（3）多线程实现读取数据时的并发操作，在修改或者插入数据时执行串行操作&lt;br&gt;（4）在数据库发生顺怀时实现修复功能&lt;br&gt;（5）可以实现在执行 &lt;code&gt;SQL&lt;/code&gt; 消耗的时间，可以帮助性能的监控&lt;br&gt;（6）采用防注入的 &lt;code&gt;SQL&lt;/code&gt; 语句，避免恶意输入损坏数据。&lt;/p&gt;
&lt;p&gt;下面简单的介绍上面在 &lt;code&gt;WCDB&lt;/code&gt; 具体实现&lt;/p&gt;
&lt;h3 id=&quot;ORM-实现原理&quot;&gt;&lt;a href=&quot;#ORM-实现原理&quot; class=&quot;headerlink&quot; title=&quot;ORM 实现原理&quot;&gt;&lt;/a&gt;&lt;code&gt;ORM&lt;/code&gt; 实现原理&lt;/h3&gt;&lt;p&gt;于数据库表和索引采用的&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;之所以在关注到 &lt;code&gt;WCDB&lt;/code&gt; 是因为在新的一家公司重构数据库来解决胶水代码问题，换而言之在使用 &lt;code&gt;SQLite&lt;/code&gt; 数据中尽量减少 &lt;code&gt;SQL&lt;/code&gt; 中增、删、改和查语句的使用。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;WCDB&lt;
    
    </summary>
    
      <category term="WCDB" scheme="http://yoursite.com/categories/WCDB/"/>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>SQLite 学习-多表查询</title>
    <link href="http://yoursite.com/2017/11/18/SQLite%20%E5%AD%A6%E4%B9%A0-%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2&%E8%BF%90%E7%AE%97&%E8%A1%A8%E8%BE%BE/"/>
    <id>http://yoursite.com/2017/11/18/SQLite 学习-多表查询&运算&表达/</id>
    <published>2017-11-18T15:57:40.000Z</published>
    <updated>2017-11-22T16:15:24.000Z</updated>
    
    <content type="html">&lt;p&gt;前篇博文小编写了基本的 &lt;code&gt;SQLite&lt;/code&gt; 操作方式，如果只是对数据库采取基本的操作看完小编第一篇博文就可以。后面小编将会讲述一些数据的相对来说比较复杂的操作方式。&lt;/p&gt;
&lt;p&gt;本篇将会列出下面的数据库相关知识：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;多表查询&lt;/li&gt;
&lt;li&gt;运算符&lt;/li&gt;
&lt;li&gt;表达式&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;多表查询&quot;&gt;&lt;a href=&quot;#多表查询&quot; class=&quot;headerlink&quot; title=&quot;多表查询&quot;&gt;&lt;/a&gt;多表查询&lt;/h2&gt;&lt;p&gt;接着上篇文章小编把数据库中查询使用的多表查询给大家做讲解。&lt;/p&gt;
&lt;p&gt;在多表查询过程中需要用到的关键词是: &lt;code&gt;join&lt;/code&gt;，而且在多表连接查询过程中有三种情况。&lt;/p&gt;
&lt;p&gt;分别是：交叉连接、内连接和外连接。&lt;/p&gt;
&lt;p&gt;一下操作均以 &lt;code&gt;Employee&lt;/code&gt; 和 &lt;code&gt;Programmer&lt;/code&gt; 两个表格为基础来实现使用用例。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;内容是乱取的，上次取名可能气到在意的人，后面名字均是乱取！！！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-2dfc0cb76093a392.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-20 01.14.27.png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;交叉连接-CROSS-JION&quot;&gt;&lt;a href=&quot;#交叉连接-CROSS-JION&quot; class=&quot;headerlink&quot; title=&quot;交叉连接(CROSS JION)&quot;&gt;&lt;/a&gt;交叉连接(CROSS JION)&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;（1）&lt;/strong&gt;交叉连接特点：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在实现交叉连接过程中数据库中每一行和每一行会做对比，生成一张查找出来内容很大的数据。例如：如果一个表格有 a 行，另一个表格有 b 行，生成的表格大小为 &lt;strong&gt;a * b&lt;/strong&gt; 行内容。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;（2）&lt;/strong&gt;使用格式：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//主要实现 SELECT 具体行 FROM 数据库1 CROSS JION 数据库2;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT column_one, column_two, ... FROM tableName_one CROSS JION tableName_two;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;（3）&lt;/strong&gt;操作实例：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-d2f9875f3f82c169.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-19 23.43.21.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;内连接-INNER-JION&quot;&gt;&lt;a href=&quot;#内连接-INNER-JION&quot; class=&quot;headerlink&quot; title=&quot;内连接(INNER JION)&quot;&gt;&lt;/a&gt;内连接(INNER JION)&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;（1）&lt;/strong&gt;内连接特点：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在内连接中可以实现根据相关的条件实现表中符合条件的数据两行进行匹配形成一个结果行。显示的数据内容没有交叉连接大。&lt;strong&gt;也是数据库多表查询的默认实现方式。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;（2）&lt;/strong&gt;使用格式：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.1&lt;/strong&gt; 连表查询过程三种情况：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;INNER JION : 默认链接方式， &lt;code&gt;INNER&lt;/code&gt; 可以省略&lt;/li&gt;
&lt;li&gt;JION … USING : 解决较长条件，保持节俭来声明内连接方式&lt;/li&gt;
&lt;li&gt;NATURAL JOIN : 类似于 USING 方法，但是会自动检测一列值是否相等&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2.2&lt;/strong&gt; 连表查询标准格式&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//采用 INNER JION 方式查询&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//SELECT 具体行 FROM 数据库1 INNER（可以省略）JOIN 数据库2 ON 数据行描述;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT column_one, column_two, ... FROM tableName_one INNER JION tableName_two ON Condition_Expression;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//采用 JION...USING 相等连接查询方式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT * FROM tableName_one JION tableName_two USING(column_one, ...);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//采用 NATURAL JION 自然连接查询方式&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT * FROM tableName_one NATURAL JION tableName_two;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;（3）&lt;/strong&gt;操作实例：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.1&lt;/strong&gt;采用 &lt;code&gt;INNER JION&lt;/code&gt; 连表查询&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-0a55fba6da7b1789.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-20 00.10.57.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.2&lt;/strong&gt; 采用 &lt;code&gt;JION...USING()&lt;/code&gt; 连表查询&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-7685938dc35e7563.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-22 22.05.44.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.3&lt;/strong&gt; 采用 &lt;code&gt;NATURE&lt;/code&gt; 连表查询&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-1d1d594962201b69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-22 22.12.18.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;三种查询方式特点小结&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;有上面连表查询实例可以看出：&lt;br&gt;&lt;strong&gt;&lt;code&gt;INNER JION&lt;/code&gt; &lt;/strong&gt; 在实现多条件查询过程中需要使用多个 Condations 情况，使用更加灵活可以有 &lt;code&gt;&amp;gt;&lt;/code&gt;、&lt;code&gt;&amp;lt;&lt;/code&gt;、等&lt;br&gt;&lt;strong&gt;&lt;code&gt;JION...USING()&lt;/code&gt;&lt;/strong&gt; 在实现完全的等于的基础上可以实用，这样不需要写具体的 &lt;code&gt;=&lt;/code&gt; 语句&lt;br&gt;&lt;strong&gt;&lt;code&gt;NATURE&lt;/code&gt;&lt;/strong&gt;可以实现列的相等，但是使用场景是在表格中&lt;strong&gt;仅有一列是相等的&lt;/strong&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;外连接-OUTER-JOIN&quot;&gt;&lt;a href=&quot;#外连接-OUTER-JOIN&quot; class=&quot;headerlink&quot; title=&quot;外连接(OUTER JOIN)&quot;&gt;&lt;/a&gt;外连接(OUTER JOIN)&lt;/h3&gt;&lt;p&gt;在外连接多表查询中有三种情况：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;（1）&lt;/strong&gt;外连接特点：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; 外连接可以说是内连接的衍生，在此基础上可以实现在条件没有符合的基础上也会把数据列举出来。而且外连接分为：LEFT、RIGHT 和 FULL 连接三种情况，&lt;strong&gt;&lt;code&gt;SQLite&lt;/code&gt;仅仅支持 &lt;code&gt;LEFT&lt;/code&gt; 链接方式&lt;/strong&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;（2）&lt;/strong&gt;使用格式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;INNER JION : 默认链接方式， &lt;code&gt;INNER&lt;/code&gt; 可以省略&lt;/li&gt;
&lt;li&gt;JION … USING : 解决较长条件，保持节俭来声明内连接方式&lt;/li&gt;
&lt;li&gt;NATURAL JOIN : 类似于 USING 方法，但是会自动检测一列值是否相等&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2.1&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//SELECT 具体行 FROM 数据库1 INNER（可以省略）JOIN 数据库2 ON 数据行描述;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT column_one, column_two, ... FROM tableName_one LEFT OUTER JION tableName ON Condition_Expression;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;（3）&lt;/strong&gt;操作实例：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-f591c5239159984c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-20 00.23.21.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;发布时间：11/19/2017 00:12:12&lt;br&gt;版本第一次修改：11/20/2017 00:33:37&lt;br&gt;不行扛不住了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;前篇博文小编写了基本的 &lt;code&gt;SQLite&lt;/code&gt; 操作方式，如果只是对数据库采取基本的操作看完小编第一篇博文就可以。后面小编将会讲述一些数据的相对来说比较复杂的操作方式。&lt;/p&gt;
&lt;p&gt;本篇将会列出下面的数据库相关知识：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;多表查询&lt;/li&gt;
&lt;li&gt;运算符&lt;/li&gt;
&lt;li&gt;表达式&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;多表查询&quot;&gt;&lt;a href=&quot;#多表查询&quot; class=&quot;headerlink&quot; title=&quot;多表查询&quot;&gt;&lt;/a&gt;多表查询&lt;/h2&gt;&lt;p&gt;接着上篇文章小编把数据库中查询使用的多表查询给大家做讲解。&lt;/p&gt;
&lt;p&gt;在多表查询过程中需要用到的关键词是: &lt;code&gt;join&lt;/code&gt;，而且在多表连接查询过程中有三种情况。&lt;/p&gt;
&lt;p&gt;分别是：交叉连接、内连接和外连接。&lt;/p&gt;
&lt;p&gt;一下操作均以 &lt;code&gt;Employee&lt;/code&gt; 和 &lt;code&gt;Programmer&lt;/code&gt; 两个表格为基础来实现使用用例。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;内容是乱取的，上次取名可能气到在意的人，后面名字均是乱取！！！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-2dfc0cb76093a392.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-20 01.14.27.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="数据库" scheme="http://yoursite.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="SQLite" scheme="http://yoursite.com/tags/SQLite/"/>
    
  </entry>
  
  <entry>
    <title>SQLite 学习-基础知识</title>
    <link href="http://yoursite.com/2017/11/14/SQLite%20%E5%AD%A6%E4%B9%A0-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/"/>
    <id>http://yoursite.com/2017/11/14/SQLite 学习-基本知识/</id>
    <published>2017-11-14T12:24:13.000Z</published>
    <updated>2017-11-22T16:15:20.000Z</updated>
    
    <content type="html">&lt;p&gt;几天得闲，上周一想把数据库相关知识整理一份当做在看到数据库后续，但是一直都在看公司的项目重构工作。今天终于把相关的技术问题解决，打算重新整理一份新知识点。&lt;/p&gt;
&lt;h1 id=&quot;数据库&quot;&gt;&lt;a href=&quot;#数据库&quot; class=&quot;headerlink&quot; title=&quot;数据库&quot;&gt;&lt;/a&gt;数据库&lt;/h1&gt;&lt;p&gt;小编在这里提出一个问题：为什么要使用数据库？&lt;/p&gt;
&lt;p&gt;在系统编译或者运行期间同时使用内存或者相关变量储存在堆中可以实现相关数据保存。但是在占用的内存或者是堆中的相关内容在程序 &lt;code&gt;KILL&lt;/code&gt; 之后，相关的数据也会被系统回收。我们为了保存相关的数据实现永久性的储存的，就是考虑磁盘的储存能力。这时文件储存和数据库储存就会是我们选择的对象。&lt;/p&gt;
&lt;p&gt;小编这里就以 &lt;code&gt;SQLite&lt;/code&gt; 来讲解相关数据基本原理和操作。&lt;/p&gt;
&lt;h2 id=&quot;SQLite&quot;&gt;&lt;a href=&quot;#SQLite&quot; class=&quot;headerlink&quot; title=&quot;SQLite&quot;&gt;&lt;/a&gt;SQLite&lt;/h2&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;首先要明白 &lt;code&gt;SQLite&lt;/code&gt; 数据库的使用不需要进行相关的配置，也不需要相关的以来关系就是通过 &lt;code&gt;API&lt;/code&gt; 的调用就可以实现基本的操作。&lt;/p&gt;
&lt;p&gt;在数据操作过程中经常使用的就是：增、删、改和查四中基本的操作。&lt;/p&gt;
&lt;h3 id=&quot;关键字&quot;&gt;&lt;a href=&quot;#关键字&quot; class=&quot;headerlink&quot; title=&quot;关键字&quot;&gt;&lt;/a&gt;关键字&lt;/h3&gt;&lt;p&gt;首先是数据库表创建、插入新的一行和删除：&lt;code&gt;CREATE&lt;/code&gt;、&lt;code&gt;ALTER&lt;/code&gt; 和 &lt;code&gt;DROP&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;具体每一行的增删改查：&lt;code&gt;INSERT&lt;/code&gt;、&lt;code&gt;DELETE&lt;/code&gt;、&lt;code&gt;SELECT&lt;/code&gt; 和 &lt;code&gt;UPDATE&lt;/code&gt;。&lt;/p&gt;
&lt;!-- more --&gt;
&lt;h3 id=&quot;操作实例&quot;&gt;&lt;a href=&quot;#操作实例&quot; class=&quot;headerlink&quot; title=&quot;操作实例&quot;&gt;&lt;/a&gt;操作实例&lt;/h3&gt;&lt;h4 id=&quot;1）数据表中列的相关操作和实例&quot;&gt;&lt;a href=&quot;#1）数据表中列的相关操作和实例&quot; class=&quot;headerlink&quot; title=&quot;1）数据表中列的相关操作和实例&quot;&gt;&lt;/a&gt;1）数据表中列的相关操作和实例&lt;/h4&gt;&lt;p&gt;&lt;strong&gt;小编一下操作是在 &lt;code&gt;MAC&lt;/code&gt; 上操作&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在终端数据的创建：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(1)&lt;/strong&gt;数据库创建&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//创建数据库 JackJin.db &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Sqlite3 JackJin.db&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;(2)&lt;/strong&gt;创建数据库表&lt;/p&gt;
&lt;p&gt;创建数据库的基本的语法是：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//数据库表格创建的基本的语法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CREATE TABLE table_name(column_one type, column_two type, ...);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//create table 表名(行名 当前行数据类型, ...);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;小编以公司为例在终端操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-cf01782ef4981d1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 20.16.10.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;小插曲&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(2.1)&lt;/strong&gt;数据库表格查询&lt;/p&gt;
&lt;p&gt;数据库相关操作的语法：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//简单表格查询 -- 只列出表格名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.tables&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//详细表格查询 -- 列出表格名称和相关创建执行语句&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.schme&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在终端的基本操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-547fdedc07179652.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 21.27.54.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(3)&lt;/strong&gt;对表现有的列操作&lt;/p&gt;
&lt;p&gt;现有表格中的列操作分为三种情况：新增列、删除已有的列和修改现有列的属性。&lt;/p&gt;
&lt;p&gt;操作的基本语法结构：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//新增 基本的语法结构&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ALTER TABLE table_name ADD column &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//删除 基本的语法结构&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ALTER TABLE table_name DROP COLUMN column;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//修改列字段的属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ALTER TABLE table_name ALTER COLUMN column &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在终端的基本操作：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.1&lt;/strong&gt; 对数据表新增列&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-bc3c0b6014f5352e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 21.41.07.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.2&lt;/strong&gt; 对数据表删除列&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-20278094efeb67e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 21.51.55.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3.3&lt;/strong&gt; 对数据修改相关列属性&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-d9a5593f194d23af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 21.55.28.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在上面的表格中可以看出在操作过程中 &lt;strong&gt;新增加的列成功&lt;/strong&gt;， 但在实现数据表删除和修改列的相关信息中失败。 小编找了下资料：&lt;code&gt;Sqlite3&lt;/code&gt; 值支持相关增加和重名民操作。 &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;2）数据表中行的相关操作和实例&quot;&gt;&lt;a href=&quot;#2）数据表中行的相关操作和实例&quot; class=&quot;headerlink&quot; title=&quot;2）数据表中行的相关操作和实例&quot;&gt;&lt;/a&gt;2）数据表中行的相关操作和实例&lt;/h4&gt;&lt;p&gt;在数据库中行的操作有增、删、改和查，四中基本操作的方式：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(1)&lt;/strong&gt;插入数据&lt;/p&gt;
&lt;p&gt;在数据表插入数据两种方式:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1.1 数据表&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//对现有表格插入数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INSERT INTO table_name VALUES (param_one, param_two, ...);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;这种方式是要对所有的参数进行数据表的插入！！！&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;1.2 局部的参数选择插入&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//实现数据表数据的局部数据插入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INSERT INTO table_name(column_one, column_two, ...) VALUES (param_one, param_two, ...);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;终端的实例操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-c274918e872d9441.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 22.29.39.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;小插曲&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;由上面看出小编在查看数据输出进行相关格式化操作：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//在输出时包括行头&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt; .header on&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt; .mode colum&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;(2)&lt;/strong&gt;删除数据&lt;/p&gt;
&lt;p&gt;删除数据也有两种操作方法：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.1 删除数据按照条件&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//数据库操作的基本语法 condition 是删除的条件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DELETE FROM table_name WHERE condition;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;2.1 删除全部数据&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//删除数据库中的全部数据内容&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DELETE FROM table_name;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;删除数据的实力操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-1f4ae7490d89e45e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 23.06.16.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;上面可以看出小编为了更好的展示数据 &lt;code&gt;DELETE&lt;/code&gt; 效果就在原来的基础又增加一条数据，更好展示删除过程中效果。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;(3)&lt;/strong&gt;修改数据&lt;/p&gt;
&lt;p&gt;数据修改基本语法：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//数据修改的基本语法类型 condation 是数据修改条件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UPDATE table_name SET column_one = value1, column_two = value2, ... WHERE condation;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;数据修改的实例操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-0924ab7dde94b7a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 23.16.47.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(4)&lt;/strong&gt;查询数据&lt;/p&gt;
&lt;p&gt;数据查询的基本操作基本分为两种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;单个表格数据查询&lt;/li&gt;
&lt;li&gt;多个表格数据查询&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;4.1 单标数据查询&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;单标的数据查询过程中一般分为两种情况：&lt;br&gt;查询所有的数据和按条件数据查询。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;a.&lt;/strong&gt;查询所有的数据  &lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//**a.**查询所有的数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT * FROM table_name;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;b.&lt;/strong&gt;按条件查询数据  &lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//**b.**按条件查询数据 column1 是要查询列名 &amp;amp;condation 是要查询的条件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SELECT column1, column2, ... FROM table_name WHERE condation;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-cdd0cd24fa746483.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-14 23.31.54.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;目前小编对 &lt;code&gt;SQLite&lt;/code&gt; 的基本操作博文到这里的，可以看出在多条件查询过程中操作失败的小案例。&lt;/p&gt;
&lt;p&gt;后面会整理数据之间比较复杂的关系操作。&lt;/p&gt;
&lt;p&gt;发布于：2017/11/14 23:34:40&lt;br&gt;地点：讯美科技广场 1 座 10 楼&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;几天得闲，上周一想把数据库相关知识整理一份当做在看到数据库后续，但是一直都在看公司的项目重构工作。今天终于把相关的技术问题解决，打算重新整理一份新知识点。&lt;/p&gt;
&lt;h1 id=&quot;数据库&quot;&gt;&lt;a href=&quot;#数据库&quot; class=&quot;headerlink&quot; title=&quot;数据库&quot;&gt;&lt;/a&gt;数据库&lt;/h1&gt;&lt;p&gt;小编在这里提出一个问题：为什么要使用数据库？&lt;/p&gt;
&lt;p&gt;在系统编译或者运行期间同时使用内存或者相关变量储存在堆中可以实现相关数据保存。但是在占用的内存或者是堆中的相关内容在程序 &lt;code&gt;KILL&lt;/code&gt; 之后，相关的数据也会被系统回收。我们为了保存相关的数据实现永久性的储存的，就是考虑磁盘的储存能力。这时文件储存和数据库储存就会是我们选择的对象。&lt;/p&gt;
&lt;p&gt;小编这里就以 &lt;code&gt;SQLite&lt;/code&gt; 来讲解相关数据基本原理和操作。&lt;/p&gt;
&lt;h2 id=&quot;SQLite&quot;&gt;&lt;a href=&quot;#SQLite&quot; class=&quot;headerlink&quot; title=&quot;SQLite&quot;&gt;&lt;/a&gt;SQLite&lt;/h2&gt;
    
    </summary>
    
      <category term="数据库" scheme="http://yoursite.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="SQLite" scheme="http://yoursite.com/tags/SQLite/"/>
    
  </entry>
  
  <entry>
    <title>SQLite 数据库基本操作</title>
    <link href="http://yoursite.com/2017/11/07/SQLite%20%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
    <id>http://yoursite.com/2017/11/07/SQLite 基本操作/</id>
    <published>2017-11-06T16:49:29.000Z</published>
    <updated>2017-11-12T16:41:44.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;code&gt;Sqlite&lt;/code&gt; 学习总结&lt;/p&gt;
&lt;h3 id=&quot;SQLite-的安装&quot;&gt;&lt;a href=&quot;#SQLite-的安装&quot; class=&quot;headerlink&quot; title=&quot;SQLite 的安装&quot;&gt;&lt;/a&gt;&lt;code&gt;SQLite&lt;/code&gt; 的安装&lt;/h3&gt;&lt;p&gt;一般在 &lt;code&gt;MAC&lt;/code&gt; 上面系统会自带 &lt;code&gt;Sqlite&lt;/code&gt; 的数据库版本的。&lt;/p&gt;
&lt;p&gt;查看本地的数据库版本号呢，可以在终端输入执行下面的语句（以 &lt;code&gt;mac&lt;/code&gt; 为例）：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sqlite3&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;小编的 &lt;code&gt;MAC&lt;/code&gt; 上输出的内容是：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;SQLite version &lt;span class=&quot;number&quot;&gt;3.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2016&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-11&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-04&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;19&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;09&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;39&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//可以看到 SQLite 的版本信息和安装时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Enter &lt;span class=&quot;string&quot;&gt;&quot;.help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; usage hints.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Connected to a transient &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;-memory database.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Use &lt;span class=&quot;string&quot;&gt;&quot;.open FILENAME&quot;&lt;/span&gt; to reopen on a persistent database.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;SQLite-语法基本操作&quot;&gt;&lt;a href=&quot;#SQLite-语法基本操作&quot; class=&quot;headerlink&quot; title=&quot;SQLite 语法基本操作&quot;&gt;&lt;/a&gt;SQLite 语法基本操作&lt;/h3&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;（1）创建表格&lt;br&gt;创建数据表格基本操作语法是：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;CREATE TABLE datebase_name(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;column_1 datetype PRIMARY-KEY, &lt;span class=&quot;comment&quot;&gt;//可以有多个KEY（主）键&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;column_2 datetype,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;column_3 datetype,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;... ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;例如创建班级的 &lt;code&gt;Table&lt;/code&gt; 表格，以 &lt;code&gt;ID&lt;/code&gt; 为主键。实例如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;CREATE TABLE ClassRoom(RoomID &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; perimary key, StudentNumber &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, Grade &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;查询数据库创建是否成功：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt; .table &lt;span class=&quot;comment&quot;&gt;//终端输入语句&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ClassRoom&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果查询数据库细节：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt; .schema &lt;span class=&quot;comment&quot;&gt;//查询数据内容具体细节&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt; .schema&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CREATE TABLE ClassRoom(RoomID &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; perimary key, StudentNumber &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, Grade &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CREATE TABLE Person(StudentID &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, name &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;, age &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;, address &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;, sex &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sqlite&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-0cbae91e21960869.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 00.47.12.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;（2）表格删除&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;drop table &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; exist Person;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在开始时对数据表格进行删除，得到下面的结果：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-823005bd8316d1a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 00.47.24.png&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;经过小编翻看资料，原来是在创建数据库时只是创建表格。并没有创建数据 &lt;code&gt;Table&lt;/code&gt; 所放的数据库。而且在 &lt;code&gt;sqlite3&lt;/code&gt; 使用过程中每个语句后面的结尾需要添加 &lt;strong&gt;&lt;code&gt;;&lt;/code&gt;&lt;/strong&gt; 来结尾。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;下面👇是使用终端对表格进行删除的正确操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-d49a8edb2ff9f6ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 09.38.41.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;（3）数据插入  &lt;/p&gt;
&lt;p&gt;对创建好的数据库 &lt;code&gt;Table&lt;/code&gt;进行数据库的插入操作实现有两种：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//方式一&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;insert into table_name(colum1, colum2, ...) values (param1, param2, ...);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//方式二&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;insert into table_name values(param1, param2, ...);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;具体实例如下：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-592676815750a18a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;1877765-0ee21d54775d5afa.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;（4）数据增加&lt;br&gt;（5）数据修改&lt;br&gt;（6）数据查找  &lt;/p&gt;
&lt;p&gt;在数据查找过程中我们比较常用的查找方式是：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;查询所有数据&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取数据库中所有的数据&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;select * from table_name;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;具体实例如下：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-a8d6824986b306b8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 09.52.36.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;在数据显示的过程中可以使数据清楚的罗列出来，具体实现：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;.header on &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.mode colum&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;具体实例如下：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-82d28393caab51f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 09.56.02.png&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;按条件查询数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-a5f1beaa1ce3c512.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;1877765-e896caf5ebdd870a.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-dac9d62e5bc97abf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;1877765-a6b05887d4902804.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;SQLite-表达式&quot;&gt;&lt;a href=&quot;#SQLite-表达式&quot; class=&quot;headerlink&quot; title=&quot;SQLite 表达式&quot;&gt;&lt;/a&gt;SQLite 表达式&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-b9d54e53707bdc24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;屏幕快照 2017-11-09 10.05.51.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;SQLite&lt;/code&gt; 索引的实现&lt;/p&gt;
&lt;p&gt;版本提交时间：&lt;/p&gt;
&lt;p&gt;第一次提交：11/7/2017 00:45:30&lt;br&gt;第二次提交：11/10/2017 00:19:35&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.runoob.com/sqlite/sqlite-tutorial.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.runoob.com/sqlite/sqlite-tutorial.html&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Sqlite&lt;/code&gt; 学习总结&lt;/p&gt;
&lt;h3 id=&quot;SQLite-的安装&quot;&gt;&lt;a href=&quot;#SQLite-的安装&quot; class=&quot;headerlink&quot; title=&quot;SQLite 的安装&quot;&gt;&lt;/a&gt;&lt;code&gt;SQLite&lt;/code&gt; 的安装&lt;/h3&gt;&lt;p&gt;一般在 &lt;code&gt;MAC&lt;/code&gt; 上面系统会自带 &lt;code&gt;Sqlite&lt;/code&gt; 的数据库版本的。&lt;/p&gt;
&lt;p&gt;查看本地的数据库版本号呢，可以在终端输入执行下面的语句（以 &lt;code&gt;mac&lt;/code&gt; 为例）：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;sqlite3&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;小编的 &lt;code&gt;MAC&lt;/code&gt; 上输出的内容是：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;SQLite version &lt;span class=&quot;number&quot;&gt;3.16&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2016&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-11&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-04&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;19&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;09&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;39&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//可以看到 SQLite 的版本信息和安装时间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Enter &lt;span class=&quot;string&quot;&gt;&quot;.help&quot;&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; usage hints.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Connected to a transient &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;-memory database.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Use &lt;span class=&quot;string&quot;&gt;&quot;.open FILENAME&quot;&lt;/span&gt; to reopen on a persistent database.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;SQLite-语法基本操作&quot;&gt;&lt;a href=&quot;#SQLite-语法基本操作&quot; class=&quot;headerlink&quot; title=&quot;SQLite 语法基本操作&quot;&gt;&lt;/a&gt;SQLite 语法基本操作&lt;/h3&gt;
    
    </summary>
    
      <category term="数据库" scheme="http://yoursite.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="SQLite" scheme="http://yoursite.com/tags/SQLite/"/>
    
  </entry>
  
  <entry>
    <title>开发架构设计</title>
    <link href="http://yoursite.com/2017/09/01/%E5%BC%80%E5%8F%91%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    <id>http://yoursite.com/2017/09/01/开发架构设计/</id>
    <published>2017-09-01T09:42:32.000Z</published>
    <updated>2018-01-16T02:23:57.000Z</updated>
    
    <content type="html"></content>
    
    <summary type="html">
    
    </summary>
    
      <category term="架构" scheme="http://yoursite.com/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="移动开发" scheme="http://yoursite.com/tags/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>iOS-镜头采集(AVCaptureDevice)</title>
    <link href="http://yoursite.com/2017/08/17/iOS-%E9%95%9C%E5%A4%B4%E9%87%87%E9%9B%86(AVCaptureDevice)/"/>
    <id>http://yoursite.com/2017/08/17/iOS-镜头采集(AVCaptureDevice)/</id>
    <published>2017-08-17T09:42:32.000Z</published>
    <updated>2017-08-25T09:29:18.000Z</updated>
    
    <content type="html">&lt;p&gt;承接上一篇博文小编讲述在镜头采集过程所需知识点和 &lt;code&gt;AVCaptureSession&lt;/code&gt; 基本使用方法，本篇博文将要讲述 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 相关使用方法。&lt;/p&gt;
&lt;p&gt;下图为本博文写作思路：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-02f3ce2f37fba73c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;AVCaptureDevice博文写作思维导图.png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h1 id=&quot;AVCaptureDevice&quot;&gt;&lt;a href=&quot;#AVCaptureDevice&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDevice&quot;&gt;&lt;/a&gt;AVCaptureDevice&lt;/h1&gt;&lt;p&gt;AVCaptureDevice 在这个采集过程中相当于在发电过程中“发电设备”，提供实现摄像头和麦克风相关初始化。而且可以对摄像头进行一些基本设置，例如：闪光灯、手电筒、聚焦、曝光、白平衡等一些基本设置。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;AVCaptureDevice 实现摄像头初始化&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 初始化前需要对镜头申请权限，具体实现如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; ([&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; authorizationStatusForMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusAuthorized&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//获取授权成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusNotDetermined&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//目前用户为选择&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            dispatch_suspend(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.sessionQueue);&lt;span class=&quot;comment&quot;&gt;//self.seaaionQueue 是串行线程&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; requestAccessForMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt; completionHandler:^(&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; granted) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!granted) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.setupResult = FYCameraCaptureSetupResultNotAuthorized;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                dispatch_resume(&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.sessionQueue);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;//处理其余情况&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;请求硬件的获取状态，如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusNotDetermined&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//用户暂时没有做相关选着&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusRestricted&lt;/span&gt;    = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//没有改媒体类型&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusDenied&lt;/span&gt;        = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//用户拒绝&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVAuthorizationStatusAuthorized&lt;/span&gt;    = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//用户允许&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在获取对 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 使用允许的情况中，可以获取上面四中情况。可以依次对上面三种情况进行处理。下面👇列出初始方法。 &lt;/p&gt;
&lt;p&gt;1） &lt;code&gt;AVCaptureDevice&lt;/code&gt;基本初始方法&lt;br&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//方法(1)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *videoDevice = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; defaultDeviceWithMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//方法(2)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *videoDevice = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; defaultDeviceWithDeviceType:&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInDuoCamera&lt;/span&gt; mediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt; position:&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevicePositionBack&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2）&lt;code&gt;AVCaptureDevice&lt;/code&gt; 实现镜头自动变焦&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceType&lt;/span&gt;&amp;gt; *deviceType = @[&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInWideAngleCamera&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInDualCamera&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceDiscoverySession&lt;/span&gt; *videoDeviceDiscoverySession = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceDiscoverySession&lt;/span&gt; discoverySessionWithDeviceTypes:deviceType mediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt; position:&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevicePositionUnspecified&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//获取 devices &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *&amp;gt; *devices = videoDeviceDiscoverySession.devices;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在使用 &lt;code&gt;AVCaptureDeviceDiscoverySession&lt;/code&gt; 获取 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 过程中，使用 &lt;code&gt;AVCaptureDeviceType&lt;/code&gt;。&lt;br&gt;下面列出 &lt;code&gt;AVCaptureDeviceType&lt;/code&gt; 种类：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//AVCaptureDeviceType 种类&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInMicrophone&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//创建麦克风&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInWideAngleCamera&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//创建广角相机&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInTelephotoCamera&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//创建比广角相机更长的焦距。只有使用 AVCaptureDeviceDiscoverySession 可以使用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInDualCamera&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//创建变焦的相机，可以实现广角和变焦的自动切换。使用同AVCaptureDeviceTypeBuiltInTelephotoCamera 一样。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceTypeBuiltInDuoCamera&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;//iOS 10.2 被 AVCaptureDeviceTypeBuiltInDualCamera 替换&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;注释：&lt;code&gt;iOS 10.2&lt;/code&gt; 之后添加自动变焦功能, 而且在查找自动变焦镜头时需要采用 &lt;code&gt;AVCaptureDeviceDiscoverySession&lt;/code&gt; 进行查找。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;AVCaptureDevice&lt;/code&gt; 实现的通知&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;下面👇列出通知的类型：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Notification type &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceWasConnectedNotification&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;//设备被链接时发出通知&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceWasDisconnectedNotification&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;//设备被去去除时发出通知&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceSubjectAreaDidChangeNotification&lt;/span&gt;&lt;span class=&quot;comment&quot;&gt;//设备中场景改变时发出通知，既预览发生变化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;AVCaptureDevice&lt;/code&gt; 的位置&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevicePositionUnspecified&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;comment&quot;&gt;//不确定&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevicePositionBack&lt;/span&gt;        = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//后置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevicePositionFront&lt;/span&gt;       = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//前置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 如果初始的 AVMediaType 是 AVMediaTypeVideo 表示前置和后置摄像头&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;AVCaptureDeviceFlash-闪光灯&quot;&gt;&lt;a href=&quot;#AVCaptureDeviceFlash-闪光灯&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDeviceFlash(闪光灯)&quot;&gt;&lt;/a&gt;AVCaptureDeviceFlash(闪光灯)&lt;/h4&gt;&lt;p&gt;在光线不足的情况下，需要开启屏幕的闪光灯来进行补光。便于镜头可以捕捉更好的场景，拍摄出好的照片和视频。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;iOS 10_0&lt;/code&gt;之前闪光灯设置&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *errorProperty = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device hasFlash]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isFlashAvailable]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isFlashModeSupported:&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeOn&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; result = &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            result = [device lockForConfiguration:&amp;amp;errorProperty];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                [device setFlashMode:&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeOn&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : CONFIGURATION CAPTURE DEVICE FLASH FAILURE, ERROR CODE:%ld&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)errorProperty.code);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [device unlockForConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : FLASH IS UNAVAILABLE BECAUSE THE DEVCICE OVERHEATS&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : SOFTWARE DEVICE HAVE NO FLASH&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;iOS 10_0&lt;/code&gt;之后设置&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *outputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.outputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureOutput&lt;/span&gt; *output &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; outputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([output isMemberOfClass:[&lt;span class=&quot;built_in&quot;&gt;AVCapturePhotoOutput&lt;/span&gt; class]]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;AVCapturePhotoOutput&lt;/span&gt; *photoOutput = (&lt;span class=&quot;built_in&quot;&gt;AVCapturePhotoOutput&lt;/span&gt; *)output;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; flashSupported = [[photoOutput supportedFlashModes] containsObject:@(&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeAuto&lt;/span&gt;)];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (flashSupported) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;AVCapturePhotoSettings&lt;/span&gt; *photoSettings = photoOutput.photoSettingsForSceneMonitoring;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            photoSettings.flashMode = &lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeAuto&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : PHOTOOUTPUT CAN NOT SUPPORT AVCAPTUREMODE TYPE&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面👇列出闪光灯类型：&lt;br&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeOff&lt;/span&gt;  = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//闪光灯关闭&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeOn&lt;/span&gt;   = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//闪光灯开启&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFlashModeAuto&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//闪光灯自动&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;太困了，晚上跑 10 公里。目前👁都睁不开。&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在 iPhone 6s 开始，如果是前置摄像头并且开启闪光灯，可以实现屏幕闪光灯补光。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&quot;AVCaptureDeviceTorch-手电筒&quot;&gt;&lt;a href=&quot;#AVCaptureDeviceTorch-手电筒&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDeviceTorch(手电筒)&quot;&gt;&lt;/a&gt;AVCaptureDeviceTorch(手电筒)&lt;/h4&gt;&lt;p&gt;在光线不是很暗的情况下我们可以用手机的 LED 灯当做手电筒使用，具体实现如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device hasTorch]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isFlashAvailable]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isTorchModeSupported:&lt;span class=&quot;built_in&quot;&gt;AVCaptureTorchModeOn&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; result = &lt;span class=&quot;literal&quot;&gt;NO&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            result = [device lockForConfiguration:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                [device setTorchMode:&lt;span class=&quot;built_in&quot;&gt;AVCaptureTorchModeOn&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : CONFIGURATION DEVICE TORCH FAIL AND ERROR CODE %ld&quot;&lt;/span&gt;, (&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt;)error.code);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;// Torch light&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            result = [device setTorchModeOnWithLevel:&lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt; error:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : DEVICE SET TORCH FAILURE AND ERROR CODE %ld&quot;&lt;/span&gt;, error.code);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            [device unlockForConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : DEVICE CAN NO SUPPORT TORCH&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : SOFTHARE DEVICE TORCH IS UNAVAILABLE BECAUSE OVERHEATS&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;ERROR : SOFFHARE DEVICE HAS NO TORCH&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面列出 &lt;code&gt;Torch&lt;/code&gt; 类型，使用方法和闪关灯类型：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureTorchModeOff&lt;/span&gt;  = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//关闭&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureTorchModeOn&lt;/span&gt;   = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//打开&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureTorchModeAuto&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//自动&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;AVCaptureDeviceFocus-聚焦&quot;&gt;&lt;a href=&quot;#AVCaptureDeviceFocus-聚焦&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDeviceFocus(聚焦)&quot;&gt;&lt;/a&gt;AVCaptureDeviceFocus(聚焦)&lt;/h4&gt;&lt;p&gt;实现摄像头聚焦有两种情况：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;镜头位置(AVCaptureFocusMode)&lt;/li&gt;
&lt;li&gt;范围烧苗(AVCaptureAutoFocusRangeRestriction)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1）镜头位置(AVCaptureFocusMode)&lt;br&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isFocusModeSupported:&lt;span class=&quot;built_in&quot;&gt;AVCaptureFocusModeAutoFocus&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device lockForConfiguration:&amp;amp;error]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [device setFocusMode:&lt;span class=&quot;built_in&quot;&gt;AVCaptureFocusModeAutoFocus&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//设置聚焦在设备坐标的中点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (device.focusPointOfInterestSupported) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            device.focusPointOfInterest = &lt;span class=&quot;built_in&quot;&gt;CGPointMake&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;0.5&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [device unlockForConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上述代码实现聚焦在设备坐标 中心位置。&lt;/p&gt;
&lt;p&gt;下面👇列出实现聚焦设置类型：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFocusModeLocked&lt;/span&gt;              = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//锁定当前镜头位置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFocusModeAutoFocus&lt;/span&gt;           = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//镜头自动调焦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureFocusModeContinuousAutoFocus&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//镜头连续自动调焦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;AVCaptureDeviceExposure-曝光&quot;&gt;&lt;a href=&quot;#AVCaptureDeviceExposure-曝光&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDeviceExposure(曝光)&quot;&gt;&lt;/a&gt;AVCaptureDeviceExposure(曝光)&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isExposureModeSupported:&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeAutoExpose&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device lockForConfiguration:&amp;amp;error]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         [device setExposureMode:&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeAutoExpose&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     [device unlockForConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上述代码实现自动调节曝光。&lt;/p&gt;
&lt;p&gt;下面列出相关曝光设置类型：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeLocked&lt;/span&gt;                            = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//锁定&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeAutoExpose&lt;/span&gt;                        = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//自动对焦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeContinuousAutoExposure&lt;/span&gt;            = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//实现连续自动对焦&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureExposureModeCustom&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NS_ENUM_AVAILABLE_IOS&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;_0) = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//通过 ISO 和 曝光时间实现&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;AVCaptureDeviceWhiteBalance-白平衡&quot;&gt;&lt;a href=&quot;#AVCaptureDeviceWhiteBalance-白平衡&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDeviceWhiteBalance(白平衡)&quot;&gt;&lt;/a&gt;AVCaptureDeviceWhiteBalance(白平衡)&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;类型设置(AVCaptureWhiteBalanceMode)&lt;/li&gt;
&lt;li&gt;RGB具体值(AVCaptureWhiteBalanceGains)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1）类型设置白平衡&lt;br&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device isWhiteBalanceModeSupported:&lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceModeAutoWhiteBalance&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device lockForConfiguration:&amp;amp;error]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         [device setWhiteBalanceMode:&lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceModeAutoWhiteBalance&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     [device unlockForConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上述实现白平衡自动调整设置，下面👇列出白平衡类型：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceModeLocked&lt;/span&gt;                     = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceModeAutoWhiteBalance&lt;/span&gt;           = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceModeContinuousAutoWhiteBalance&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2）RGB 值设置白平衡&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *device = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt; *inputs = &lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt;.session.inputs;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *input &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; inputs) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([device.deviceType isEqual:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         device = input.device;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;float&lt;/span&gt; maxWhiteBalance = device.maxWhiteBalanceGain;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;float&lt;/span&gt; redGain =  MIN(&lt;span class=&quot;number&quot;&gt;2.0&lt;/span&gt;, maxWhiteBalance);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;float&lt;/span&gt; greenGain = MIN(&lt;span class=&quot;number&quot;&gt;2.0&lt;/span&gt;, maxWhiteBalance);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;float&lt;/span&gt; blueGain = MIN(&lt;span class=&quot;number&quot;&gt;2.0&lt;/span&gt;, maxWhiteBalance);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;built_in&quot;&gt;AVCaptureWhiteBalanceGains&lt;/span&gt; whiteBalanceGains = &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     redGain,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     greenGain,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     blueGain&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; [device setWhiteBalanceModeLockedWithDeviceWhiteBalanceGains:whiteBalanceGains completionHandler:&lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h4 id=&quot;额外附加功能&quot;&gt;&lt;a href=&quot;#额外附加功能&quot; class=&quot;headerlink&quot; title=&quot;额外附加功能&quot;&gt;&lt;/a&gt;额外附加功能&lt;/h4&gt;&lt;p&gt;附加功能：可以获取 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 一些相关的参数。&lt;/p&gt;
&lt;p&gt;例如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;视频录制过程中 &lt;code&gt;min&lt;/code&gt; 和 &lt;code&gt;max&lt;/code&gt; 的帧率和帧时间间隔。 &lt;/li&gt;
&lt;li&gt;曝光 &lt;code&gt;ISO&lt;/code&gt; 的 &lt;code&gt;min&lt;/code&gt; 和 &lt;code&gt;max&lt;/code&gt; 值和曝光时间的 &lt;code&gt;min&lt;/code&gt; 和 &lt;code&gt;max&lt;/code&gt; 值等。&lt;/li&gt;
&lt;li&gt;输入的独一的 &lt;code&gt;ID&lt;/code&gt; 和输入源的设备 名字（&lt;code&gt;localizedName&lt;/code&gt;）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturedevice?changes=latest_minor&amp;amp;language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureDevice&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturedeviceposition&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureDevicePosition&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturetorchmode?language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureTorchMode&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcaptureflashmode?language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureFlashMode&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturefocusmode?language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureFocusMode&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcaptureexposuremode?language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureExposureMode&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturewhitebalancemode?language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureWhiteBalanceMode&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://support.vsco.co/hc/en-us/articles/203226980-Advanced-Camera-Controls-for-iOS-Setting-Manual-White-Balance&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Advanced Camera Controls for iOS: Setting Manual White Balance&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第一次发布：2017/8/15 23:16:32 星期二&lt;br&gt;第二次发布：2017/8/16 00:17:59 星期三&lt;br&gt;第三次发布：2017/8/16 20:53:56 星期三&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;承接上一篇博文小编讲述在镜头采集过程所需知识点和 &lt;code&gt;AVCaptureSession&lt;/code&gt; 基本使用方法，本篇博文将要讲述 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 相关使用方法。&lt;/p&gt;
&lt;p&gt;下图为本博文写作思路：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-02f3ce2f37fba73c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;AVCaptureDevice博文写作思维导图.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS-镜头采集(Camera capture &amp; AVCaptureSession)</title>
    <link href="http://yoursite.com/2017/08/11/iOS-Camera%20Capture%20(iOS%20%E9%95%9C%E5%A4%B4%E9%87%87%E9%9B%86)/"/>
    <id>http://yoursite.com/2017/08/11/iOS-Camera Capture (iOS 镜头采集)/</id>
    <published>2017-08-10T16:07:15.000Z</published>
    <updated>2017-08-25T09:26:48.000Z</updated>
    
    <content type="html">&lt;p&gt;iPhone 手机在图片拍照和视频录制方面有很强大的功能，小编认为如果很好使用 iPhone 拍摄出很好照片 &amp;amp; 录制很有趣的视频。本章将详细讲解 &lt;code&gt;AVCaptureSession&lt;/code&gt; ，并最后给出 &lt;code&gt;FYCameraKit&lt;/code&gt; 项目Demo。&lt;br&gt;下面小编为大家讲解 iOS 拍照和视频录制功能实现，下图是镜头采集需要的类：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-b727b7f54b3df9bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-Camera Capture (iOS 镜头采集).png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;总体介绍&quot;&gt;&lt;a href=&quot;#总体介绍&quot; class=&quot;headerlink&quot; title=&quot;总体介绍&quot;&gt;&lt;/a&gt;总体介绍&lt;/h2&gt;&lt;p&gt;在整个镜头采集过程小编把整个过程比作我们常见发电过程：均是通过特定的步骤实现得到最后的产物。下面👇做详细解释：&lt;/p&gt;
&lt;h3 id=&quot;AVCaptureSession-发电机&quot;&gt;&lt;a href=&quot;#AVCaptureSession-发电机&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureSession (发电机)&quot;&gt;&lt;/a&gt;AVCaptureSession (发电机)&lt;/h3&gt;&lt;p&gt;&lt;code&gt;AVCaptureSession&lt;/code&gt; ：作为音视频捕捉会话，把镜头和麦克风捕捉到的音视频源输出到设备中。&lt;br&gt;提示：可以有多个输入和输出。&lt;/p&gt;
&lt;h3 id=&quot;AVCaptureDevice-发电设备&quot;&gt;&lt;a href=&quot;#AVCaptureDevice-发电设备&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureDevice (发电设备)&quot;&gt;&lt;/a&gt;AVCaptureDevice (发电设备)&lt;/h3&gt;&lt;p&gt;&lt;code&gt;AVCaptureDevice&lt;/code&gt;：输入设备，包括：摄像头和麦克风。可以通过设置一些参数来调节设备采集效果（例如：曝光，白平衡和聚焦等）。&lt;/p&gt;
&lt;h3 id=&quot;AVCaptureInput-水风能源&quot;&gt;&lt;a href=&quot;#AVCaptureInput-水风能源&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureInput (水风能源)&quot;&gt;&lt;/a&gt;AVCaptureInput (水风能源)&lt;/h3&gt;&lt;p&gt;&lt;code&gt;AVCaptureInput&lt;/code&gt;：输入数据管理对象，经过 AVCaptureDevice 实现初始化，然后添加到 AVCaptureSession (发电机) 中进行相应的输出。&lt;br&gt;子类：&lt;code&gt;AVCaptureDeviceInput&lt;/code&gt;、&lt;code&gt;AVCaptureScreenInput&lt;/code&gt;和&lt;code&gt;AVCaptureMetadataInput&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&quot;AVCaptureOutput-电力&quot;&gt;&lt;a href=&quot;#AVCaptureOutput-电力&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureOutput (电力)&quot;&gt;&lt;/a&gt;AVCaptureOutput (电力)&lt;/h3&gt;&lt;p&gt;&lt;code&gt;AVCaptureOut&lt;/code&gt;：数据输出管理，通过 AVCaptureSession 中输出。可以通过相关的协议实对应的数据输出。&lt;br&gt;子类：&lt;code&gt;AVCaptureFileOutput&lt;/code&gt;、&lt;code&gt;AVCapturePhotoOutput&lt;/code&gt;、&lt;code&gt;AVCaptureStillImageOutput&lt;/code&gt;、&lt;code&gt;AVCaptureVideoDataOutput&lt;/code&gt;、&lt;code&gt;AVCaptureAudioDataOutput&lt;/code&gt;、&lt;code&gt;AVCaptureAudioPreviewOutput&lt;/code&gt;、&lt;code&gt;AVCaptureDepthDataOutput&lt;/code&gt;和&lt;code&gt;AVCaptureMetadataOutput&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&quot;AVCaptureVideoPreviewLayer-发电预览&quot;&gt;&lt;a href=&quot;#AVCaptureVideoPreviewLayer-发电预览&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureVideoPreviewLayer (发电预览)&quot;&gt;&lt;/a&gt;AVCaptureVideoPreviewLayer (发电预览)&lt;/h3&gt;&lt;p&gt;&lt;code&gt;AVCaptureVideoPreviewLayer&lt;/code&gt;：可以支持在拍摄过程中进行相关的预览，只需要在初始时实现对应的 AVCaptureSession 即可。&lt;/p&gt;
&lt;h2 id=&quot;视频录制&quot;&gt;&lt;a href=&quot;#视频录制&quot; class=&quot;headerlink&quot; title=&quot;视频录制&quot;&gt;&lt;/a&gt;视频录制&lt;/h2&gt;&lt;p&gt;下面展示在苹果官方开发文档给出的图：&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-4cbf9ba736afdb69.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-Video Capture(iOS 视频录制).png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;视频录制总概&quot;&gt;&lt;a href=&quot;#视频录制总概&quot; class=&quot;headerlink&quot; title=&quot;视频录制总概&quot;&gt;&lt;/a&gt;视频录制总概&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;创建 &lt;code&gt;AVCaptureSession&lt;/code&gt; 对象&lt;/li&gt;
&lt;li&gt;使用 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 静态方法获取设备常使用设备，例如：拍照和录像需要的摄像头，录音所需的麦克风&lt;/li&gt;
&lt;li&gt;利用输入设备 &lt;code&gt;AVCaptureDevice&lt;/code&gt; 初始化 &lt;code&gt;AVCaptureDeviceInput&lt;/code&gt; 对象&lt;/li&gt;
&lt;li&gt;初始化输出数据管理对象，拍照进行初始化 &lt;code&gt;AVCaptureStillImageOutput&lt;/code&gt; 对象，拍照初始化 &lt;code&gt;AVCaptureMovieFileOutput&lt;/code&gt; 对象&lt;/li&gt;
&lt;li&gt;将数据输入对象 &lt;code&gt;AVCaptureDeviceInput&lt;/code&gt;  和数据输出对象   &lt;code&gt;AVCaptureDeviceOutput&lt;/code&gt;  添加到媒体会话管理对象   &lt;code&gt;AVCaptureSession&lt;/code&gt; 中&lt;/li&gt;
&lt;li&gt;创建预览的图层   &lt;code&gt;AVCaptureVideoPreviewLayer&lt;/code&gt;   指定媒体会话，添加图层到容器，调用  &lt;code&gt;AVCaptureSession&lt;/code&gt;  中的 &lt;code&gt;StartRunning&lt;/code&gt;  方法开始捕捉&lt;/li&gt;
&lt;li&gt;将捕捉到内容保存到指定文件中&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;详解镜头采集类&quot;&gt;&lt;a href=&quot;#详解镜头采集类&quot; class=&quot;headerlink&quot; title=&quot;详解镜头采集类&quot;&gt;&lt;/a&gt;详解镜头采集类&lt;/h2&gt;&lt;h3 id=&quot;AVCaptureSession&quot;&gt;&lt;a href=&quot;#AVCaptureSession&quot; class=&quot;headerlink&quot; title=&quot;AVCaptureSession&quot;&gt;&lt;/a&gt;AVCaptureSession&lt;/h3&gt;&lt;p&gt;小编查看 &lt;code&gt;AVCaptureSession.h&lt;/code&gt;文件看到，在镜头采集的过程中有两种实现方式。&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;使用系统 &lt;code&gt;AVCaptureSession&lt;/code&gt;自动配置输入和输出&lt;/li&gt;
&lt;li&gt;手动配置输入和输出之间的对应关系&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;（1） AVCaptureSession 初始化&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用&lt;code&gt;AVCaptureSession&lt;/code&gt; 自动配置输入和输出之间对应关系&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureSession&lt;/span&gt; *captureSession = [[&lt;span class=&quot;built_in&quot;&gt;AVCaptureSession&lt;/span&gt; alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *audioCaptureDevice = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; defaultDeviceWithMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeAudio&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *audioInput = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; deviceInputWithDevice:audioCaptureDevice error:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[captureSession beginConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (audioInput) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//// Handle the failure.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [captureSession commitConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([captureSession canAddInput:audioInput]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [captureSession addInput:audioInput];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Handle the failure.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [captureSession commitConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面代码是 &lt;code&gt;AVCaptureSession&lt;/code&gt; 进行初始化并且实现初始化麦克风进行相关音频录制，并添加到 &lt;code&gt;AVCaptureSession&lt;/code&gt;中。&lt;br&gt;&lt;code&gt;beginConfiguration&lt;/code&gt; &amp;amp; &lt;code&gt;commitConfiguration&lt;/code&gt; 在进行配置 &lt;code&gt;AVCaptureSession&lt;/code&gt; 的相关属性值时需要对这两个函数调用，并且这两个函数是成对出现。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;手动配置 &lt;code&gt;AVCaptureSession&lt;/code&gt; 输入和输出之间对应关系&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureSession&lt;/span&gt; *session = [[&lt;span class=&quot;built_in&quot;&gt;AVCaptureSession&lt;/span&gt; alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [session beginConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *videoDevice = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; defaultDeviceWithMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeVideo&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *videoInput = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; deviceInputWithDevice:videoDevice error:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!videoInput) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//handle configuration video device&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureInputPort&lt;/span&gt; *videoPort = videoInput.ports[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; *audioDevice = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDevice&lt;/span&gt; defaultDeviceWithMediaType:&lt;span class=&quot;built_in&quot;&gt;AVMediaTypeAudio&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; *audioInput = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureDeviceInput&lt;/span&gt; deviceInputWithDevice:audioDevice error:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!videoInput) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//handle configuration audio device&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureInputPort&lt;/span&gt; *audioPort = audioInput.ports[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSArray&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureInputPort&lt;/span&gt; *&amp;gt; *inputPorts = @[videoPort, audioPort];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureVideoDataOutput&lt;/span&gt; *videoDataOutput = [[&lt;span class=&quot;built_in&quot;&gt;AVCaptureVideoDataOutput&lt;/span&gt; alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureConnection&lt;/span&gt; *connection = [&lt;span class=&quot;built_in&quot;&gt;AVCaptureConnection&lt;/span&gt; connectionWithInputPorts:inputPorts output:videoDataOutput];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ([session canAddConnection:connection]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [session addConnection:connection];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;//handle session can not add AVCaptureConnection&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [session commitConfiguration];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [session commitConfiguration];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上面👆代码是使用 &lt;code&gt;AVCaptureConnection&lt;/code&gt;实现在 &lt;code&gt;AVCaptureSession&lt;/code&gt; 使输入和输出进行自己配置。&lt;br&gt;详细的细节会在 &lt;code&gt;FYCameraKit&lt;/code&gt; 进行详细的讲解。 &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注释：&lt;br&gt;1）只有在调用 &lt;code&gt;beginConfiguration&lt;/code&gt; 时我们对 &lt;code&gt;AVCaptureSession&lt;/code&gt; 配置才会被真正开始修改。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;（2） AVCaptureSession 中断&lt;/p&gt;
&lt;p&gt;在音视频录制过程中可能对因为电话导致中断，开发过程中提供中断结束后获取中断产生的原因。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;注册中断监听 &amp;amp; 删除监听&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//监听注册&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[[&lt;span class=&quot;built_in&quot;&gt;NSNotificationCenter&lt;/span&gt; defaultCenter] addObserver:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; selector:&lt;span class=&quot;keyword&quot;&gt;@selector&lt;/span&gt;(handleCaptureSession:) name:&lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionEndedNotification&lt;/span&gt; object:_session];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//监听清除   &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[[&lt;span class=&quot;built_in&quot;&gt;NSNotificationCenter&lt;/span&gt; defaultCenter] removeObserver:&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; name:&lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionEndedNotification&lt;/span&gt; object:_session];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;从传递的 &lt;code&gt;userInfo&lt;/code&gt; 通过关键 &lt;code&gt;key&lt;/code&gt; 获取原因：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonKey&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;获取具体的中断原因：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NS_ENUM&lt;/span&gt;(&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReason&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceNotAvailableInBackground&lt;/span&gt;               = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//从后台运行开启 camera，不够 iOS 9.0 之后不提供中断 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonAudioDeviceInUseByAnotherClient&lt;/span&gt;                   = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//音频软软件被占用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceInUseByAnotherClient&lt;/span&gt;                   = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//视频软件被占用&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceNotAvailableWithMultipleForegroundApps&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;comment&quot;&gt;//全屏或者是录制屏幕变化&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;监听事件的处理&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)handleCaptureSession:(&lt;span class=&quot;built_in&quot;&gt;NSNotification&lt;/span&gt; *)notification &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReason&lt;/span&gt; reason = [[notification.userInfo objectForKey:&lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonKey&lt;/span&gt;] unsignedIntegerValue];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;switch&lt;/span&gt; (reason) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceNotAvailableInBackground&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;//handle device not available background&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonAudioDeviceInUseByAnotherClient&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;//handle that audio was occupied  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceInUseByAnotherClient&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;//handle that video was occupied  &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;AVCaptureSessionInterruptionReasonVideoDeviceNotAvailableWithMultipleForegroundApps&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &lt;span class=&quot;comment&quot;&gt;//handle that UI was multiple&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;实现拍照和视频录制的 &lt;code&gt;FYCameraKit&lt;/code&gt; 的下载地址： &lt;a href=&quot;https://github.com/boilWater/FYCameraKit&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;FYCameraKit&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;参考资料：&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturesession?changes=latest_minor&amp;amp;language=objc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureSession&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcapturedevice&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureDevice&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/documentation/avfoundation/avcaptureconnection?changes=latest_minor&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AVCaptureConnection&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;第一次发布：2017/8/10 20:49:21 星期四&lt;br&gt;第二次发布：2017/8/10 23:36:34 星期四&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;iPhone 手机在图片拍照和视频录制方面有很强大的功能，小编认为如果很好使用 iPhone 拍摄出很好照片 &amp;amp; 录制很有趣的视频。本章将详细讲解 &lt;code&gt;AVCaptureSession&lt;/code&gt; ，并最后给出 &lt;code&gt;FYCameraKit&lt;/code&gt; 项目Demo。&lt;br&gt;下面小编为大家讲解 iOS 拍照和视频录制功能实现，下图是镜头采集需要的类：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-b727b7f54b3df9bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-Camera Capture (iOS 镜头采集).png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS-视频大纲总结</title>
    <link href="http://yoursite.com/2017/06/09/iOS-%E8%A7%86%E9%A2%91%E5%A4%A7%E7%BA%B2%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2017/06/09/iOS-视频大纲总结/</id>
    <published>2017-06-08T16:31:48.000Z</published>
    <updated>2017-06-13T15:30:57.000Z</updated>
    
    <content type="html">&lt;p&gt;本次博客思路来自与公司的一次技术分享。前段时间被公司委派做视频相关的开发，就把视频总体内容梳理一下当做备忘。&lt;/p&gt;
&lt;p&gt;下面是本博文的写作思路：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-bbdb773a30fc44a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-视频大纲总结.png&quot;&gt;&lt;/p&gt;
&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;流媒体数据接收到播放&quot;&gt;&lt;a href=&quot;#流媒体数据接收到播放&quot; class=&quot;headerlink&quot; title=&quot;流媒体数据接收到播放&quot;&gt;&lt;/a&gt;流媒体数据接收到播放&lt;/h2&gt;&lt;p&gt;在网络传输过程中我们接收到相关媒体数据要经过一些列的处理来实现对媒体数据的播放，具体过程如下图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-aab07b57fde17c34.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS 视频播放流程图.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;可以看出我们在获取流媒体协议需要经过一下处理方式：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;解协议 —&amp;gt; 解封装  —&amp;gt; 音视频的解码 （实现音视频同步 &amp;amp; 播放）&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;流媒体数据解析&quot;&gt;&lt;a href=&quot;#流媒体数据解析&quot; class=&quot;headerlink&quot; title=&quot;流媒体数据解析&quot;&gt;&lt;/a&gt;流媒体数据解析&lt;/h3&gt;&lt;p&gt;在获取流媒体数据后，要对其进行协议的解析来获取封装的媒体数据进行播放。我们常见的协议：&lt;code&gt;HTTP&lt;/code&gt;、&lt;code&gt;RTMP&lt;/code&gt;和&lt;code&gt;MMS&lt;/code&gt;媒体协议&lt;/p&gt;
&lt;h4 id=&quot;协议简介&quot;&gt;&lt;a href=&quot;#协议简介&quot; class=&quot;headerlink&quot; title=&quot;协议简介&quot;&gt;&lt;/a&gt;协议简介&lt;/h4&gt;&lt;ul&gt;&lt;br&gt;&lt;li&gt;HTTP：超文本传输协议（HyperText Transfer Protocol）是一个客户端（用户）和服务端（网站）请求和应答的标准。&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/超文本传输协议&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;&lt;br&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;RTMP：实时信息传输协议（Real Time Message Protocol）基于TCP实现持久链接和低延迟通信。流分解成片，客户端和服务端可设置大小（音：64，视频：128）。&lt;br&gt;&lt;a href=&quot;http://mingyangshang.github.io/2016/03/06/RTMP协议/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址1：&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://translate.google.co.jp/translate?hl=zh-CN&amp;amp;sl=en&amp;amp;u=https://en.wikipedia.org/wiki/Real-Time_Messaging_Protocol&amp;amp;prev=search&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址2：&lt;/a&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;MMS：串流媒体传送协议（Microsoft Media Server）用来访问并流式接受 Windows Media 服务器中 .asf 文件协议。&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/MMS_(协议&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;)&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;HLS：流媒体网络传输协议（HTTP Live Streaming）把数据源分解为基于 HTTP 的片段，每次下载一些。下载数据之前需要一个包含数据的 m3u8 playlist文件来查找可用的媒体流。&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/HTTP_Live_Streaming&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;&lt;br&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;RTP：实时传输协议（Real-time Transport Protocol）被设置为多播协议，和 RTP 协议、RTP 控制协议一起使用。&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/实时传输协议&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;RTCP：实时传输控制协议（Real-time Transport Protocol）搜集媒体链接统计信息，为 RTP 提供服务质量反馈。&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/实时传输控制协议&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;&lt;br&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;RTSP：实时流协议，用于建立和控制终端之间的媒体会话，和 RTP 、RTCP 结合的，媒体流传输。&lt;br&gt;&lt;a href=&quot;https://translate.google.co.jp/translate?hl=zh-CN&amp;amp;sl=en&amp;amp;u=https://en.wikipedia.org/wiki/Real_Time_Streaming_Protocol&amp;amp;prev=search&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;参考地址：&lt;/a&gt;&lt;/li&gt;&lt;br&gt;&lt;/ul&gt;

&lt;h3 id=&quot;媒体封装格式&quot;&gt;&lt;a href=&quot;#媒体封装格式&quot; class=&quot;headerlink&quot; title=&quot;媒体封装格式&quot;&gt;&lt;/a&gt;媒体封装格式&lt;/h3&gt;&lt;p&gt;媒体封装就是把视频数据和音频数据进行按照一定的格式进行封装。我们常见的封装格式：&lt;code&gt;AVI&lt;/code&gt;、&lt;code&gt;MP4&lt;/code&gt;、&lt;code&gt;TS&lt;/code&gt;、&lt;code&gt;FLV&lt;/code&gt;、&lt;code&gt;MKV&lt;/code&gt;和&lt;code&gt;RMVB&lt;/code&gt;。&lt;/p&gt;
&lt;h4 id=&quot;媒体封装格式简介&quot;&gt;&lt;a href=&quot;#媒体封装格式简介&quot; class=&quot;headerlink&quot; title=&quot;媒体封装格式简介&quot;&gt;&lt;/a&gt;媒体封装格式简介&lt;/h4&gt;&lt;p&gt;下面是对媒体封装格式的整理和简介：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-0491caa322fa42c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;媒体封装格式整理.png&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;音视频编码格式&quot;&gt;&lt;a href=&quot;#音视频编码格式&quot; class=&quot;headerlink&quot; title=&quot;音视频编码格式&quot;&gt;&lt;/a&gt;音视频编码格式&lt;/h3&gt;&lt;p&gt;在音视频录制完成后为方便传输需要对其进行编码压缩处理，我们常见的音视频编码格式：&lt;/p&gt;
&lt;p&gt;视频编码格式：&lt;code&gt;H.264&lt;/code&gt;、&lt;code&gt;H.265(HEVC)&lt;/code&gt;、&lt;code&gt;MPEG4&lt;/code&gt;、&lt;code&gt;MPEG2&lt;/code&gt;、&lt;code&gt;VP9&lt;/code&gt;、&lt;code&gt;VP8&lt;/code&gt;和&lt;code&gt;VC-1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;音频编码格式：&lt;code&gt;AAC&lt;/code&gt;、&lt;code&gt;AC-3&lt;/code&gt;、&lt;code&gt;MP3&lt;/code&gt;和&lt;code&gt;WMP&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&quot;视音频编码格式&quot;&gt;&lt;a href=&quot;#视音频编码格式&quot; class=&quot;headerlink&quot; title=&quot;视音频编码格式&quot;&gt;&lt;/a&gt;视音频编码格式&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-1e3ce321225f5706.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;视音频编码格式.png&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;编码格式地址&quot;&gt;&lt;a href=&quot;#编码格式地址&quot; class=&quot;headerlink&quot; title=&quot;编码格式地址&quot;&gt;&lt;/a&gt;编码格式地址&lt;/h4&gt;&lt;p&gt;下面是编码格式地址：&lt;/p&gt;
&lt;p&gt;H.264 :&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;地址&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;链接        &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;地址1&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/H.264/MPEG-4_AVC&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/wiki/H.264/MPEG-4_AVC&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;地址2&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;&lt;a href=&quot;https://abson.github.io/2016/11/15/深入浅出理解视频编码H264结构/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://abson.github.io/2016/11/15/深入浅出理解视频编码H264结构/&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;H.265 :&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;地址&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;链接        &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;地址1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;www.4k123.com/thread-6369-1-1.html&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;AAC：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;地址&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;链接        &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;地址1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;www.4k123.com/thread-6369-1-1.html&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;AC-3：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;地址&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;链接        &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;地址1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;blog.csdn.net/leixiaohua1020/article/details/11822737&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;MP3：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;地址&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;链接        &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;地址1&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;https://zh.wikipedia.org/zh-hans/MP3&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/zh-hans/MP3&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;解码简介&quot;&gt;&lt;a href=&quot;#解码简介&quot; class=&quot;headerlink&quot; title=&quot;解码简介&quot;&gt;&lt;/a&gt;解码简介&lt;/h3&gt;&lt;p&gt;在视频播放过程中我们需要对视频进行解码处理，常见的解码方式：硬解码和软解码。&lt;/p&gt;
&lt;h4 id=&quot;解码方式简介&quot;&gt;&lt;a href=&quot;#解码方式简介&quot; class=&quot;headerlink&quot; title=&quot;解码方式简介&quot;&gt;&lt;/a&gt;解码方式简介&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-b70e26b3769a95c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;软解码&amp;amp;硬解码对比.png&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;编码资料地址&quot;&gt;&lt;a href=&quot;#编码资料地址&quot; class=&quot;headerlink&quot; title=&quot;编码资料地址&quot;&gt;&lt;/a&gt;编码资料地址&lt;/h4&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;框架名称&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;资料地址-1&lt;/th&gt;
&lt;th&gt;资料地址-2&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;AVFoundation&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;http://yoferzhang.com/post/20160803AVFoundation01Introduction/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://yoferzhang.com/post/20160803AVFoundation01Introduction/&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;http://www.superqq.com/blog/2015/08/24/avfoundation-gpuimage-find/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.superqq.com/blog/2015/08/24/avfoundation-gpuimage-find/&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;VideoToolBox&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;http://www.4k123.com/thread-6369-1-1.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.4k123.com/thread-6369-1-1.html&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;FFMpeg&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;blog.csdn.net/leixiaohua1020/article/category/1360795&lt;/td&gt;
&lt;td&gt;www.tuicool.com/articles/22A7na3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;code&gt;CPU&lt;/code&gt; &amp;amp; &lt;code&gt;GPU&lt;/code&gt; 的参考：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;框架名称&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;资料地址-1&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;CPU&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/中央处理器&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/wiki/中央处理器&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;GPU&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;&lt;a href=&quot;https://zh.wikipedia.org/zh/圖形處理器&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://zh.wikipedia.org/zh/圖形處理器&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;AVFoundation-框架介绍&quot;&gt;&lt;a href=&quot;#AVFoundation-框架介绍&quot; class=&quot;headerlink&quot; title=&quot;AVFoundation 框架介绍&quot;&gt;&lt;/a&gt;AVFoundation 框架介绍&lt;/h3&gt;&lt;p&gt;AVFoundation 可以用来播放和创建基于时间视听媒体的框架之一，提供基于时间的视听数据详细的 Objective-C上的接口。&lt;/p&gt;
&lt;h4 id=&quot;AVFoundation-功能介绍&quot;&gt;&lt;a href=&quot;#AVFoundation-功能介绍&quot; class=&quot;headerlink&quot; title=&quot;AVFoundation 功能介绍&quot;&gt;&lt;/a&gt;AVFoundation 功能介绍&lt;/h4&gt;&lt;p&gt;使用 &lt;code&gt;AVFoundation&lt;/code&gt; 可以实现视频的播放、编辑、静态媒体的捕捉、输出和时间媒体的表现等功能，如果仅仅是播放电影的话可以使用 &lt;code&gt;AVKit&lt;/code&gt;框架。 &lt;/p&gt;
&lt;h4 id=&quot;AVFoundation-接口介绍&quot;&gt;&lt;a href=&quot;#AVFoundation-接口介绍&quot; class=&quot;headerlink&quot; title=&quot;AVFoundation 接口介绍&quot;&gt;&lt;/a&gt;AVFoundation 接口介绍&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-c3069ae787712d75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-AVFoundation-AVMutableComposition-AVAssetTrack.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-ed13785f38e3a77c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-AVFoundation-AVMutableComposition-AVMutableAudioMix.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-1ee84500bda738b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-AVFoundation-AVMutableComposition-AVMutableVideoComposition.png&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-9993bccb095d6642.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-AVFoundation-AVMutableComposition-AVAssetExportSession.png&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;AVFoundation-类继承关系&quot;&gt;&lt;a href=&quot;#AVFoundation-类继承关系&quot; class=&quot;headerlink&quot; title=&quot;AVFoundation 类继承关系&quot;&gt;&lt;/a&gt;AVFoundation 类继承关系&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/boilWater/boilWater.github.io/tree/master/Images/PPT&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;公司分享 PPT 下载地址&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;本次博客思路来自与公司的一次技术分享。前段时间被公司委派做视频相关的开发，就把视频总体内容梳理一下当做备忘。&lt;/p&gt;
&lt;p&gt;下面是本博文的写作思路：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-bbdb773a30fc44a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS-视频大纲总结.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS-开发过程中的错误处理</title>
    <link href="http://yoursite.com/2017/05/31/NSError(%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF)/"/>
    <id>http://yoursite.com/2017/05/31/NSError(错误信息)/</id>
    <published>2017-05-31T06:35:13.000Z</published>
    <updated>2017-06-01T09:51:07.000Z</updated>
    
    <content type="html">&lt;p&gt;开发过过程中我们经常会遇到异常问题&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-ebec37c09e21ba91.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS异常.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;iOS-开发过程中的错误处理&quot;&gt;&lt;a href=&quot;#iOS-开发过程中的错误处理&quot; class=&quot;headerlink&quot; title=&quot;iOS-开发过程中的错误处理&quot;&gt;&lt;/a&gt;iOS-开发过程中的错误处理&lt;/h1&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;我们在程序开发过程中经常会遇到异常，对异常的处理一般采用打印或者直接抛出。这样也可以很方便我们调试过程有所参考，而且方便我们查看异常产生的位置信息&lt;/p&gt;
&lt;h3 id=&quot;NSError-错误信息&quot;&gt;&lt;a href=&quot;#NSError-错误信息&quot; class=&quot;headerlink&quot; title=&quot;NSError(错误信息)&quot;&gt;&lt;/a&gt;NSError(错误信息)&lt;/h3&gt;&lt;h4 id=&quot;采用NSError的情况&quot;&gt;&lt;a href=&quot;#采用NSError的情况&quot; class=&quot;headerlink&quot; title=&quot;采用NSError的情况&quot;&gt;&lt;/a&gt;采用NSError的情况&lt;/h4&gt;&lt;p&gt;  使用 &lt;code&gt;NSError&lt;/code&gt; 的形式可以把程序中导致错误原因回报给调用者，而且使程序正常运行不会造成奔溃的后果&lt;/p&gt;
&lt;h4 id=&quot;NSError包含的内容&quot;&gt;&lt;a href=&quot;#NSError包含的内容&quot; class=&quot;headerlink&quot; title=&quot;NSError包含的内容&quot;&gt;&lt;/a&gt;NSError包含的内容&lt;/h4&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@interface&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;NSError&lt;/span&gt; : &lt;span class=&quot;title&quot;&gt;NSObject&lt;/span&gt; &amp;lt;&lt;span class=&quot;title&quot;&gt;NSCopying&lt;/span&gt;, &lt;span class=&quot;title&quot;&gt;NSSecureCoding&lt;/span&gt;&amp;gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@private&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *_reserved;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; _code;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *_domain;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *_userInfo;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;NSError _code&lt;/code&gt;（错误码， 类型 &lt;code&gt;NSInteger&lt;/code&gt;)  ： 独有的错误代码，指明在某个范围内具体发生的错误。可能是一系列的错误的集合，所以可以使用 Enum 来定义。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NSError *_domain&lt;/code&gt; (错误范围，类型 &lt;code&gt;NSString&lt;/code&gt;) ：错误发生范围，通常使用一个特有的全局变量来定义。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;NSError *_userInfo&lt;/code&gt; (用户信息，类型 &lt;code&gt;NSDictionary&lt;/code&gt;) ：有关错误的额外信息，其中包含一段“本地化的描述”，还可能包含导致此错误发生的另一个错误。userInfo 可以描述为一条错误的链条&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;NSError使用的两种情况&quot;&gt;&lt;a href=&quot;#NSError使用的两种情况&quot; class=&quot;headerlink&quot; title=&quot;NSError使用的两种情况&quot;&gt;&lt;/a&gt;NSError使用的两种情况&lt;/h4&gt;&lt;p&gt;   在方法实现或者是 API 设计时，我们对 &lt;code&gt;NSError&lt;/code&gt; 的使用情形有两种：在协议中传递和“输出参数”返回给调用者&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过委托协议来传递错误&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt;)connection:(&lt;span class=&quot;built_in&quot;&gt;NSURLConnection&lt;/span&gt; *)connection withError:(&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; *)error;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过代理协议的方式可以把错误报告信息传递&lt;/p&gt;
&lt;p&gt;  2.“输出参数”返回给调用者&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt;)doSomething:(&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; **)error;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;错误的信息作为一个指向指针的指针（也就是说一个指针指向错误的对象）&lt;/p&gt;
&lt;h3 id=&quot;throw-NSException-异常抛出&quot;&gt;&lt;a href=&quot;#throw-NSException-异常抛出&quot; class=&quot;headerlink&quot; title=&quot;@throw NSException (异常抛出)&quot;&gt;&lt;/a&gt;@throw NSException (异常抛出)&lt;/h3&gt;&lt;h4 id=&quot;采用-throw-情况&quot;&gt;&lt;a href=&quot;#采用-throw-情况&quot; class=&quot;headerlink&quot; title=&quot;采用 @throw 情况&quot;&gt;&lt;/a&gt;采用 @throw 情况&lt;/h4&gt;&lt;p&gt;在 APP 运行期间遇到问题，需要对问题进行操作终止程序抛出异常，可以使用 &lt;code&gt;@throw&lt;/code&gt; 来进行&lt;/p&gt;
&lt;h4 id=&quot;采用-throw-可能产生问题&quot;&gt;&lt;a href=&quot;#采用-throw-可能产生问题&quot; class=&quot;headerlink&quot; title=&quot;采用 @throw 可能产生问题&quot;&gt;&lt;/a&gt;采用 @throw 可能产生问题&lt;/h4&gt;&lt;p&gt;在异常抛出实例中，如果抛出异常。在实现抛出异常的代码后面的执行释放资源就不会执行，这样末尾的对象就不会被释放。如果想要生成“异常安全”的代码，可以设置编译器的标志 &lt;code&gt;-fobjc-arc-exceptions&lt;/code&gt; 来进行实现。不过将要一如加一些额外的代码，在不抛出异常时也会执行代码。&lt;br&gt;在不使用 ARC 时也很难实现异常抛出情况下对内存进行释放。&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt; * error = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;BOOL&lt;/span&gt; success = [&lt;span class=&quot;keyword&quot;&gt;self&lt;/span&gt; doSomething:&amp;amp;error];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(error &amp;amp;&amp;amp; success) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;@throw&lt;/span&gt;[&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; …];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[success release];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;按照上面👆实现当在异常抛出的过程时，success 还来不及释放。所以要解决上面的问题可以在异常抛出之前对 success 进行释放，但是当需要释放的资源有很多的情况下，这样操作起来就比较复杂。&lt;/p&gt;
&lt;p&gt;在开发过程中异常抛出可以使用在 抽象的基类 实例方法中进行调用。如果基类中的方法不被 &lt;code&gt;override&lt;/code&gt; 就设置抛出异常，这样可以保证实例方法被重写。&lt;/p&gt;
&lt;h3 id=&quot;try-catch-finally-异常捕捉&quot;&gt;&lt;a href=&quot;#try-catch-finally-异常捕捉&quot; class=&quot;headerlink&quot; title=&quot;@try @catch @finally (异常捕捉)&quot;&gt;&lt;/a&gt;@try @catch @finally (异常捕捉)&lt;/h3&gt;&lt;h4 id=&quot;采用-try-catch-finally-情况&quot;&gt;&lt;a href=&quot;#采用-try-catch-finally-情况&quot; class=&quot;headerlink&quot; title=&quot;采用 @try @catch @finally 情况&quot;&gt;&lt;/a&gt;采用 @try @catch @finally 情况&lt;/h4&gt;&lt;p&gt;个人感觉 @try @catch @finally 是 @throw NSException 的加强版。前者可以实现对异常的捕捉，相关异常的输出，和异常输出后执行的 @finally 相关的具体操作。后者是对具体整理 NSExpection 抛出，并没有前者比较完善的流程化操作步骤。&lt;/p&gt;
&lt;p&gt;如果在基类中实现 @throw 进行设置 必须 override 基类中的实例方法，那么捕获异常的方法中使用 @try @catch @finally。例如：NSArray，NSDictionary 初始变量使用字面量来获取值时，需要判断返回数据是否为 nil 来防止 APP Crash。 &lt;/p&gt;
&lt;h4 id=&quot;产生问题和解决方式&quot;&gt;&lt;a href=&quot;#产生问题和解决方式&quot; class=&quot;headerlink&quot; title=&quot;产生问题和解决方式&quot;&gt;&lt;/a&gt;产生问题和解决方式&lt;/h4&gt;&lt;p&gt;当使用 &lt;code&gt;@try @catch @finally&lt;/code&gt; 时，有两种情况 &lt;code&gt;MRC&lt;/code&gt; 和 &lt;code&gt;ARC&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;MRC&lt;/code&gt;（iOS 5 之前） 的环境中，上面的代码可以展示为：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;SomeClass *someClass = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       someClass = [[SomeClass alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       [someClass doSomeThingsThatMayThrow];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@catch&lt;/span&gt;() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(… …);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     [someClass release];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在 ARC 的环境中，上面的代码展示为：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;SomeClass *someClass = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       someClass = [[SomeClass alloc] init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       [someClass doSomeThingsThatMayThrow];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@catch&lt;/span&gt;( … ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(… …);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;@finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;blockquote&gt;
&lt;p&gt;可以看出在 MRC 的情形下可以实现对于内存的释放，在 ARC 的情形下会系统会实现对内存的释放? 这样向正确吗？&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;答案是：ARC 不会自动处理，因为如果要实现自动处理可能要加入大量的代码，才可以清楚对象实现抛出异常时将其清理。但是如果加入代码就会影响运行时的性能，在正常运行时也会如此。&lt;br&gt;如果在当前实现中开启 &lt;code&gt;-fobjc-arc-exception&lt;/code&gt; 的模式可以实现在 &lt;code&gt;@try @catch @finally&lt;/code&gt; 在异常情况下实现对未释放的对象进行内存的释放管理&lt;/p&gt;
&lt;h4 id=&quot;try-catch-finally-的-C-源码&quot;&gt;&lt;a href=&quot;#try-catch-finally-的-C-源码&quot; class=&quot;headerlink&quot; title=&quot;@try@catch@finally 的 C++ 源码&quot;&gt;&lt;/a&gt;@try@catch@finally 的 C++ 源码&lt;/h4&gt;&lt;p&gt;查看异常抛出的源码：&lt;br&gt;建立项目在 &lt;code&gt;main.m&lt;/code&gt; 文件中实现下面代码：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; main(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; * argv[]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@catch&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; *exception) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;打开终端在 &lt;code&gt;main.m&lt;/code&gt; 终端的文件夹路径执行下面的语句&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;会生成文件 &lt;code&gt;main.cpp&lt;/code&gt; 的文件，可以打开查看文 &lt;code&gt;@try @catch @fianlly&lt;/code&gt;&lt;/p&gt;
&lt;h5 id=&quot;NSExpection-属性内容&quot;&gt;&lt;a href=&quot;#NSExpection-属性内容&quot; class=&quot;headerlink&quot; title=&quot;NSExpection 属性内容&quot;&gt;&lt;/a&gt;NSExpection 属性内容&lt;/h5&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;__attribute__((__objc_exception__))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#ifndef _REWRITER_typedef_NSException&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#define _REWRITER_typedef_NSException&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; objc_object &lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&amp;#125; _objc_exc_NSException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#endif&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSException_IMPL&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSObject_IMPL&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSObject_IVARS&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;//实例变量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *name;                      &lt;span class=&quot;comment&quot;&gt;//exception 的名字&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *reason;                    &lt;span class=&quot;comment&quot;&gt;//exception 产生的原因&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *userInfo;              &lt;span class=&quot;comment&quot;&gt;//exception 展示使用详细的信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; reserved;                         &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&quot;NSError-属性内容&quot;&gt;&lt;a href=&quot;#NSError-属性内容&quot; class=&quot;headerlink&quot; title=&quot;NSError 属性内容&quot;&gt;&lt;/a&gt;NSError 属性内容&lt;/h5&gt;&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#ifndef _REWRITER_typedef_NSError&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#define _REWRITER_typedef_NSError&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; objc_object &lt;span class=&quot;built_in&quot;&gt;NSError&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &amp;#123;&amp;#125; _objc_exc_NSError;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#endif&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSError_IMPL&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSObject_IMPL&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;NSObject_IVARS&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;//实例变量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *_reserved;                     &lt;span class=&quot;comment&quot;&gt;//实例调用的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSInteger&lt;/span&gt; _code;                     &lt;span class=&quot;comment&quot;&gt;//error 错误码&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *_domain;                   &lt;span class=&quot;comment&quot;&gt;//error 错误发生范围&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *_userInfo;             &lt;span class=&quot;comment&quot;&gt;//error 错误描述的具体信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;下面在 &lt;code&gt;main.m&lt;/code&gt; 中使用 &lt;code&gt;Clang&lt;/code&gt; 解析 &lt;code&gt;@try @catch @finally&lt;/code&gt; 在 C++ 环境中解析&lt;/p&gt;
&lt;ul&gt;&lt;br&gt;&lt;li&gt;没有参数&lt;br&gt;&lt;/li&gt;&lt;br&gt;&lt;br&gt;&lt;li&gt;有参数&lt;br&gt;&lt;/li&gt;&lt;br&gt;&lt;/ul&gt;

&lt;h5 id=&quot;没有参数&quot;&gt;&lt;a href=&quot;#没有参数&quot; class=&quot;headerlink&quot; title=&quot;没有参数&quot;&gt;&lt;/a&gt;没有参数&lt;/h5&gt;&lt;p&gt;在没有参数的情况下&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@catch&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; *exception) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;经过 Clang 解析后源码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123; &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; _rethrow = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		         &lt;span class=&quot;comment&quot;&gt;//异常捕获&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		    &amp;#125; catch (_objc_exc_NSException *_exception) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		         &lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; *exception = (&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt;*)_exception; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		         &lt;span class=&quot;comment&quot;&gt;//捕获异常，并进行抛出&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	catch (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	     _rethrow = e;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	  &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; _FIN &amp;#123; _FIN(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; reth) : rethrow(reth) &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		~_FIN() &amp;#123; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (rethrow) objc_exception_throw(rethrow); &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; rethrow;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; _fin_force_rethow(_rethrow);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		   &lt;span class=&quot;comment&quot;&gt;//异常抛出后执行的 finally 的内容&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; IMAGE_INFO &amp;#123; &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; version; &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; flag; &amp;#125; _OBJC_IMAGE_INFO = &amp;#123; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h5 id=&quot;有参数&quot;&gt;&lt;a href=&quot;#有参数&quot; class=&quot;headerlink&quot; title=&quot;有参数&quot;&gt;&lt;/a&gt;有参数&lt;/h5&gt;&lt;p&gt;在有参数的情况下&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *dic = @&amp;#123;&lt;span class=&quot;string&quot;&gt;@&quot;name&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;@&quot;liang&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;string&quot;&gt;@&quot;last name&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;@&quot;bai&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;string&quot;&gt;@&quot;dream&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;@&quot;to be a bussinessman&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;string&quot;&gt;@&quot;work&quot;&lt;/span&gt;:&lt;span class=&quot;string&quot;&gt;@&quot;IT&quot;&lt;/span&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *salaryLiterals = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *salaryAtIndex = &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;@try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        salaryAtIndex = [dic objectForKey:&lt;span class=&quot;string&quot;&gt;@&quot;salary&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        salaryLiterals = dic[&lt;span class=&quot;string&quot;&gt;@&quot;salary&quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@catch&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; *exception) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;@&quot;error name is %@, reason : %@, userInfo : %@&quot;&lt;/span&gt;, exception.name, exception.reason, exception.userInfo);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;@finally&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;经过 Clang 解析后源码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight objc&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *dic = ((&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; *(*)(Class, SEL, &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; ObjectType *, &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; *, &lt;span class=&quot;built_in&quot;&gt;NSUInteger&lt;/span&gt;))(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)objc_msgSend)(objc_getClass(&lt;span class=&quot;string&quot;&gt;&quot;NSDictionary&quot;&lt;/span&gt;), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sel_registerName(&lt;span class=&quot;string&quot;&gt;&quot;dictionaryWithObjects:forKeys:count:&quot;&lt;/span&gt;), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; *)__NSContainer_literal(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;U, (&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_1,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_3, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_5, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_7).arr,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; *)__NSContainer_literal(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;U, (&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_0, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_2,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_4,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_6).arr, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;U);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *salary = __null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123; &lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; _rethrow = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;//使用 volatile 修饰的 _rethrow 记录异常的局部变量 &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			        salary = ((&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;  _Nullable (*)(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;, SEL, KeyType))(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)objc_msgSend)((&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)dic, sel_registerName(&lt;span class=&quot;string&quot;&gt;&quot;objectForKeyedSubscript:&quot;&lt;/span&gt;), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			  (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)(&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_8);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		    catch (_objc_exc_NSException *_exception) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		     &lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt; *exception = (&lt;span class=&quot;built_in&quot;&gt;NSException&lt;/span&gt;*)_exception; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		     &lt;span class=&quot;built_in&quot;&gt;NSLog&lt;/span&gt;((&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; *)&amp;amp;__NSConstantStringImpl__var_folders_tv_4c43vcqx24vcxx6d51n4ntc00000gn_T_main_753a25_mi_9,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		            ((&lt;span class=&quot;built_in&quot;&gt;NSExceptionName&lt;/span&gt; (*)(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;, SEL))(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)objc_msgSend)((&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)exception, sel_registerName(&lt;span class=&quot;string&quot;&gt;&quot;name&quot;&lt;/span&gt;)), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		            ((&lt;span class=&quot;built_in&quot;&gt;NSString&lt;/span&gt; * _Nullable (*)(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;, SEL))(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)objc_msgSend)((&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)exception, sel_registerName(&lt;span class=&quot;string&quot;&gt;&quot;reason&quot;&lt;/span&gt;)), &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		            ((&lt;span class=&quot;built_in&quot;&gt;NSDictionary&lt;/span&gt; * _Nullable (*)(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;, SEL))(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *)objc_msgSend)((&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt;)exception, sel_registerName(&lt;span class=&quot;string&quot;&gt;&quot;userInfo&quot;&lt;/span&gt;)));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		    &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		catch (&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		    _rethrow = e;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			 &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; _FIN &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			    _FIN(&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; reth) : rethrow(reth) &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				~_FIN() &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (rethrow) objc_exception_throw(rethrow); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;id&lt;/span&gt; rethrow;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			 &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			 _fin_force_rethow(_rethrow);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			    salary = __null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; IMAGE_INFO &amp;#123; &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; version; &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; flag; &amp;#125; _OBJC_IMAGE_INFO = &amp;#123; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;总结：&quot;&gt;&lt;a href=&quot;#总结：&quot; class=&quot;headerlink&quot; title=&quot;总结：&quot;&gt;&lt;/a&gt;总结：&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;（1）遇到奔溃问题或者是错误问题，优先使用 &lt;code&gt;NSError&lt;/code&gt; 来对奔溃和错误进行封装，然后使用 &lt;code&gt;NSLog&lt;/code&gt; 对其进行打印&lt;/p&gt;
&lt;p&gt;（2）&lt;code&gt;@try @catch @finally&lt;/code&gt; 在使用的过程中很方便，但是 &lt;code&gt;MRC&lt;/code&gt; 中如果变量较多可能会漏掉局部变量内存释放问题和 &lt;code&gt;ARC&lt;/code&gt; 中如果抛出问题，不会自动对局部变量释放（开启 &lt;code&gt;-fobjc-arc-expections&lt;/code&gt; 模式会进行释放，但是引入代码对性能有所影响）&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;开发过过程中我们经常会遇到异常问题&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/1877765-ebec37c09e21ba91.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;iOS异常.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;iOS-开发过程中的错误处理&quot;&gt;&lt;a href=&quot;#iOS-开发过程中的错误处理&quot; class=&quot;headerlink&quot; title=&quot;iOS-开发过程中的错误处理&quot;&gt;&lt;/a&gt;iOS-开发过程中的错误处理&lt;/h1&gt;
    
    </summary>
    
      <category term="iOS" scheme="http://yoursite.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
  </entry>
  
</feed>
